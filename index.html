<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <!-- Tailwind CSS a stílusokhoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Világoskék háttér */
        }
        .container-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(52, 152, 235, 0.3), 0 2px 4px -1px rgba(52, 152, 235, 0.1);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 10px -1px rgba(52, 152, 235, 0.4);
        }
        /* Custom scrollbar for better look */
        #data-list::-webkit-scrollbar,
        #managed-categories-list::-webkit-scrollbar {
            width: 8px;
        }
        #data-list::-webkit-scrollbar-thumb,
        #managed-categories-list::-webkit-scrollbar-thumb {
            background-color: #9bd6ff;
            border-radius: 4px;
        }
        #data-list::-webkit-scrollbar-track,
        #managed-categories-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Betöltő Képernyő (Loading Overlay) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center transition-opacity duration-500 z-50">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-700">Adatok betöltése...</p>
    </div>

    <!-- Fő Tartalom (Alapból rejtett) -->
    <div id="main-content" class="p-4 md:p-8 max-w-4xl mx-auto" style="display: none;">
        
        <!-- Fejléc és statisztika -->
        <header class="bg-white p-6 rounded-xl container-shadow mb-6">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">Rezsi Nyilvántartó</h1>
            <p class="text-sm text-gray-500 mb-4">Felhasználói azonosító: <span id="user-id-display" class="font-mono text-xs bg-gray-100 p-1 rounded">...</span></p>

            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <div class="flex-grow">
                    <label for="month-selector" class="block text-sm font-medium text-gray-700 mb-1">Hónap kiválasztása:</label>
                    <input type="month" id="month-selector" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                </div>
                <div class="text-right">
                    <p class="text-lg text-gray-600">Összes kiadás:</p>
                    <p id="total-expense" class="text-3xl font-extrabold text-red-500">0 Ft</p>
                </div>
            </div>
        </header>

        <!-- Kategória/Lista nézet -->
        <section class="bg-white p-6 rounded-xl container-shadow mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Havi tételek</h2>
            
            <div id="data-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Tételek listája ide kerül renderelésre -->
                <p id="empty-state" class="text-gray-500 text-center py-8 hidden">Nincs még tétel ehhez a hónaphoz.</p>
            </div>
        </section>

        <!-- Akció gombok -->
        <div class="fixed bottom-4 right-4 md:bottom-8 md:right-8 flex flex-col space-y-3">
            <button id="open-managed-categories-btn" title="Rendszeres tételek kezelése" class="w-14 h-14 rounded-full bg-yellow-500 text-white flex items-center justify-center shadow-lg hover:bg-yellow-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <button id="open-add-modal-btn" title="Új tétel hozzáadása" class="w-16 h-16 rounded-full bg-blue-500 text-white text-3xl font-extrabold flex items-center justify-center shadow-2xl btn-primary">
                +
            </button>
        </div>
    </div>

    <!-- 1. Új tétel/szerkesztő Modál -->
    <div id="add-edit-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">Új kiadás hozzáadása</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                
                <div class="mb-4">
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Megnevezés/Kategória</label>
                    <input type="text" id="item-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Pl: Villany, Gáz, Közös költség">
                </div>

                <div class="mb-4">
                    <label for="item-amount" class="block text-sm font-medium text-gray-700">Összeg (Ft)</label>
                    <input type="number" id="item-amount" required min="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Pl: 12500">
                </div>

                <div class="mb-4">
                    <label for="item-due-date" class="block text-sm font-medium text-gray-700">Fizetési határidő/dátum</label>
                    <input type="date" id="item-due-date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-6">
                    <div class="flex items-center">
                        <input id="item-is-paid" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="item-is-paid" class="ml-2 block text-sm text-gray-900">Kifizetve</label>
                    </div>
                </div>

                <div class="flex justify-between space-x-4">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégse</button>
                    <button type="submit" id="save-item-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Rendszeres Kategória Szerkesztő/Hozzáadó Modál -->
    <div id="managed-category-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="managed-modal-title" class="text-2xl font-bold text-gray-800 mb-4">Rendszeres tétel hozzáadása</h2>
            <form id="managed-category-form">
                <input type="hidden" id="managed-category-id">

                <div class="mb-4">
                    <label for="managed-category-name" class="block text-sm font-medium text-gray-700">Megnevezés</label>
                    <input type="text" id="managed-category-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Pl: Albérlet, Internet">
                </div>

                <div class="mb-4">
                    <label for="managed-category-amount" class="block text-sm font-medium text-gray-700">Állandó összeg (Ft, 0 ha változó)</label>
                    <input type="number" id="managed-category-amount" required min="0" value="0" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-6">
                    <label for="managed-category-day" class="block text-sm font-medium text-gray-700">Fizetési nap (1-28)</label>
                    <input type="number" id="managed-category-day" required min="1" max="28" value="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Ez a nap lesz beállítva határidőnek, ha generálódik a tétel.</p>
                </div>

                <div class="flex justify-between space-x-4">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégse</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Rendszeres Kategória Lista Modál -->
    <div id="managed-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Rendszeres tételek kezelése</h2>
            <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
            <button type="button" onclick="openManagedCategoryModal()" class="mb-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150">
                + Új rendszeres tétel
            </button>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kategória lista ide kerül renderelésre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- 4. Megerősítő Modál -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
            <p id="confirm-modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégse</button>
                <button id="execute-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Törlés megerősítése</button>
            </div>
        </div>
    </div>


    <!-- Firebase, Utility és App logika -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase konfiguráció és Canvas környezeti változók
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;
        let unsubscribeItems = null;
        let unsubscribeCategories = null;
        let currentMonth = getCurrentMonthString();
        let items = [];
        let managedCategories = [];
        
        // Elem hivatkozások
        const dataList = document.getElementById('data-list');
        const totalExpense = document.getElementById('total-expense');
        const monthSelector = document.getElementById('month-selector');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const emptyState = document.getElementById('empty-state');

        // Modál elemek
        const addEditModal = document.getElementById('add-edit-modal');
        const itemForm = document.getElementById('item-form');
        const itemIdInput = document.getElementById('item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemAmountInput = document.getElementById('item-amount');
        const itemDueDateInput = document.getElementById('item-due-date');
        const itemIsPaidInput = document.getElementById('item-is-paid');
        const modalTitle = document.getElementById('modal-title');
        const saveItemBtn = document.getElementById('save-item-btn');

        const managedCategoriesModal = document.getElementById('managed-categories-modal');
        const managedCategoriesList = document.getElementById('managed-categories-list');
        const managedCategoryModal = document.getElementById('managed-category-modal');
        const managedCategoryForm = document.getElementById('managed-category-form');
        const managedCategoryIdInput = document.getElementById('managed-category-id');
        const managedCategoryNameInput = document.getElementById('managed-category-name');
        const managedCategoryAmountInput = document.getElementById('managed-category-amount');
        const managedCategoryDayInput = document.getElementById('managed-category-day');
        const managedModalTitle = document.getElementById('managed-modal-title');

        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalBody = document.getElementById('confirm-modal-body');
        const executeDeleteBtn = document.getElementById('execute-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');


        // --- UTILITY FUNKCIÓK ---

        // Dátum formázása YYYY-MM-DD-re
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        // Aktuális hónap YYYY-MM formátumban
        function getCurrentMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        // Pénzösszeg formázása
        function formatCurrency(amount) {
            return new Intl.NumberFormat('hu-HU', { style: 'currency', currency: 'HUF', maximumFractionDigits: 0 }).format(amount);
        }

        // Modálok elrejtése
        function hideAllModals() {
            addEditModal.classList.add('hidden');
            managedCategoriesModal.classList.add('hidden');
            managedCategoryModal.classList.add('hidden');
            confirmationModal.classList.add('hidden');
        }

        // --- FIRESTORE ÉS AUTENTIKÁCIÓ ---

        function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Csak hibákat logolunk
                console.log("Firebase inicializálva.");
            } catch (error) {
                console.error("Firebase inicializálási hiba:", error);
            }
        }

        async function initAuth() {
            initFirebase();
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Sikeres bejelentkezés custom token-nel.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Sikeres anonim bejelentkezés.");
                }
            } catch (error) {
                console.error("Autentikációs hiba:", error);
                // Ha az autentikáció meghiúsul, anonim módot próbálunk, hátha az engedélyezett
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonim bejelentkezés is sikertelen:", anonError);
                }
            }
        }

        // Firestore elérési utak
        function getItemCollectionRef() {
            if (!currentUserId) return null;
            return collection(db, `artifacts/${appId}/users/${currentUserId}/items`);
        }
        function getManagedCategoryCollectionRef() {
            if (!currentUserId) return null;
            return collection(db, `artifacts/${appId}/users/${currentUserId}/managed_categories`);
        }


        // Firestore listenerek
        function listenForData() {
            if (!currentUserId) return;

            // 1. Tétellista listenere (items)
            if (unsubscribeItems) {
                unsubscribeItems();
            }
            
            // Lekérdezés a jelenleg kiválasztott hónapra (YYYY-MM-vel kezdődik)
            const startOfMonth = currentMonth;
            const endOfMonth = currentMonth.slice(0, 4) + '-' + (parseInt(currentMonth.slice(5, 7)) < 12 ? String(parseInt(currentMonth.slice(5, 7)) + 1).padStart(2, '0') : '13'); 
            
            const itemsQuery = query(
                getItemCollectionRef(),
                where('month', '==', currentMonth) // Az új 'month' mező alapján
            );

            unsubscribeItems = onSnapshot(itemsQuery, (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems();
                calculateTotal();
            }, (error) => {
                console.error("Hiba a tételek lekérdezésekor: ", error);
            });

            // 2. Rendszeres Kategóriák listenere (managed_categories)
            if (unsubscribeCategories) {
                unsubscribeCategories();
            }

            const categoriesQuery = query(getManagedCategoryCollectionRef());

            unsubscribeCategories = onSnapshot(categoriesQuery, (snapshot) => {
                managedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderManagedCategories();
            }, (error) => {
                console.error("Hiba a kategóriák lekérdezésekor: ", error);
            });
        }

        // --- ADATKEZELÉS ---

        async function saveItem(e) {
            e.preventDefault();
            hideAllModals();

            const name = itemNameInput.value.trim();
            const amount = parseInt(itemAmountInput.value);
            const dueDate = itemDueDateInput.value;
            const isPaid = itemIsPaidInput.checked;
            const itemId = itemIdInput.value;

            if (name === "" || isNaN(amount) || amount < 0 || dueDate === "") {
                console.error("Hibás beviteli adatok.");
                return;
            }

            const itemData = {
                name,
                amount,
                dueDate,
                isPaid,
                createdAt: serverTimestamp(),
                month: dueDate.slice(0, 7) // YYYY-MM formátum
            };

            try {
                if (itemId) {
                    // Szerkesztés
                    const itemRef = doc(getItemCollectionRef(), itemId);
                    await updateDoc(itemRef, itemData);
                    console.log("Tétel sikeresen frissítve:", itemId);
                } else {
                    // Hozzáadás
                    await addDoc(getItemCollectionRef(), itemData);
                    console.log("Tétel sikeresen hozzáadva.");
                }
            } catch (e) {
                console.error("Hiba a tétel mentésekor: ", e);
            }
        }

        async function saveManagedCategory(e) {
            e.preventDefault();
            hideAllModals();

            const name = managedCategoryNameInput.value.trim();
            const amount = parseInt(managedCategoryAmountInput.value);
            const day = parseInt(managedCategoryDayInput.value);
            const categoryId = managedCategoryIdInput.value;

            if (name === "" || isNaN(amount) || amount < 0 || isNaN(day) || day < 1 || day > 28) {
                console.error("Hibás beviteli adatok a kategóriához.");
                return;
            }

            const categoryData = {
                name,
                defaultAmount: amount,
                defaultDay: day,
                createdAt: serverTimestamp(),
            };

            try {
                if (categoryId) {
                    // Szerkesztés
                    const categoryRef = doc(getManagedCategoryCollectionRef(), categoryId);
                    await updateDoc(categoryRef, categoryData);
                    console.log("Kategória sikeresen frissítve:", categoryId);
                } else {
                    // Hozzáadás
                    await addDoc(getManagedCategoryCollectionRef(), categoryData);
                    console.log("Kategória sikeresen hozzáadva.");
                }
            } catch (e) {
                console.error("Hiba a kategória mentésekor: ", e);
            }
        }
        
        // Tétel kifizetett állapotának váltása
        async function toggleItemPaid(id, isPaid) {
            const itemRef = doc(getItemCollectionRef(), id);
            try {
                await updateDoc(itemRef, { isPaid: !isPaid });
                console.log("Státusz váltva:", id);
            } catch (e) {
                console.error("Hiba a státusz frissítésekor: ", e);
            }
        }

        // Törlés megerősítő
        function openConfirmationModal(title, body, deleteFunction) {
            confirmModalTitle.textContent = title;
            confirmModalBody.textContent = body;
            executeDeleteBtn.onclick = async () => {
                await deleteFunction();
                hideAllModals();
            };
            cancelDeleteBtn.onclick = hideAllModals;
            confirmationModal.classList.remove('hidden');
        }

        // Tétel törlése
        function deleteItem(id, name) {
            openConfirmationModal(
                "Tétel törlése",
                `Biztosan törölni szeretné a(z) "${name}" nevű kiadást? Ez nem vonható vissza.`,
                async () => {
                    const itemRef = doc(getItemCollectionRef(), id);
                    try {
                        await deleteDoc(itemRef);
                        console.log("Tétel sikeresen törölve:", id);
                    } catch (e) {
                        console.error("Hiba a tétel törlésekor: ", e);
                    }
                }
            );
        }

        // Rendszeres kategória törlése
        function deleteManagedCategory(id, name) {
            openConfirmationModal(
                "Rendszeres tétel törlése",
                `Biztosan törölni szeretné a(z) "${name}" nevű rendszeres tételt? Ez nem törli a már generált havi tételeket!`,
                async () => {
                    const categoryRef = doc(getManagedCategoryCollectionRef(), id);
                    try {
                        await deleteDoc(categoryRef);
                        console.log("Rendszeres tétel sikeresen törölve:", id);
                    } catch (e) {
                        console.error("Hiba a rendszeres tétel törlésekor: ", e);
                    }
                }
            );
        }

        // --- RENDERELÉS ÉS KIJELZŐ LOGIKA ---

        // Tétel szerkesztő modál megnyitása
        function openEditModal(item) {
            modalTitle.textContent = "Kiadás szerkesztése";
            saveItemBtn.textContent = "Frissítés";
            itemIdInput.value = item.id;
            itemNameInput.value = item.name;
            itemAmountInput.value = item.amount;
            itemDueDateInput.value = item.dueDate;
            itemIsPaidInput.checked = item.isPaid;
            addEditModal.classList.remove('hidden');
        }

        // Új tétel modál megnyitása
        function openAddModal() {
            modalTitle.textContent = "Új kiadás hozzáadása";
            saveItemBtn.textContent = "Mentés";
            itemForm.reset();
            itemIdInput.value = "";
            itemDueDateInput.value = currentMonth + '-01'; // Alapértelmezett dátum a hónap első napja
            itemIsPaidInput.checked = false;
            addEditModal.classList.remove('hidden');
        }

        // Rendszeres kategória szerkesztő modál megnyitása
        function openManagedCategoryModal(category = null) {
            hideAllModals();
            if (category) {
                managedModalTitle.textContent = "Rendszeres tétel szerkesztése";
                managedCategoryIdInput.value = category.id;
                managedCategoryNameInput.value = category.name;
                managedCategoryAmountInput.value = category.defaultAmount;
                managedCategoryDayInput.value = category.defaultDay;
            } else {
                managedModalTitle.textContent = "Rendszeres tétel hozzáadása";
                managedCategoryForm.reset();
                managedCategoryIdInput.value = "";
                managedCategoryAmountInput.value = 0;
                managedCategoryDayInput.value = 1;
            }
            managedCategoryModal.classList.remove('hidden');
        }

        // Tételek listájának renderelése
        function renderItems() {
            dataList.innerHTML = '';
            
            if (items.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            // Rendezés: nem fizetett előre, dátum szerint
            const sortedItems = items.sort((a, b) => {
                if (a.isPaid !== b.isPaid) {
                    return a.isPaid ? 1 : -1; // Nem fizetettek elöl
                }
                return new Date(a.dueDate) - new Date(b.dueDate); // Dátum szerint növekvő
            });

            sortedItems.forEach(item => {
                const isLate = !item.isPaid && new Date(item.dueDate) < new Date(getCurrentMonthString() + '-01'); // Figyelem! A dátum YYYY-MM-DD kell legyen
                const dueDateDisplay = new Date(item.dueDate).toLocaleDateString('hu-HU', { month: 'short', day: 'numeric' });

                const itemHtml = `
                    <div class="flex items-center p-4 rounded-xl transition-all duration-200 ${item.isPaid ? 'bg-green-50 shadow-sm border-l-4 border-green-400' : (isLate ? 'bg-red-100 shadow-md border-l-4 border-red-500' : 'bg-white shadow-md border-l-4 border-blue-400')}">
                        
                        <!-- Státusz/Kifizetve checkbox -->
                        <div class="flex-shrink-0 mr-4">
                            <input type="checkbox" ${item.isPaid ? 'checked' : ''} data-item-id="${item.id}" data-item-paid="${item.isPaid}"
                                class="h-5 w-5 ${item.isPaid ? 'text-green-600' : 'text-blue-600'} border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                onclick="event.stopPropagation(); toggleItemPaid('${item.id}', ${item.isPaid})">
                        </div>

                        <!-- Tétel adatai -->
                        <div class="flex-grow min-w-0">
                            <p class="text-lg font-semibold truncate ${item.isPaid ? 'text-gray-500 line-through' : 'text-gray-800'}">${item.name}</p>
                            <p class="text-sm text-gray-500">
                                Határidő: <span class="font-medium ${isLate && !item.isPaid ? 'text-red-600 font-bold' : 'text-gray-600'}">${dueDateDisplay}</span>
                                ${isLate && !item.isPaid ? ' (Lejárt!)' : ''}
                            </p>
                        </div>

                        <!-- Összeg és gombok -->
                        <div class="flex-shrink-0 flex items-center space-x-2 ml-4">
                            <p class="text-xl font-extrabold ${item.isPaid ? 'text-green-600' : 'text-red-500'}">
                                ${formatCurrency(item.amount)}
                            </p>

                            <!-- Szerkesztés gomb -->
                            <button onclick="openEditModal(${JSON.stringify(item).replace(/"/g, '&quot;')})" title="Szerkesztés" 
                                class="p-1 text-blue-500 rounded-full hover:bg-blue-100 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-1.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM17.5 7.5l-5 5M18.5 4.5l2 2-5 5-2-2 5-5z" />
                                </svg>
                            </button>

                            <!-- Törlés gomb -->
                            <button onclick="deleteItem('${item.id}', '${item.name}')" title="Törlés" 
                                class="p-1 text-red-500 rounded-full hover:bg-red-100 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                dataList.insertAdjacentHTML('beforeend', itemHtml);
            });
            // Globális függvények elérhetővé tétele a HTML onclick eseményekhez
            window.openEditModal = openEditModal;
            window.toggleItemPaid = toggleItemPaid;
            window.deleteItem = deleteItem;
        }

        // Összes kiadás kiszámítása és kijelzése
        function calculateTotal() {
            const total = items.reduce((sum, item) => sum + item.amount, 0);
            totalExpense.textContent = formatCurrency(total);
        }

        // Rendszeres Kategóriák listájának renderelése
        function renderManagedCategories() {
            managedCategoriesList.innerHTML = '';
            
            if (managedCategories.length === 0) {
                managedCategoriesList.innerHTML = '<p class="text-gray-500 text-center py-4">Nincs még rendszeres tétel beállítva.</p>';
                return;
            }

            managedCategories.forEach(category => {
                const amountText = category.defaultAmount > 0 ? formatCurrency(category.defaultAmount) : 'Változó';
                
                const categoryHtml = `
                    <div class="flex items-center p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <div class="flex-grow min-w-0">
                            <p class="text-base font-semibold text-gray-800 truncate">${category.name}</p>
                            <p class="text-sm text-gray-600">Összeg: ${amountText} | Határidő napja: ${category.defaultDay}.</p>
                        </div>

                        <div class="flex-shrink-0 flex items-center space-x-2 ml-4">
                            <!-- Szerkesztés gomb -->
                            <button onclick="openManagedCategoryModal(${JSON.stringify(category).replace(/"/g, '&quot;')})" title="Szerkesztés" 
                                class="p-1 text-blue-500 rounded-full hover:bg-blue-100 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-1.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM17.5 7.5l-5 5M18.5 4.5l2 2-5 5-2-2 5-5z" />
                                </svg>
                            </button>

                            <!-- Törlés gomb -->
                            <button onclick="deleteManagedCategory('${category.id}', '${category.name}')" title="Törlés" 
                                class="p-1 text-red-500 rounded-full hover:bg-red-100 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                managedCategoriesList.insertAdjacentHTML('beforeend', categoryHtml);
            });
            // Globális függvények elérhetővé tétele
            window.openManagedCategoryModal = openManagedCategoryModal;
            window.deleteManagedCategory = deleteManagedCategory;
        }

        // --- HAVI GENERÁLÁS LOGIKA ---

        // Ellenőrzi, hogy a bejelölt hónaphoz generáltunk-e már tételeket
        async function checkMonthGenerationStatus(month) {
            const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/generation_status/${month}`);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() && docSnap.data().generated;
        }

        // Beállítja a hónap generálási státuszát
        async function setMonthGenerationStatus(month) {
             const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/generation_status/${month}`);
             await setDoc(docRef, { generated: true, timestamp: serverTimestamp() }, { merge: true });
        }
        
        // Rendszeres tételek generálása a kiválasztott hónapra
        async function handleNewMonthGeneration() {
            if (!currentUserId) return;

            const targetMonth = currentMonth;
            const alreadyGenerated = await checkMonthGenerationStatus(targetMonth);

            if (alreadyGenerated) {
                console.log(`A(z) ${targetMonth} hónaphoz a tételek már korábban generálva lettek.`);
                return;
            }

            if (managedCategories.length === 0) {
                console.log("Nincs beállítva rendszeres tétel, nem történik generálás.");
                return;
            }

            console.log(`Tételek generálása a(z) ${targetMonth} hónapra...`);
            const batch = writeBatch(db);
            const itemsRef = getItemCollectionRef();

            managedCategories.forEach(category => {
                // YYYY-MM-DD dátum létrehozása a kategória napjával
                const dueDate = `${targetMonth}-${String(category.defaultDay).padStart(2, '0')}`;
                
                const newItem = {
                    name: category.name,
                    amount: category.defaultAmount,
                    dueDate: dueDate,
                    isPaid: false, // Az újonnan generált tétel mindig ki nem fizetett
                    createdAt: serverTimestamp(),
                    month: targetMonth,
                    isGenerated: true, // Megjelöljük, hogy generált tétel
                };

                // A Batch-hez hozzáadjuk az új tétel hozzáadását
                const newDocRef = doc(itemsRef);
                batch.set(newDocRef, newItem);
            });

            try {
                // A Batch végrehajtása
                await batch.commit();
                
                // Generálási státusz beállítása sikeres generálás után
                await setMonthGenerationStatus(targetMonth);

                console.log(`${managedCategories.length} db rendszeres tétel sikeresen generálva a(z) ${targetMonth} hónapra.`);
            } catch (e) {
                console.error("Hiba a havi generáláskor: ", e);
            }
        }


        // --- ESEMÉNYKEZELŐK ÉS INDÍTÁS ---

        // Kezdőérték beállítása a hónapválasztóhoz
        monthSelector.value = currentMonth;

        monthSelector.addEventListener('change', () => {
            currentMonth = monthSelector.value;
            // Új hónap kiválasztásakor újraindítjuk a listenert
            listenForData();
            // Ellenőrizzük és generáljuk az új havi tételeket (ha kell)
            handleNewMonthGeneration();
        });

        // Azonnali esemény a felhasználó állapotának figyelésére
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                
                // Betöltő képernyő eltüntetése
                loadingOverlay.classList.add('opacity-0');
                loadingOverlay.addEventListener('transitionend', () => {
                    loadingOverlay.style.display = 'none';
                    mainContent.style.display = 'block';
                }, { once: true });
                
                // Adatok figyelésének elindítása
                listenForData();
                
                // Rendszeres tételek ellenőrzése és generálása (meg kell várni, hogy a managedCategories bejöjjön a listenForData-ból)
                // Hozzáadunk egy rövid késleltetést, amíg a kategóriák betöltődnek, bár az onSnapshot aszinkron.
                // A legjobb megoldás, ha a handleNewMonthGeneration hívás előtt megvárjuk a managedCategories betöltését, 
                // de egyszerűség kedvéért egy rövid timeout-ot használunk itt.
                setTimeout(handleNewMonthGeneration, 500); 

            } else {
                // Anonim bejelentkezés esetén is lesz felhasználó (user.uid), ez a blokk elvileg nem fut le.
                console.log("Nincs bejelentkezett felhasználó. Vissza anonim módba.");
            }
        });

        // Eseménykezelők
        document.getElementById('open-add-modal-btn').addEventListener('click', openAddModal);
        document.getElementById('open-managed-categories-btn').addEventListener('click', () => {
            managedCategoriesModal.classList.remove('hidden');
            renderManagedCategories(); // Frissítjük a listát minden megnyitáskor
        });
        document.getElementById('item-form').addEventListener('submit', saveItem);
        document.getElementById('managed-category-form').addEventListener('submit', saveManagedCategory);
        window.hideAllModals = hideAllModals; // Globálissá tesszük a HTML-ből való hívhatóság érdekében

        // Első lépés: Autentikáció indítása
        initAuth();

    </script>
    
</body>
</html>
