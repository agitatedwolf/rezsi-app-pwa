<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Havi Költségkövető</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ======================================= */
        /* CSS STÍLUSOK (Tailwind + Egyedi)        */
        /* ======================================= */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: border-color 0.15s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #4c51bf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.1);
        }
        .btn-primary {
            background-color: #4c51bf;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            position: relative;
        }
        .btn-primary:hover {
            background-color: #3b42a8;
        }
        .btn-primary:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .btn-danger {
            background-color: #dc2626;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        /* Style for the confirmation modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        /* Loading Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Havi Költségkövető</h1>
            <p class="text-xs text-gray-400">UID: <span id="user-id-display">Betöltés...</span></p>
        </header>

        <!-- Költség Rögzítése Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Költség Rögzítése</h2>
            <form id="consumption-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="input-group">
                    <label for="utility-type">Költség Típusa</label>
                    <select id="utility-type" name="utility-type">
                        <!-- Közüzemi fogyasztás alapú -->
                        <option value="electric">Villany (kWh, stb.)</option>
                        <option value="gas">Gáz (m³, MJ, stb.)</option>
                        <option value="water">Víz (m³)</option>
                        <!-- Fix költségek (Új típusok) -->
                        <option value="insurance_home">Lakás biztosítás</option>
                        <option value="insurance_car">Gépjármű biztosítás</option>
                        <option value="subscription_mobile">Mobil előfizetés</option>
                        <option value="subscription_home">Otthoni előfizetés (TV/Internet)</option>
                    </select>
                </div>
                <!-- Egységár/Összeg mező -->
                <div class="input-group">
                    <label for="price-per-unit" id="price-per-unit-label">Egységár (HUF)</label>
                    <input type="number" id="price-per-unit" name="price-per-unit" placeholder="Pl. 36.5" step="0.01" required>
                </div>
                <!-- Fogyasztás/Fix összeg -->
                <div class="input-group">
                    <label for="consumption-amount" id="consumption-amount-label">Fogyasztás (egység)</label>
                    <input type="number" id="consumption-amount" name="consumption-amount" placeholder="Pl. 150" step="0.1" required>
                </div>
                
                <div class="input-group md:col-span-3">
                    <label for="consumption-date">Dátum</label>
                    <input type="date" id="consumption-date" name="consumption-date" required>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" id="save-consumption-btn" class="btn-primary w-full flex justify-center items-center">
                        <span id="save-text">Költség Mentése</span>
                        <div id="save-spinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
            </form>
            <div id="consumption-message-box" class="message-box hidden mt-4"></div>
        </div>

        <!-- Kimutatások Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Kimutatások</h2>
            
            <!-- Havi Összehasonlítás -->
            <h3 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Havi Összefoglaló</h3>
            <div id="monthly-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- Kimutatás kártyák ide kerülnek -->
            </div>

            <div class="mt-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Költség Előzmények</h3>
                <!-- Ezt a listát használjuk a tételek törlésére -->
                <ul id="consumption-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- A lista elem ide kerül -->
                </ul>
            </div>
        </div>

        <!-- ÚJ: Adatkezelés Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Adatkezelés és Mentés</h2>
            <div class="space-y-4">
                <button id="export-data-btn" class="btn-primary w-full flex justify-center items-center">
                    Adatok Exportálása (JSON Mentés)
                </button>
                
                <!-- Import: Fájlválasztó elrejtve, csak a gomb látszik -->
                <div class="relative">
                    <input type="file" id="import-file-input" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <button id="import-data-btn" type="button" class="btn-primary w-full">
                        Adatok Importálása (JSON Betöltés)
                    </button>
                </div>

                <button id="clear-data-prompt-btn" class="btn-danger w-full mt-4">
                    Teljes Adatbázis Törlése
                </button>
            </div>
            <div id="data-management-message-box" class="message-box hidden mt-4"></div>
        </div>
    </div>

    <!-- Törlést megerősítő Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Megerősítés</h3>
            <p id="modal-message" class="mb-6 text-gray-600">Biztosan törölni szeretné ezt a költség bejegyzést?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition">Mégse</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">Törlés</button>
            </div>
        </div>
    </div>

    <!-- Teljes adatbázis törlését megerősítő Modal (új célra) -->
    <div id="clear-db-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4">Figyelem! Adatbázis Törlés</h3>
            <p class="mb-6 text-gray-600">Biztosan törölni szeretné **az összes** rögzített költségtételt az adatbázisból? Ez a művelet nem visszavonható!</p>
            <div class="flex justify-center space-x-4">
                <button id="clear-db-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition">Mégse</button>
                <button id="clear-db-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">Igen, mindent törölni!</button>
            </div>
        </div>
    </div>

    <script type="module">
        // =========================================================================
        // FIREBASE IMPORTÁLÁS ÉS ALAP BEÁLLÍTÁSOK
        // =========================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, setLogLevel, deleteDoc, getDocs, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Firestore Timestamp használatához

        // APP KONFIGURÁCIÓ
        const CONFIG = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', // Canvas változó használata
            firebaseConfig: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                apiKey: "AIzaSyAkXnuZDqZVnag2G1pTB4mWwKwrjeEinOQ", 
                authDomain: "rezsi-nyilvantarto.firebaseapp.com",
                projectId: "rezsi-nyilvantarto",
                storageBucket: "rezsi-nyilvantarto.firebasestorage.app",
                messagingSenderId: "917315288002",
                appId: "1:917315288002:web:8633213d831cbd6fe3f45b"
            },
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
            FIXED_COST_TYPES: ['insurance_home', 'insurance_car', 'subscription_mobile', 'subscription_home'],
            typeDisplayNames: { 
                electric: 'Villany', gas: 'Gáz', water: 'Víz',
                insurance_home: 'Lakásbiztosítás', insurance_car: 'Gépjárműbiztosítás',
                subscription_mobile: 'Mobil előfizetés', subscription_home: 'Otthoni előfizetés'
            },
            defaultSettings: {
                currency: 'HUF', baseCost: 0, 
                lastPrices: {
                    electric: 40.0, gas: 120.0, water: 350.0,
                    insurance_home: 10000.0, insurance_car: 15000.0,
                    subscription_mobile: 5000.0, subscription_home: 8000.0
                }
            }
        };

        // GLOBÁLIS ÁLLAPOT
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentSettings = { ...CONFIG.defaultSettings };
        let consumptionData = [];


        // =========================================================================
        // FIREBASE ÉS AUTH KEZELÉS
        // =========================================================================

        /** Inicializálja a Firebase-t és beállítja az Auth figyelőt. */
        const initFirebase = () => {
            setLogLevel('debug');
            try {
                app = initializeApp(CONFIG.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                 console.error("Firebase inicializálási hiba:", e);
                 document.getElementById('user-id-display').textContent = 'Hiba';
                 return;
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    isAuthReady = true;
                    await dataService.loadData();
                } else {
                    try {
                        if (CONFIG.initialAuthToken) {
                            await signInWithCustomToken(auth, CONFIG.initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase hitelesítési hiba:", error);
                        document.getElementById('user-id-display').textContent = 'Anonim (Hiba)';
                    }
                }
            });
        };

        /** Firestore segéd metódusok a referenciákhoz és adatokhoz. */
        const dataService = {
            getSettingsDocRef: () => doc(db, 'artifacts', CONFIG.appId, 'users', userId, 'settings', 'general'),
            getConsumptionCollectionRef: () => collection(db, 'artifacts', CONFIG.appId, 'users', userId, 'consumptions'),
            getConsumptionDocRef: (docId) => doc(db, 'artifacts', CONFIG.appId, 'users', userId, 'consumptions', docId),

            /** Betölti az adatokat és beállítja a valós idejű figyelőket (onSnapshot). */
            loadData: async () => {
                if (!isAuthReady || !userId) return;

                // 1. Beállítások figyelése (Utolsó árak/összegek miatt)
                onSnapshot(dataService.getSettingsDocRef(), (docSnap) => {
                    let loadedSettings = docSnap.exists() ? docSnap.data() : {};
                    currentSettings.lastPrices = { 
                        ...CONFIG.defaultSettings.lastPrices, 
                        ...(loadedSettings.lastPrices || {}) 
                    };
                    uiManager.updateFormUI(document.getElementById('utility-type').value);
                    uiManager.updateSummary();
                }, (error) => {
                    console.error("Hiba a beállítások figyelésekor:", error);
                });

                // 2. Költségek figyelése
                onSnapshot(dataService.getConsumptionCollectionRef(), (snapshot) => {
                    consumptionData = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        consumptionData.push({
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : new Date(data.date),
                            amount: Number(data.amount) || 0,
                            price: Number(data.price) || 0
                        });
                    });
                    consumptionData.sort((a, b) => b.date - a.date);
                    uiManager.updateSummary();
                    uiManager.renderConsumptionList();
                }, (error) => {
                    console.error("Hiba a költségek figyelésekor:", error);
                    uiManager.showMessage('consumption-message-box', `Hiba a költségi adatok betöltésekor. ${error.message}`, true);
                });
            },

            /** Költség tétel törlése a Firestore-ból. */
            deleteConsumption: async (docId) => {
                if (!isAuthReady || !userId) {
                    uiManager.showMessage('consumption-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                    return;
                }
                try {
                    await deleteDoc(dataService.getConsumptionDocRef(docId));
                    uiManager.showMessage('consumption-message-box', 'Költség tétel sikeresen törölve.');
                } catch (error) {
                    console.error("Hiba a törléskor:", error);
                    uiManager.showMessage('consumption-message-box', `Hiba a törléskor: ${error.message}`, true);
                }
            },

            // ÚJ: Adatok exportálása JSON formátumban
            exportData: async () => {
                if (!isAuthReady || !userId) {
                    uiManager.showMessage('data-management-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                    return;
                }
                try {
                    const snapshot = await getDocs(dataService.getConsumptionCollectionRef());
                    const exportArray = [];

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Dátum konvertálása ISO stringgé a mentéshez
                        const dateString = data.date && data.date.toDate ? data.date.toDate().toISOString() : null;
                        
                        exportArray.push({
                            type: data.type,
                            amount: data.amount,
                            price: data.price,
                            date: dateString,
                            comment: data.comment || '',
                        });
                    });

                    const jsonString = JSON.stringify(exportArray, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `koltsegkoveto_export_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    uiManager.showMessage('data-management-message-box', 'Adatok sikeresen exportálva!');

                } catch (error) {
                    console.error("Hiba az exportáláskor:", error);
                    uiManager.showMessage('data-management-message-box', `Hiba az exportáláskor: ${error.message}`, true);
                }
            },

            // ÚJ: Adatok importálása JSON tömbből a Firestore-ba
            importData: async (dataArray) => {
                if (!isAuthReady || !userId) {
                    uiManager.showMessage('data-management-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                    return;
                }
                if (!Array.isArray(dataArray) || dataArray.length === 0) {
                    uiManager.showMessage('data-management-message-box', 'Hiba: Az importált fájl érvénytelen vagy üres.', true);
                    return;
                }

                try {
                    // Egy kötegelt írás a hatékonyságért, de a Firestore-ban a köteg max 500 művelet lehet.
                    const batch = writeBatch(db);
                    const collectionRef = dataService.getConsumptionCollectionRef();
                    let importedCount = 0;

                    for (const item of dataArray) {
                        // Alapvető validáció
                        if (item.type && item.price !== undefined && item.amount !== undefined && item.date) {
                            // Dátum konvertálása ISO stringből Firestore Timestamp-re
                            const dateObject = new Date(item.date);
                            const firestoreTimestamp = Timestamp.fromDate(dateObject);
                            
                            const newItem = {
                                type: item.type,
                                amount: Number(item.amount),
                                price: Number(item.price),
                                date: firestoreTimestamp,
                                comment: item.comment || '',
                                createdAt: serverTimestamp() // Hozzáadás dátuma (friss)
                            };
                            
                            // Új dokumentum hozzáadása a köteghez
                            const newDocRef = doc(collectionRef);
                            batch.set(newDocRef, newItem);
                            importedCount++;

                            // A Firestore batch limit (500) kezelése
                            if (importedCount % 499 === 0) {
                                await batch.commit();
                                console.log(`Batch commit (499) sikeres. Eddigi összes: ${importedCount}`);
                                batch = writeBatch(db); // Új köteg indítása
                            }
                        }
                    }

                    // A fennmaradó elemek commitálása
                    if (importedCount % 499 !== 0) {
                         await batch.commit();
                    }

                    uiManager.showMessage('data-management-message-box', `${importedCount} tétel sikeresen importálva!`, false);
                } catch (error) {
                    console.error("Hiba az importáláskor:", error);
                    uiManager.showMessage('data-management-message-box', `Hiba az importáláskor: ${error.message}`, true);
                }
            },

            // ÚJ: Teljes adatbázis törlése (minden költségtétel)
            clearAllConsumptions: async () => {
                 if (!isAuthReady || !userId) {
                    uiManager.showMessage('data-management-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                    return;
                }
                try {
                    const snapshot = await getDocs(dataService.getConsumptionCollectionRef());
                    const batch = writeBatch(db);
                    let deletedCount = 0;

                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        deletedCount++;

                        if (deletedCount % 499 === 0) {
                            batch.commit();
                            batch = writeBatch(db);
                        }
                    });

                    // Utolsó commit
                    if (deletedCount > 0) {
                        await batch.commit();
                    }

                    uiManager.showMessage('data-management-message-box', `${deletedCount} tétel sikeresen törölve! Az adatbázis üres.`, false);
                } catch (error) {
                    console.error("Hiba a törléskor:", error);
                    uiManager.showMessage('data-management-message-box', `Hiba a teljes törléskor: ${error.message}`, true);
                }
            }
        };


        // =========================================================================
        // UI ÉS ESEMÉNYKEZELÉS (HELPER FÜGGVÉNYEKKEL)
        // =========================================================================

        const uiManager = {
            /** Üzenet megjelenítése a felületen. */
            showMessage: (elementId, message, isError = false) => {
                const box = document.getElementById(elementId);
                box.textContent = message;
                box.classList.remove('hidden', 'success', 'error');
                box.classList.add(isError ? 'error' : 'success');
                setTimeout(() => box.classList.add('hidden'), 5000);
            },

            /** Űrlap elemek dinamikus frissítése a típustól függően. */
            updateFormUI: (utilityType) => {
                const isFixedCost = CONFIG.FIXED_COST_TYPES.includes(utilityType);
                const priceInput = document.getElementById('price-per-unit');
                const priceLabel = document.getElementById('price-per-unit-label');
                const amountInput = document.getElementById('consumption-amount');
                const amountLabel = document.getElementById('consumption-amount-label');
                const currencySymbol = currentSettings.currency;

                priceLabel.textContent = isFixedCost ? `Havi Összeg (${currencySymbol})` : `Egységár (${currencySymbol})`;
                amountLabel.textContent = isFixedCost ? `Megjegyzés (opcionális)` : `Fogyasztás (egység)`;

                if (currentSettings.lastPrices && currentSettings.lastPrices[utilityType] !== undefined) {
                    priceInput.value = currentSettings.lastPrices[utilityType];
                } else {
                    priceInput.value = '';
                }
                
                if (isFixedCost) {
                    amountInput.type = 'text';
                    amountInput.required = false;
                    amountInput.placeholder = 'Pl. 12 hónapra fizetve';
                } else {
                    amountInput.type = 'number'; 
                    amountInput.required = true;
                    amountInput.placeholder = 'Pl. 150';
                }
            },

            /** Kezeli az egyes tétel törlés megerősítő modálját. */
            handleDeleteModal: (() => {
                const confirmModal = document.getElementById('confirm-modal');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                let itemToDelete = null;

                const show = (docId) => {
                    itemToDelete = docId;
                    confirmModal.classList.remove('hidden');
                };

                const hide = () => {
                    confirmModal.classList.add('hidden');
                    itemToDelete = null; 
                };

                cancelBtn.addEventListener('click', hide);
                confirmBtn.addEventListener('click', () => {
                    if (itemToDelete) {
                        dataService.deleteConsumption(itemToDelete);
                    }
                    hide();
                });

                return { show, hide };
            })(),

            /** Kezeli a teljes adatbázis törlésének modálját. */
            handleClearDBModal: (() => {
                const modal = document.getElementById('clear-db-modal');
                const confirmBtn = document.getElementById('clear-db-confirm-btn');
                const cancelBtn = document.getElementById('clear-db-cancel-btn');

                const show = () => {
                    modal.classList.remove('hidden');
                };

                const hide = () => {
                    modal.classList.add('hidden');
                };

                cancelBtn.addEventListener('click', hide);
                confirmBtn.addEventListener('click', () => {
                    dataService.clearAllConsumptions();
                    hide();
                });

                return { show, hide };
            })(),

            /** Megjeleníti a rögzített költségek listáját. */
            renderConsumptionList: () => {
                const listElement = document.getElementById('consumption-list');
                listElement.innerHTML = ''; 
                
                if (consumptionData.length === 0) {
                    listElement.innerHTML = '<li class="text-gray-500 italic p-3">Még nem rögzített költséget.</li>';
                    return;
                }

                consumptionData.forEach(item => {
                    const dateString = item.date.toLocaleDateString('hu-HU');
                    const cost = (item.amount * item.price).toFixed(0);
                    const isFixedCost = CONFIG.FIXED_COST_TYPES.includes(item.type);
                    
                    let detailText = '';
                    if (isFixedCost) {
                        detailText = `Fix költség: ${cost} ${currentSettings.currency}`;
                        if (item.comment) {
                            detailText += ` (${item.comment})`;
                        }
                    } else {
                        detailText = `${item.amount.toFixed(1)} egység @ ${item.price.toFixed(2)} ${currentSettings.currency}/egység`;
                    }

                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg';
                    listItem.innerHTML = `
                        <div class="flex flex-col flex-grow truncate mr-2">
                            <span class="font-medium text-gray-800">${dateString} - ${CONFIG.typeDisplayNames[item.type]}</span>
                            <span class="text-sm text-gray-600">${detailText}</span>
                        </div>
                        <div class="flex items-center space-x-3 flex-shrink-0">
                            <span class="font-bold text-red-600">${cost} ${currentSettings.currency}</span>
                            <button data-id="${item.id}" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded transition" title="Törlés">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    listElement.appendChild(listItem);
                });
                
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        uiManager.handleDeleteModal.show(this.dataset.id);
                    });
                });
            },

            /** Kiszámolja és frissíti a havi összehasonlító kimutatást. (Ugyanaz a logika, mint korábban) */
            updateSummary: () => {
                const now = new Date();
                const currentMonthStart = utils.getMonthStart(now);
                const currentMonthEnd = utils.getMonthEnd(now);
                
                const prevMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const prevMonthStart = utils.getMonthStart(prevMonthDate);
                const prevMonthEnd = utils.getMonthEnd(prevMonthDate);

                const allTypes = Object.keys(CONFIG.typeDisplayNames);
                const initialSummary = { cost: currentSettings.baseCost };
                allTypes.forEach(type => { initialSummary[type] = 0; });
                
                const summary = { current: { ...initialSummary }, previous: { ...initialSummary } };

                consumptionData.forEach(item => {
                    const cost = item.amount * item.price; 
                    const date = item.date;
                    let target = null;
                    
                    if (date >= currentMonthStart && date <= currentMonthEnd) {
                        target = summary.current;
                    } else if (date >= prevMonthStart && date <= prevMonthEnd) {
                        target = summary.previous;
                    }

                    if (target) {
                        target.cost += cost;
                        target[item.type] += CONFIG.FIXED_COST_TYPES.includes(item.type) ? cost : item.amount;
                    }
                });
                
                const renderComparison = (currentValue, prevValue, typeKey, isCost = false) => {
                    const diff = currentValue - prevValue;
                    let percentage = 0;
                    let colorClass = 'text-gray-600';
                    let arrow = '';
                    const unit = isCost || CONFIG.FIXED_COST_TYPES.includes(typeKey) ? currentSettings.currency : 'egység';
                    const title = CONFIG.typeDisplayNames[typeKey] || 'Teljes Költség';

                    if (prevValue > 0) {
                        percentage = (diff / prevValue) * 100;
                    } else if (prevValue === 0 && currentValue > 0) {
                        percentage = 100;
                    }
                    
                    if (diff > 0) {
                        colorClass = 'text-red-600';
                        arrow = '▲';
                    } else if (diff < 0) {
                        colorClass = 'text-green-600';
                        arrow = '▼';
                    }

                    const diffText = diff === 0 ? '±0%' : `${arrow} ${Math.abs(percentage).toFixed(0)}%`;
                    const trendText = `<span class="${colorClass} font-semibold text-sm ml-2">${diffText}</span>`;
                    const currentFormatted = currentValue.toLocaleString('hu-HU', { maximumFractionDigits: 0 });

                    return `
                        <div class="card p-4">
                            <p class="text-lg font-bold text-gray-800">${currentFormatted} ${unit}</p>
                            <p class="text-sm text-gray-500 mt-1">
                                ${title} 
                                ${trendText}
                            </p>
                        </div>
                    `;
                };
                
                let summaryHtml = renderComparison(summary.current.cost, summary.previous.cost, 'cost', true);
                
                allTypes.forEach(type => {
                    if (summary.current[type] > 0 || summary.previous[type] > 0) {
                        summaryHtml += renderComparison(summary.current[type], summary.previous[type], type, CONFIG.FIXED_COST_TYPES.includes(type));
                    }
                });

                document.getElementById('monthly-summary').innerHTML = summaryHtml;
            },

            /** Kezeli az import fájl kiválasztását és feldolgozását. */
            handleImportFile: (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        dataService.importData(importedData);
                    } catch (error) {
                        console.error("Hiba a fájl feldolgozásakor:", error);
                        uiManager.showMessage('data-management-message-box', 'Hiba: Érvénytelen JSON formátum.', true);
                    }
                    // Input resetelése, hogy újra lehessen ugyanazt a fájlt választani
                    e.target.value = '';
                };
                reader.onerror = () => {
                    uiManager.showMessage('data-management-message-box', 'Hiba a fájl beolvasásakor.', true);
                    e.target.value = '';
                };
                reader.readAsText(file);
            },


            /** Beállítja a fő eseménykezelőket. */
            setupEventListeners: () => {
                document.getElementById('utility-type').addEventListener('change', (e) => {
                    uiManager.updateFormUI(e.target.value);
                });
                document.getElementById('consumption-form').addEventListener('submit', uiManager.handleFormSubmit);

                // ÚJ: Adatkezelés események
                document.getElementById('export-data-btn').addEventListener('click', dataService.exportData);
                document.getElementById('import-file-input').addEventListener('change', uiManager.handleImportFile);
                document.getElementById('clear-data-prompt-btn').addEventListener('click', uiManager.handleClearDBModal.show);
            },

            /** Kezeli a költség rögzítő űrlap elküldését. */
            handleFormSubmit: async (e) => {
                e.preventDefault();

                if (!isAuthReady || !userId) {
                    uiManager.showMessage('consumption-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                    return;
                }

                const saveBtn = document.getElementById('save-consumption-btn');
                const saveText = document.getElementById('save-text');
                const saveSpinner = document.getElementById('save-spinner');

                saveBtn.disabled = true;
                saveText.textContent = 'Mentés...';
                saveSpinner.classList.remove('hidden');

                const formData = new FormData(e.target);
                const utilityType = formData.get('utility-type');
                const isFixedCost = CONFIG.FIXED_COST_TYPES.includes(utilityType);
                
                const priceValue = Number(formData.get('price-per-unit'));
                let amountValue = isFixedCost ? 1 : Number(formData.get('consumption-amount'));
                let comment = isFixedCost ? formData.get('consumption-amount') : '';

                if (isNaN(priceValue) || (!isFixedCost && isNaN(amountValue))) {
                    uiManager.showMessage('consumption-message-box', 'Kérjük, érvényes számokat adjon meg (Kivéve Megjegyzés).', true);
                    saveBtn.disabled = false;
                    saveText.textContent = 'Költség Mentése';
                    saveSpinner.classList.add('hidden');
                    return;
                }

                const costItem = {
                    type: utilityType,
                    amount: amountValue, 
                    price: priceValue,
                    date: new Date(formData.get('consumption-date')),
                    comment: comment, 
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(dataService.getConsumptionCollectionRef(), costItem);
                    
                    await setDoc(dataService.getSettingsDocRef(), { 
                        lastPrices: { 
                            ...currentSettings.lastPrices, 
                            [utilityType]: priceValue 
                        },
                        updatedAt: serverTimestamp()
                    }, { merge: true });

                    uiManager.showMessage('consumption-message-box', 'Költség sikeresen rögzítve!');
                    e.target.reset();
                    document.getElementById('consumption-date').valueAsDate = new Date();
                    uiManager.updateFormUI(utilityType);
                } catch (error) {
                    console.error("Hiba a rögzítéskor:", error);
                    uiManager.showMessage('consumption-message-box', `Hiba a rögzítéskor: ${error.message}`, true);
                } finally {
                    saveBtn.disabled = false;
                    saveText.textContent = 'Költség Mentése';
                    saveSpinner.classList.add('hidden');
                }
            }
        };

        // =========================================================================
        // SEGÉD FÜGGVÉNYEK (DÁTUM)
        // =========================================================================

        const utils = {
            getMonthStart: (date) => new Date(date.getFullYear(), date.getMonth(), 1),
            getMonthEnd: (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59)
        };


        // =========================================================================
        // ALKALMAZÁS INDÍTÁSA
        // =========================================================================
        
        /** Inicializálja az alkalmazást a betöltéskor. */
        const initializeApp = () => {
            initFirebase();
            uiManager.setupEventListeners();
            document.getElementById('consumption-date').valueAsDate = new Date();
            uiManager.updateFormUI(document.getElementById('utility-type').value);
        };

        initializeApp();

    </script>
</body>
</html>
