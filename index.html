<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .main-container {
            max-width: 420px;
            margin: auto;
            min-height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for modal content */
        #managed-categories-list::-webkit-scrollbar {
            width: 8px;
        }
        #managed-categories-list::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        #managed-categories-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

    </style>
</head>
<body class="bg-[#f4f7f6]">
    <div class="main-container p-4">

        <!-- Fő fejléc -->
        <header class="text-center py-6 bg-white rounded-xl shadow-lg mb-4">
            <h1 class="text-3xl font-extrabold text-[#3498eb] mb-1">Rezsi App</h1>
            <p class="text-sm text-gray-500">Gazdálkodj okosan a kiadásaiddal!</p>
            <div class="mt-2 text-xs text-gray-400" id="user-id-display"></div>
        </header>

        <!-- Havi egyenleg kijelző -->
        <div id="monthly-balance-indicator" class="p-4 rounded-xl mb-4 shadow-md bg-gray-100 text-gray-800 transition-colors duration-300">
            <p class="text-sm font-semibold mb-1">Havi egyenleg</p>
            <p id="monthly-balance" class="text-3xl font-bold">0 Ft</p>
        </div>

        <!-- Dátum Navigáció -->
        <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-4">
            <button onclick="changeMonth(-1)" class="p-2 text-gray-600 hover:text-[#3498eb] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <span id="current-month-display" class="text-xl font-bold text-gray-700"></span>
            <button onclick="changeMonth(1)" class="p-2 text-gray-600 hover:text-[#3498eb] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>

        <!-- Havi tételek és gombok -->
        <div class="space-y-4 mb-20">
            <!-- Tétel hozzáadása gomb -->
            <button onclick="showModal('add-item-modal')" class="w-full bg-[#3498eb] text-white py-3 rounded-xl font-bold text-lg shadow-lg hover:bg-[#2980b9] transition-colors">
                + Új tétel hozzáadása
            </button>
            
            <!-- Kezelt kategóriák gomb -->
            <button onclick="showModal('managed-categories-modal'); renderManagedCategories()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-lg shadow-md hover:bg-gray-300 transition-colors">
                Rendszeres kiadások / bevételek kezelése
            </button>

            <!-- A havi tételek listája ide kerül -->
            <div id="monthly-items-list" class="space-y-3">
                <!-- Tételek renderelése -->
            </div>
            
            <!-- Üres állapot üzenet -->
            <div id="no-items-message" class="hidden text-center text-gray-500 pt-8">
                <p>Nincsenek tételek ebben a hónapban.</p>
                <p>Kattints az "Új tétel hozzáadása" gombra!</p>
            </div>
        </div>

        <!-- 1. Új tétel Modál -->
        <div id="add-item-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-[#3498eb] mb-6">Új tétel hozzáadása</h2>
                <form id="add-item-form">
                    <div class="mb-4">
                        <label for="item-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                        <select id="item-type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]">
                            <option value="expense">Kiadás</option>
                            <option value="income">Bevétel</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="item-category" class="block text-sm font-medium text-gray-700 mb-1">Kategória</label>
                        <input type="text" id="item-category" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]" placeholder="Pl.: Villany, Fizetés, Internet">
                    </div>

                    <div class="mb-4">
                        <label for="item-amount" class="block text-sm font-medium text-gray-700 mb-1">Összeg (Ft)</label>
                        <input type="number" id="item-amount" required min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]" placeholder="Pl.: 15000">
                    </div>

                    <div class="mb-6">
                        <label for="item-date" class="block text-sm font-medium text-gray-700 mb-1">Dátum</label>
                        <input type="date" id="item-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]">
                    </div>

                    <div class="flex justify-between space-x-4">
                        <button type="button" onclick="hideAllModals()" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                        <button type="submit" class="flex-1 px-4 py-3 bg-[#3498eb] text-white rounded-lg font-semibold hover:bg-[#2980b9] transition-colors">Hozzáadás</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 2. Kezelt tétel Modál (Új/Szerkesztés) -->
        <div id="manage-category-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
                <h2 id="manage-category-title" class="text-2xl font-bold text-[#3498eb] mb-6">Új rendszeres tétel</h2>
                <form id="manage-category-form">
                    <input type="hidden" id="manage-category-id">

                    <div class="mb-4">
                        <label for="manage-category-type" class="block text-sm font-medium text-gray-700 mb-1">Típus</label>
                        <select id="manage-category-type" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]">
                            <option value="expense">Kiadás</option>
                            <option value="income">Bevétel</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="manage-category-name" class="block text-sm font-medium text-gray-700 mb-1">Kategória neve</label>
                        <input type="text" id="manage-category-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]" placeholder="Pl.: Villany, Fizetés">
                    </div>

                    <div class="mb-4">
                        <label for="manage-category-amount" class="block text-sm font-medium text-gray-700 mb-1">Fix Összeg (Ft)</label>
                        <input type="number" id="manage-category-amount" required min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]" placeholder="Pl.: 15000">
                    </div>

                    <div class="mb-6">
                        <label for="manage-category-day" class="block text-sm font-medium text-gray-700 mb-1">Hónap napja (1-28)</label>
                        <input type="number" id="manage-category-day" required min="1" max="28" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#3498eb] focus:border-[#3498eb]" placeholder="Pl.: 5">
                    </div>

                    <div class="flex justify-between space-x-4">
                        <button type="button" onclick="hideAllModals(); showModal('managed-categories-modal')" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                        <button type="submit" id="manage-category-submit-btn" class="flex-1 px-4 py-3 bg-[#3498eb] text-white rounded-lg font-semibold hover:bg-[#2980b9] transition-colors">Mentés</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 3. Kezelt tételek lista Modál -->
        <div id="managed-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h2 class="text-2xl font-bold text-[#3498eb] mb-2">Rendszeres tételek kezelése</h2>
                <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
                <button onclick="showModal('manage-category-modal'); setupCategoryFormForNew()" class="w-full bg-green-500 text-white py-2 rounded-lg font-bold text-md mb-4 shadow-md hover:bg-green-600 transition-colors">
                    + Új rendszeres tétel
                </button>
                <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                    <!-- Kezelt kategória lista ide kerül renderelésre -->
                </div>
                <div class="flex justify-end mt-4">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bezárás</button>
                </div>
            </div>
        </div>

        <!-- 4. Megerősítő Modál -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
                <p id="confirm-modal-body" class="text-gray-700 mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="cancel-delete-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">Törlés megerősítése</button>
                </div>
            </div>
        </div>
        
        <!-- 5. Toast üzenet -->
        <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-3 rounded-lg shadow-xl text-white opacity-0 transition-opacity duration-300 z-50">
            <p id="toast-message"></p>
        </div>

    </div>

    <!-- Firebase SDK Importok (ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globális változók a Firebase-hez
        let app, db, auth;
        let currentUserId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const itemsCollectionPath = (userId) => `/artifacts/${appId}/users/${userId}/items`;
        const managedCategoriesCollectionPath = (userId) => `/artifacts/${appId}/users/${userId}/managedCategories`;

        // Globális állapot
        let currentMonth = new Date();
        let monthlyItems = [];
        let managedCategories = [];
        let dataListenersAttached = false; // Új jelző a hallgatók egyszeri beállítására

        // -- Segéd függvények --

        // Toast üzenet megjelenítése
        function showToast(message, isError = false) {
            const toastEl = document.getElementById('toast');
            const messageEl = document.getElementById('toast-message');

            toastEl.classList.remove('opacity-100', 'bg-green-500', 'bg-red-500', 'opacity-0');
            
            messageEl.textContent = message;
            toastEl.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            
            // Megjelenítés
            toastEl.classList.add('opacity-100');

            // Eltüntetés 3 másodperc múlva
            setTimeout(() => {
                toastEl.classList.remove('opacity-100');
                toastEl.classList.add('opacity-0');
            }, 3000);
        }

        // Modálok kezelése
        window.showModal = function(id) {
            hideAllModals();
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        window.hideAllModals = function() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('manage-category-modal').classList.add('hidden');
            document.getElementById('managed-categories-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
        }

        // Dátum formázás
        function getFormattedMonth(date) {
            return date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
        }

        function getStartOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        function getEndOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59, 999);
        }

        // -- FIREBASE/ADATKEZELÉS --

        // A hitelesítés és a hallgatók beállítása
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Hitelesítés
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Sikeres bejelentkezés custom token-nel.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Sikeres anonim bejelentkezés.");
                }
                
                // Hitelesítési állapot figyelése (itt biztosítjuk, hogy a lekérdezések csak hitelesítés után fussanak)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Bejelentkezett felhasználó:", currentUserId);
                        document.getElementById('user-id-display').textContent = `Felhasználói azonosító (UID): ${currentUserId}`;
                        
                        // Adatok betöltése CSAK a hitelesítés után, és CSAK egyszer.
                        if (!dataListenersAttached) {
                            loadAllData();
                        }
                    } else {
                        console.log("Nincs bejelentkezett felhasználó.");
                        currentUserId = null; // Biztosítjuk, hogy null legyen, ha nincs bejelentkezve
                    }
                });

            } catch (error) {
                console.error("Alapvető hiba a Firebase inicializáláskor:", error);
                showToast("Hiba a Firebase inicializálásakor. Kérjük, próbálja újra később!", true);
            }
        }

        // Firestore hallgatók beállítása
        function loadAllData() {
            if (dataListenersAttached || !currentUserId) return; // Védelmi korlát

            // 1. Havi tételek hallgatója
            const itemsRef = collection(db, itemsCollectionPath(currentUserId));
            const itemsQuery = query(itemsRef);
            
            onSnapshot(itemsQuery, (snapshot) => {
                monthlyItems = [];
                snapshot.forEach(doc => {
                    monthlyItems.push({ id: doc.id, ...doc.data() });
                });
                console.log("Havi tételek frissítve:", monthlyItems.length);
                updateMonthDisplay(); // Frissíti a kijelzőt
            }, (error) => {
                console.error("Hiba az onSnapshot-ban (items):", error);
                showToast("Hiba a tételek betöltésekor. Lehet, hogy nincs jogosultság.", true);
            });

            // 2. Kezelt kategóriák hallgatója
            const categoriesRef = collection(db, managedCategoriesCollectionPath(currentUserId));
            const categoriesQuery = query(categoriesRef);

            onSnapshot(categoriesQuery, (snapshot) => {
                managedCategories = [];
                snapshot.forEach(doc => {
                    managedCategories.push({ id: doc.id, ...doc.data() });
                });
                console.log("Kezelt kategóriák frissítve:", managedCategories.length);
                // Ha nyitva van a modal, frissítsük a listát
                if (!document.getElementById('managed-categories-modal').classList.contains('hidden')) {
                    renderManagedCategories();
                }
            }, (error) => {
                console.error("Hiba az onSnapshot-ban (managedCategories):", error);
            });

            dataListenersAttached = true;
        }

        // Tétel hozzáadása a Firestore-hoz (FIX: ellenőrizzük, hogy a user ID be van-e állítva)
        async function addItem(itemData) {
            if (!currentUserId || !db) {
                showToast("Hiba: A felhasználó még nincs hitelesítve vagy az adatbázis nem elérhető. Kérlek várj egy pillanatot, amíg az azonosító betöltődik, és próbáld újra!", true);
                console.error("Hiba: Nincs érvényes currentUserId vagy db a tétel hozzáadásakor.");
                return; // Kritikus visszatérés, ha a hitelesítés nem teljes
            }
            
            try {
                const itemsRef = collection(db, itemsCollectionPath(currentUserId));
                await addDoc(itemsRef, itemData);
                showToast(`Sikeresen hozzáadva: ${itemData.category} (${itemData.amount.toLocaleString('hu-HU')} Ft)`);
                document.getElementById('add-item-form').reset();
                hideAllModals();
            } catch (e) {
                console.error("Hiba tétel hozzáadásakor: ", e);
                showToast("Hiba történt a tétel hozzáadásakor. (Engedélyezési probléma lehet)", true);
            }
        }

        // Tétel törlése a Firestore-ból
        async function deleteItem(itemId) {
            try {
                const docRef = doc(db, itemsCollectionPath(currentUserId), itemId);
                await deleteDoc(docRef);
                showToast("Tétel sikeresen törölve.");
            } catch (e) {
                console.error("Hiba tétel törlésekor: ", e);
                showToast("Hiba történt a tétel törlésekor.", true);
            }
        }
        
        // Kezelt kategória mentése/frissítése
        async function saveManagedCategory(categoryData, isUpdate) {
             if (!currentUserId || !db) {
                showToast("Hiba: A felhasználó még nincs hitelesítve. Kérlek várj egy pillanatot és próbáld újra!", true);
                return;
            }
            try {
                if (isUpdate) {
                    const docRef = doc(db, managedCategoriesCollectionPath(currentUserId), categoryData.id);
                    // Az ID-t nem mentjük a dokumentumba
                    const { id, ...dataToUpdate } = categoryData; 
                    await updateDoc(docRef, dataToUpdate);
                    showToast(`A(z) ${categoryData.name} kategória frissítve.`);
                } else {
                    const categoriesRef = collection(db, managedCategoriesCollectionPath(currentUserId));
                    await addDoc(categoriesRef, categoryData);
                    showToast(`Új rendszeres tétel hozzáadva: ${categoryData.name}`);
                }
                hideAllModals();
                showModal('managed-categories-modal'); // Vissza a listához
            } catch (e) {
                console.error("Hiba a kategória mentésekor: ", e);
                showToast("Hiba történt a rendszeres tétel mentésekor.", true);
            }
        }
        
        // Kezelt kategória törlése
        async function deleteManagedCategory(categoryId) {
            try {
                const docRef = doc(db, managedCategoriesCollectionPath(currentUserId), categoryId);
                await deleteDoc(docRef);
                showToast("Rendszeres tétel sikeresen törölve.");
            } catch (e) {
                console.error("Hiba a kategória törlésekor: ", e);
                showToast("Hiba történt a rendszeres tétel törlésekor.", true);
            }
        }


        // -- MODALOK ÉS ŰRLAPOK KEZELÉSE --

        // Új tétel űrlap kezelése
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Add Item Form Submitted."); // Debug: Ellenőrizd, hogy ez megjelenik-e a konzolban

            const type = document.getElementById('item-type').value;
            const category = document.getElementById('item-category').value.trim();
            const amount = parseInt(document.getElementById('item-amount').value, 10);
            const dateStr = document.getElementById('item-date').value;

            if (!category || isNaN(amount) || amount <= 0 || !dateStr) {
                showToast("Kérjük, minden mezőt tölts ki helyesen!", true);
                return;
            }

            // A dátumot Date objektumként mentjük, amit a Firestore Timestampként tárol
            const itemDate = new Date(dateStr);
            itemDate.setHours(12, 0, 0, 0); // Beállítjuk a délre, hogy ne legyen időzóna probléma
            
            const firestoreItem = {
                type: type,
                category: category,
                amount: amount,
                date: itemDate, 
            };
            
            await addItem(firestoreItem);
        });
        
        // Kezelt kategória űrlap előkészítése (új tételhez)
        window.setupCategoryFormForNew = function() {
            document.getElementById('manage-category-title').textContent = 'Új rendszeres tétel';
            document.getElementById('manage-category-id').value = '';
            document.getElementById('manage-category-form').reset();
        }

        // Kezelt kategória űrlap előkészítése (szerkesztéshez)
        window.setupCategoryFormForEdit = function(category) {
            document.getElementById('manage-category-title').textContent = 'Rendszeres tétel szerkesztése';
            document.getElementById('manage-category-id').value = category.id;
            document.getElementById('manage-category-type').value = category.type;
            document.getElementById('manage-category-name').value = category.name;
            document.getElementById('manage-category-amount').value = category.amount;
            document.getElementById('manage-category-day').value = category.day;
            
            hideAllModals();
            showModal('manage-category-modal');
        }
        
        // Kezelt kategória űrlap kezelése
        document.getElementById('manage-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('manage-category-id').value;
            const type = document.getElementById('manage-category-type').value;
            const name = document.getElementById('manage-category-name').value.trim();
            const amount = parseInt(document.getElementById('manage-category-amount').value, 10);
            const day = parseInt(document.getElementById('manage-category-day').value, 10);

            if (!name || isNaN(amount) || amount <= 0 || isNaN(day) || day < 1 || day > 28) {
                showToast("Kérjük, minden mezőt tölts ki helyesen! A nap 1 és 28 közé eshet.", true);
                return;
            }

            const categoryData = {
                id: id,
                type: type,
                name: name,
                amount: amount,
                day: day
            };
            
            await saveManagedCategory(categoryData, !!id); // Ha van ID, akkor frissítés
        });

        // -- KIJELZŐ FRISSÍTÉSEK --

        // Navigáció a hónapok között
        window.changeMonth = function(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            updateMonthDisplay();
        }

        // Havi kijelző frissítése (dátum, egyenleg)
        function updateMonthDisplay() {
            document.getElementById('current-month-display').textContent = getFormattedMonth(currentMonth);

            // JAVÍTÁS: Null ellenőrzés a DOM hibához (TypeError: Cannot read properties of null (reading 'classList'))
            const indicator = document.getElementById('monthly-balance-indicator');
            if (indicator) {
                // Töröljük az összes szín osztályt
                indicator.classList.remove('bg-red-200', 'text-red-700', 'bg-green-200', 'text-green-700', 'bg-gray-100', 'text-gray-800');
            }

            // Havi tételek szűrése és renderelése
            const filteredItems = filterItemsByMonth(currentMonth);
            renderMonthlyItems(filteredItems);
        }

        // Havi tételek szűrése dátum szerint
        function filterItemsByMonth(date) {
            const start = getStartOfMonth(date).getTime();
            const end = getEndOfMonth(date).getTime();
            
            // Konvertáljuk a Firestore Timestampeket JS Date-re az összehasonlításhoz
            return monthlyItems.filter(item => {
                // Biztonsági ellenőrzés: ha az item.date nem Timestamp, hanem Date, akkor is működjön, de a toDate() a Firestore-ra van.
                let itemDateMs;
                if (item.date && typeof item.date.toDate === 'function') {
                    itemDateMs = item.date.toDate().getTime(); 
                } else if (item.date instanceof Date) {
                    itemDateMs = item.date.getTime();
                } else {
                    return false; // Érvénytelen dátum
                }
                
                return itemDateMs >= start && itemDateMs <= end;
            }).sort((a, b) => {
                const dateA = a.date && typeof a.date.toDate === 'function' ? a.date.toDate().getTime() : 0;
                const dateB = b.date && typeof b.date.toDate === 'function' ? b.date.toDate().getTime() : 0;
                return dateB - dateA; // Rendezzük dátum szerint (legújabb elöl)
            });
        }


        // Havi tételek renderelése
        function renderMonthlyItems(items) {
            const listEl = document.getElementById('monthly-items-list');
            const noItemsEl = document.getElementById('no-items-message');
            listEl.innerHTML = '';
            
            let totalMonthlyBalance = 0;

            if (items.length === 0) {
                noItemsEl.classList.remove('hidden');
            } else {
                noItemsEl.classList.add('hidden');
                
                items.forEach(item => {
                    const isExpense = item.type === 'expense';
                    const sign = isExpense ? '-' : '+' : '';
                    const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                    const bgColorClass = isExpense ? 'bg-red-50' : 'bg-green-50';
                    const amountValue = isExpense ? -item.amount : item.amount;
                    totalMonthlyBalance += amountValue;

                    // Dátum konvertálás (biztonsági ellenőrzés, ha az adatok már betöltődtek)
                    let itemDate = new Date();
                    if (item.date && typeof item.date.toDate === 'function') {
                        itemDate = item.date.toDate();
                    } else if (item.date instanceof Date) {
                        itemDate = item.date;
                    }
                    
                    const formattedDate = itemDate.toLocaleDateString('hu-HU', { month: 'numeric', day: 'numeric' });

                    const itemHtml = `
                        <div class="flex justify-between items-center p-4 rounded-xl shadow-md ${bgColorClass}">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${item.category}</p>
                                <p class="text-xs text-gray-500">${formattedDate}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-lg font-bold ${colorClass}">
                                    ${sign} ${Math.abs(item.amount).toLocaleString('hu-HU', { style: 'currency', currency: 'HUF' })}
                                </span>
                                <button onclick="confirmDelete('${item.id}', '${item.category}')" class="text-gray-400 hover:text-red-500 p-1 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', itemHtml);
                });
            }

            // Havi egyenleg frissítése a kijelzőn
            const balanceElement = document.getElementById('monthly-balance');
            
            // JAVÍTÁS: Null ellenőrzés a DOM hibához
            const indicator = document.getElementById('monthly-balance-indicator');

            if (balanceElement) {
                balanceElement.textContent = totalMonthlyBalance.toLocaleString('hu-HU', { style: 'currency', currency: 'HUF' });

                if (indicator) {
                    // Eltávolítjuk a kezdeti szürke színt, mielőtt beállítjuk az új színt
                    indicator.classList.remove('bg-gray-100', 'text-gray-800'); 
                    
                    if (totalMonthlyBalance >= 0) {
                        indicator.classList.remove('bg-red-200', 'text-red-700');
                        indicator.classList.add('bg-green-200', 'text-green-700');
                    } else {
                        indicator.classList.remove('bg-green-200', 'text-green-700');
                        indicator.classList.add('bg-red-200', 'text-red-700');
                    }
                }
            }
        }

        // Törlés megerősítő modál megjelenítése
        window.confirmDelete = function(itemId, itemName) {
            showModal('confirmation-modal');
            document.getElementById('confirm-modal-title').textContent = 'Tétel törlése';
            document.getElementById('confirm-modal-body').innerHTML = `Biztosan törölni szeretnéd a(z) <strong>${itemName}</strong> tételt?`;

            const confirmBtn = document.getElementById('confirm-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-btn');

            // Cseréljük le a listener-t, hogy a megfelelő függvény fusson
            confirmBtn.onclick = async () => {
                await deleteItem(itemId);
                hideAllModals();
            };
            cancelBtn.onclick = hideAllModals;
        }
        
        // Kezelt kategória törlésének megerősítése
        window.confirmDeleteCategory = function(categoryId, categoryName) {
            showModal('confirmation-modal');
            document.getElementById('confirm-modal-title').textContent = 'Rendszeres tétel törlése';
            document.getElementById('confirm-modal-body').innerHTML = `Biztosan törölni szeretnéd a(z) <strong>${categoryName}</strong> rendszeres tételt?`;

            const confirmBtn = document.getElementById('confirm-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-btn');

            // Cseréljük le a listener-t, hogy a megfelelő függvény fusson
            confirmBtn.onclick = async () => {
                await deleteManagedCategory(categoryId);
                hideAllModals();
                showModal('managed-categories-modal'); // Vissza a listához
            };
            cancelBtn.onclick = () => {
                hideAllModals();
                showModal('managed-categories-modal'); // Vissza a listához
            }
        }

        // Kezelt kategória lista renderelése
        window.renderManagedCategories = function() {
            const listEl = document.getElementById('managed-categories-list');
            listEl.innerHTML = '';

            if (managedCategories.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 p-4">Még nincsenek rendszeres tételek.</p>';
                return;
            }

            managedCategories.forEach(category => {
                const isExpense = category.type === 'expense';
                const sign = isExpense ? '-' : '+';
                const colorClass = isExpense ? 'text-red-600' : 'text-green-600';
                const bgColorClass = isExpense ? 'bg-red-50' : 'bg-green-50';

                const categoryHtml = `
                    <div class="flex justify-between items-center p-3 rounded-lg shadow-sm ${bgColorClass} border-l-4 ${isExpense ? 'border-red-400' : 'border-green-400'}">
                        <div>
                            <p class="text-md font-semibold text-gray-800">${category.name}</p>
                            <p class="text-sm text-gray-500">Minden hónap ${category.day}. napja</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-md font-bold ${colorClass}">
                                ${sign} ${Math.abs(category.amount).toLocaleString('hu-HU', { style: 'currency', currency: 'HUF' })}
                            </span>
                            <button onclick="setupCategoryFormForEdit({ id: '${category.id}', type: '${category.type}', name: '${category.name}', amount: ${category.amount}, day: ${category.day} })" class="text-gray-500 hover:text-[#3498eb] p-1 rounded-full transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="confirmDeleteCategory('${category.id}', '${category.name}')" class="text-gray-500 hover:text-red-500 p-1 rounded-full transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', categoryHtml);
            });
        }


        // Indítás
        window.onload = function() {
            // Dátum mező alapértelmezett beállítása a mai napra
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('item-date');
            if (dateInput) {
                dateInput.value = today;
            }
            
            initializeFirebase();
            updateMonthDisplay(); // Első megjelenítés
        }
    </script>
</body>
</html>
