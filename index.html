<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Világos háttér */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s ease;
            z-index: 50; /* A modálok alá, de a tartalom fölé */
        }
        .modal-content {
            animation: slide-in 0.3s ease-out;
            max-height: 90vh; /* Mobilra optimalizálva */
            overflow-y: auto;
        }
        @keyframes slide-in {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .main-container {
            max-width: 600px; /* Szélesség korlátozása nagy képernyőn */
        }
        /* Egyedi stílus a hibajegy 4. pontjához: Modálok egymásra helyezése */
        #manage-recurring-modal { z-index: 55; }
        #add-recurring-modal { z-index: 60; } /* Ez legyen felül */
        #confirmation-modal { z-index: 70; } /* A megerősítés mindig felül */
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="main-container mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg class="w-8 h-8 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Rezsi Nyilvántartó
            </h1>
            <p id="user-info" class="text-xs text-gray-500 mt-1">Anonim felhasználó</p>
        </header>

        <!-- Hónap Választó és Műveletek -->
        <section class="mb-8 p-4 bg-blue-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold text-blue-800 mb-3">Hónap kezelése</h2>
            <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <div class="flex-grow">
                    <label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Aktuális Hónap:</label>
                    <select id="month-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm"></select>
                </div>
                <button onclick="createMonth()" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-medium rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out">
                    + Új Hónap
                </button>
                <!-- 2. Hiba Javítása: deleteMonth funkció hívása -->
                <button onclick="confirmMonthDeletion()" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out">
                    Hónap Törlése
                </button>
            </div>
        </section>

        <!-- Kategória Összegzés és Új Bejegyzés -->
        <section class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Összegzés</h2>
            <div id="summary-section" class="grid grid-cols-2 gap-4">
                <!-- Összegző kártyák ide kerülnek -->
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-600">Összes Kiadás</p>
                    <p id="total-spent" class="text-xl font-bold text-red-600">0 Ft</p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-600">Bevétel</p>
                    <p id="total-income" class="text-xl font-bold text-green-600">0 Ft</p>
                </div>
                <div class="col-span-2">
                    <div class="bg-blue-100 p-4 rounded-lg shadow-sm">
                        <p class="text-sm text-blue-700">Egyenleg</p>
                        <p id="balance" class="text-2xl font-bold text-blue-800">0 Ft</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button onclick="showAddCategoryModal()" class="flex-grow px-4 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 ease-in-out flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Új Bejegyzés Rögzítése
                </button>
                <button onclick="showRecurringItemsModal()" class="w-full sm:w-auto px-4 py-3 bg-gray-200 text-gray-800 font-semibold rounded-xl shadow-lg hover:bg-gray-300 transition duration-150 ease-in-out flex items-center justify-center">
                    Sablonok
                </button>
            </div>

            <div id="categories-list" class="mt-8 space-y-4">
                <!-- Kategória tételek ide kerülnek -->
            </div>
        </section>

    </div>

    <!-- 1. Új Bejegyzés Modál (Kiadás/Bevétel) -->
    <div id="add-category-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold text-blue-600 mb-4" id="modal-title">Új Bejegyzés Rögzítése</h2>
            <form id="add-category-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Típus:</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="type" value="expense" checked class="form-radio text-red-600 h-4 w-4">
                            <span class="ml-2 text-red-600">Kiadás</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="type" value="income" class="form-radio text-green-600 h-4 w-4">
                            <span class="ml-2 text-green-600">Bevétel</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">Kategória neve / Megnevezés:</label>
                    <input type="text" id="category-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label for="category-value" class="block text-sm font-medium text-gray-700 mb-1">Érték (Ft):</label>
                    <input type="number" id="category-value" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-6">
                    <label for="category-type" class="block text-sm font-medium text-gray-700 mb-1">Mérhető Kategória:</label>
                    <!-- 3. Hiba Javítása: A kategória lista helye -->
                    <select id="category-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Nincs mérhető tétel</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Rögzítés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Mérőállás Rögzítése Modál -->
    <div id="add-measurement-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">Mérőállás Rögzítése</h2>
            <form id="add-measurement-form">
                <div class="mb-4">
                    <label for="measurement-select" class="block text-sm font-medium text-gray-700 mb-1">Mérhető tétel:</label>
                    <select id="measurement-select" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <!-- Itt jelennek meg a mérhető kategóriák -->
                    </select>
                </div>

                <div class="mb-4">
                    <label for="current-measurement" class="block text-sm font-medium text-gray-700 mb-1">Aktuális mérőállás (egység):</label>
                    <input type="number" id="current-measurement" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="previous-measurement-info" class="text-xs text-gray-500 mt-1"></p>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Rögzítés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Ismétlődő tételek kezelése Modál (Sablonok) -->
    <!-- 4. Hiba Javítása: Modál z-index növelése, hogy felül legyen a fő modál -->
    <div id="manage-recurring-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-blue-600">Ismétlődő Tételek Kezelése</h2>
                <button type="button" onclick="showAddRecurringItemModal('manage-recurring-modal')" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">+ Új Sablon</button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kategória lista ide kerül renderelésre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- 4. Új Sablon Rögzítése Modál -->
    <!-- 4. Hiba Javítása: Modál z-index növelése, hogy a 'manage-recurring-modal' fölött legyen -->
    <div id="add-recurring-modal" class="modal-overlay hidden fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold text-blue-600 mb-4" id="recurring-modal-title">Új Sablon Rögzítése</h2>
            <form id="add-recurring-form">
                <input type="hidden" id="recurring-item-id">

                <div class="mb-4">
                    <label for="recurring-name" class="block text-sm font-medium text-gray-700 mb-1">Megnevezés:</label>
                    <input type="text" id="recurring-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="mb-4">
                    <label for="recurring-value" class="block text-sm font-medium text-gray-700 mb-1">Alapérték (Ft):</label>
                    <input type="number" id="recurring-value" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="mb-6">
                    <label for="recurring-type" class="block text-sm font-medium text-gray-700 mb-1">Típus:</label>
                    <select id="recurring-type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="expense">Kiadás</option>
                        <option value="income">Bevétel</option>
                        <option value="measurable">Mérhető (pl. villany, víz)</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideRecurringAddModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 5. Megerősítő Modál -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
            <p id="confirm-modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700">Törlés</button>
            </div>
        </div>
    </div>

    <!-- Firebase és Kód -->
    <script type="module">
        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            console.error("Firebase configuration is missing. Cannot initialize app.");
        }
        
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and state variables
        let app;
        let db;
        let auth;
        let userId = 'anon-default';
        let currentMonthId = null;
        let allMonths = [];
        let recurringItems = [];

        // Hiba esetén Debug logok bekapcsolása (ajánlott)
        setLogLevel('Debug');

        // --- Firebase Inicializálás és Hitelesítés ---
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Hitelesítési állapot figyelése
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `Felhasználó ID: ${userId}`;
                    initializeDataListeners();
                } else {
                    // Ha nincs token, anonim bejelentkezés
                    if (initialAuthToken) {
                         signInWithCustomToken(auth, initialAuthToken).catch(error => {
                            console.error("Custom token sign-in failed. Falling back to anonymous.", error);
                            signInAnonymously(auth).then(userCredential => {
                                userId = userCredential.user.uid;
                                document.getElementById('user-info').textContent = `Felhasználó ID: ${userId} (Anonim)`;
                                initializeDataListeners();
                            });
                        });
                    } else {
                        signInAnonymously(auth).then(userCredential => {
                            userId = userCredential.user.uid;
                            document.getElementById('user-info').textContent = `Felhasználó ID: ${userId} (Anonim)`;
                            initializeDataListeners();
                        }).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                        });
                    }
                }
            });
        }
        
        // --- Firestore Segédfüggvények ---
        
        // Lekéri a kollekció útvonalát
        function getCollectionPath(collectionName) {
            if (collectionName === 'recurringItems') {
                // A sablonok (recurringItems) lehetnek privátak is, de jelenleg az egyszerűség kedvéért a felhasználóhoz kötjük
                return `/artifacts/${appId}/users/${userId}/${collectionName}`;
            }
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        // --- Adat Figyelők (onSnapshot) Inicializálása ---
        function initializeDataListeners() {
            // 1. Hónapok figyelése
            const monthsCollectionRef = collection(db, getCollectionPath('months'));
            onSnapshot(monthsCollectionRef, (snapshot) => {
                allMonths = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allMonths.sort((a, b) => new Date(b.id) - new Date(a.id)); // Rendezés a legújabb hónap elől
                renderMonthSelect();
                
                // Ha van kiválasztott hónap ID, de az már nem létezik, vagy nincs kiválasztva, állítsuk be a legújabbat
                if (!currentMonthId || !allMonths.find(m => m.id === currentMonthId)) {
                    currentMonthId = allMonths.length > 0 ? allMonths[0].id : null;
                }

                if (currentMonthId) {
                    listenToCurrentMonthData(currentMonthId);
                } else {
                    // Ha nincs egyetlen hónap sem, ürítsük a nézetet
                    document.getElementById('month-select').innerHTML = '<option value="">Nincs rögzített hónap</option>';
                    document.getElementById('categories-list').innerHTML = '';
                    updateSummary(0, 0);
                }
            }, (error) => {
                console.error("Error listening to months:", error);
            });

            // 2. Ismétlődő tételek figyelése
            const recurringRef = collection(db, getCollectionPath('recurringItems'));
            onSnapshot(recurringRef, (snapshot) => {
                recurringItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecurringItemsList();
                // Frissíti a mérhető kategória listát az Új Bejegyzés modálban
                updateMeasurableCategorySelect(); 
            }, (error) => {
                console.error("Error listening to recurring items:", error);
            });
        }

        // 3. Aktuális hónap adatainak figyelése
        let unsubscribeMonthData = null;
        function listenToCurrentMonthData(monthId) {
            // Törli az előző figyelőt, ha létezett
            if (unsubscribeMonthData) {
                unsubscribeMonthData();
            }

            const monthDocRef = doc(db, getCollectionPath('months'), monthId);
            unsubscribeMonthData = onSnapshot(monthDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const monthData = docSnap.data();
                    renderCategoryList(monthData.categories || []);
                    updateSummary(monthData.totalSpent || 0, monthData.totalIncome || 0);
                } else {
                    console.warn(`Month document ${monthId} not found.`);
                    document.getElementById('categories-list').innerHTML = '<p class="text-gray-500">Nincs adat ehhez a hónaphoz.</p>';
                    updateSummary(0, 0);
                }
                // Azonnal frissítjük a hónapválasztó értéket
                document.getElementById('month-select').value = monthId;
            }, (error) => {
                console.error("Error listening to current month data:", error);
            });
        }

        // --- UI Frissítő Függvények ---

        // Hónap választó legördülő lista renderelése
        function renderMonthSelect() {
            const select = document.getElementById('month-select');
            select.innerHTML = '';

            if (allMonths.length === 0) {
                 select.innerHTML = '<option value="">Nincs rögzített hónap</option>';
            }

            allMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.id;
                option.textContent = formatMonthId(month.id);
                select.appendChild(option);
            });

            select.value = currentMonthId; // Visszaállítja a kiválasztott hónapot
            select.onchange = (e) => {
                currentMonthId = e.target.value;
                listenToCurrentMonthData(currentMonthId);
            };
        }

        // Összegzés frissítése
        function updateSummary(totalSpent, totalIncome) {
            const balance = totalIncome - totalSpent;
            document.getElementById('total-spent').textContent = `${totalSpent.toLocaleString('hu-HU')} Ft`;
            document.getElementById('total-income').textContent = `${totalIncome.toLocaleString('hu-HU')} Ft`;
            document.getElementById('balance').textContent = `${balance.toLocaleString('hu-HU')} Ft`;
            document.getElementById('balance').className = `text-2xl font-bold ${balance >= 0 ? 'text-blue-800' : 'text-red-600'}`;
        }

        // Kategória lista renderelése
        function renderCategoryList(categories) {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg shadow-sm">Nincs még bejegyzés ebben a hónapban. Rögzíts egyet!</p>';
                return;
            }

            // Kategóriák rendezése (pl. típus és név szerint)
            categories.sort((a, b) => a.name.localeCompare(b.name, 'hu'));

            categories.forEach((cat, index) => {
                const isExpense = cat.type === 'expense';
                const valueColor = isExpense ? 'text-red-600' : 'text-green-600';
                const sign = isExpense ? '-' : '+';
                const typeLabel = cat.type === 'measurable' ? 'Mérhető' : (isExpense ? 'Kiadás' : 'Bevétel');

                const item = `
                    <div class="flex justify-between items-center p-4 bg-white rounded-lg shadow-md border-l-4 ${isExpense ? 'border-red-500' : 'border-green-500'}">
                        <div>
                            <p class="text-base font-medium text-gray-800">${cat.name}</p>
                            <p class="text-xs text-gray-500">${typeLabel} ${cat.recurringItemId ? `(Sablon: ${recurringItems.find(r => r.id === cat.recurringItemId)?.name || 'ismeretlen'})` : ''}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <p class="text-lg font-semibold ${valueColor}">${sign} ${cat.value.toLocaleString('hu-HU')} Ft</p>
                            <button onclick="confirmCategoryDeletion('${currentMonthId}', ${index})" class="text-red-400 hover:text-red-600 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', item);
            });
        }

        // Ismétlődő tételek (Sablonok) lista renderelése a modálban
        function renderRecurringItemsList() {
            const list = document.getElementById('managed-categories-list');
            list.innerHTML = '';

            if (recurringItems.length === 0) {
                list.innerHTML = '<p class="text-gray-500 p-4 bg-gray-50 rounded-lg text-center">Nincs még rögzített sablon.</p>';
                return;
            }

            recurringItems.forEach(item => {
                const typeLabel = {
                    'expense': 'Kiadás',
                    'income': 'Bevétel',
                    'measurable': 'Mérhető'
                }[item.type] || 'Ismeretlen';
                
                const itemHtml = `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div>
                            <p class="font-medium text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.value.toLocaleString('hu-HU')} Ft - ${typeLabel}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showAddRecurringItemModal('manage-recurring-modal', '${item.id}')" class="text-blue-500 hover:text-blue-700 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            </button>
                            <button onclick="confirmRecurringItemDeletion('${item.id}')" class="text-red-500 hover:text-red-700 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
        
        // --- Segéd Függvények ---
        
        function formatMonthId(monthId) {
            const [year, month] = monthId.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
        }

        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.add('hidden');
            });
        }
        
        // --- Modál Kezelés (4. Hiba Javítás) ---

        // Új Sablon modál megnyitása (kezeli a főlé nyílást a 4. hiba miatt)
        window.showAddRecurringItemModal = (parentModalId, itemId = null) => {
            hideAllModals(); // Elrejti az összes modált, hogy tiszta lappal induljunk
            
            // Megnyitja a szülő modált, ha az volt nyitva (pl. a Sablonok modál)
            if (parentModalId) {
                document.getElementById(parentModalId).classList.remove('hidden');
            }
            
            // Ezt a modált nyitjuk meg
            const modal = document.getElementById('add-recurring-modal');
            const form = document.getElementById('add-recurring-form');
            form.reset();
            document.getElementById('recurring-item-id').value = '';
            
            if (itemId) {
                const item = recurringItems.find(r => r.id === itemId);
                if (item) {
                    document.getElementById('recurring-modal-title').textContent = 'Sablon Szerkesztése';
                    document.getElementById('recurring-item-id').value = itemId;
                    document.getElementById('recurring-name').value = item.name;
                    document.getElementById('recurring-value').value = item.value;
                    document.getElementById('recurring-type').value = item.type;
                }
            } else {
                 document.getElementById('recurring-modal-title').textContent = 'Új Sablon Rögzítése';
            }

            modal.classList.remove('hidden');
        };

        // Új Sablon modál bezárása
        window.hideRecurringAddModal = () => {
            document.getElementById('add-recurring-modal').classList.add('hidden');
            // Visszanyitjuk a szülő modált (Sablonok kezelése)
            document.getElementById('manage-recurring-modal').classList.remove('hidden');
        }

        window.showRecurringItemsModal = () => {
            hideAllModals();
            document.getElementById('manage-recurring-modal').classList.remove('hidden');
            // A renderRecurringItemsList meghívódik automatikusan az onSnapshot-ból.
        };
        
        window.showAddCategoryModal = (itemId = null) => {
            hideAllModals();
            document.getElementById('add-category-modal').classList.remove('hidden');
            // A kategória lista frissítése a 3. hiba javítása miatt.
            updateMeasurableCategorySelect(); 
        }

        // --- Adatbázis Műveletek ---

        // 1. Hiba Javítása: Új Hónap Létrehozása
        window.createMonth = async () => {
            if (!userId) return console.error("User not authenticated.");

            try {
                // Kiszámítja a következő hónap ID-t (YYYY-MM formátum)
                const lastMonthId = allMonths.length > 0 ? allMonths[0].id : null;
                let nextDate;
                
                if (lastMonthId) {
                    const [year, month] = lastMonthId.split('-').map(Number);
                    // Dátum objektum létrehozása: a hónap 0-tól indul, így a hónap - 1
                    const lastDate = new Date(year, month - 1, 1); 
                    
                    // Hozzáad egy hónapot: a következő hónap ID-jének kiszámítása
                    nextDate = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 1);
                } else {
                    // Ha nincs még hónap, a jelenlegi hónapot használja
                    nextDate = new Date();
                }

                // YYYY-MM formátum kialakítása a nextDate-ből
                const nextYear = nextDate.getFullYear();
                const nextMonth = String(nextDate.getMonth() + 1).padStart(2, '0');
                const nextMonthId = `${nextYear}-${nextMonth}`;

                // Ellenőrzés: ha az azonosító már létezik
                if (allMonths.some(m => m.id === nextMonthId)) {
                    console.error("A hónap már létezik:", nextMonthId);
                    alert(`A ${formatMonthId(nextMonthId)} hónap már létezik. Kérem, válasszon egyet a listából.`);
                    return;
                }
                
                // Új hónap dokumentum referencia
                const monthRef = doc(db, getCollectionPath('months'), nextMonthId);
                
                // Létrehozza az új hónapot alap adatokkal
                await setDoc(monthRef, {
                    totalSpent: 0,
                    totalIncome: 0,
                    categories: [],
                    createdAt: serverTimestamp()
                });

                currentMonthId = nextMonthId; // Átállítja az aktuális hónapra
                console.log("Új hónap létrehozva:", nextMonthId);

                // Megpróbálja hozzáadni az ismétlődő tételeket (sablonok)
                await applyRecurringItems(nextMonthId);

            } catch (error) {
                console.error("Hiba az új hónap létrehozásakor:", error);
            }
        }
        
        // Ismétlődő tételek alkalmazása az új hónapra
        async function applyRecurringItems(monthId) {
            const monthRef = doc(db, getCollectionPath('months'), monthId);
            
            await runTransaction(db, async (transaction) => {
                const monthDoc = await transaction.get(monthRef);
                const monthData = monthDoc.data();
                
                let updatedCategories = monthData.categories || [];
                let totalSpent = monthData.totalSpent || 0;
                let totalIncome = monthData.totalIncome || 0;

                recurringItems.forEach(item => {
                    // Hozzáadja a sablon alapján a tételt
                    const newCategory = {
                        id: crypto.randomUUID(),
                        name: item.name,
                        value: item.value,
                        type: item.type,
                        recurringItemId: item.id, // Hivatkozás a sablonra
                        date: serverTimestamp()
                    };
                    updatedCategories.push(newCategory);

                    if (item.type === 'expense' || item.type === 'measurable') {
                        totalSpent += item.value;
                    } else if (item.type === 'income') {
                        totalIncome += item.value;
                    }
                });

                // Frissíti a hónap dokumentumot a tranzakción belül
                transaction.update(monthRef, {
                    categories: updatedCategories,
                    totalSpent: totalSpent,
                    totalIncome: totalIncome
                });
            });
            console.log("Ismétlődő tételek sikeresen hozzáadva az új hónaphoz.");
        }


        // 2. Hiba Javítása: Hónap Törlésének Megerősítése és Törlése
        window.confirmMonthDeletion = () => {
            if (!currentMonthId) return alert("Nincs kiválasztva hónap a törléshez.");

            const monthName = formatMonthId(currentMonthId);
            document.getElementById('confirm-modal-title').textContent = `Hónap Törlése: ${monthName}`;
            document.getElementById('confirm-modal-body').textContent = `Biztosan törölni szeretnéd a(z) ${monthName} hónapot és az összes hozzá tartozó bejegyzést? EZ VISSZAVONHATATLAN!`;
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            // Ideiglenes eseménykezelő beállítása
            confirmBtn.onclick = async () => {
                await deleteMonth(currentMonthId);
                hideAllModals();
            };
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        };

        async function deleteMonth(monthId) {
            if (!userId) return console.error("User not authenticated.");
            try {
                const monthRef = doc(db, getCollectionPath('months'), monthId);
                await deleteDoc(monthRef);
                console.log("Hónap sikeresen törölve:", monthId);
                
                // Mivel az onSnapshot figyeli a változást, a UI magától frissül
                currentMonthId = null; 
            } catch (error) {
                console.error("Hiba a hónap törlésekor:", error);
            }
        }
        
        // Kategória törlésének megerősítése
        window.confirmCategoryDeletion = (monthId, categoryIndex) => {
            document.getElementById('confirm-modal-title').textContent = `Bejegyzés Törlése`;
            document.getElementById('confirm-modal-body').textContent = `Biztosan törölni szeretnéd ezt a bejegyzést?`;
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            confirmBtn.onclick = async () => {
                await deleteCategory(monthId, categoryIndex);
                hideAllModals();
            };
            
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        // Kategória törlése
        async function deleteCategory(monthId, categoryIndex) {
            if (!userId || !monthId) return console.error("Fizetőeszköz/Hónap ID hiányzik.");
            const monthRef = doc(db, getCollectionPath('months'), monthId);

            try {
                await runTransaction(db, async (transaction) => {
                    const monthDoc = await transaction.get(monthRef);
                    if (!monthDoc.exists()) throw "A hónap dokumentum nem található!";

                    const monthData = monthDoc.data();
                    let categories = monthData.categories || [];
                    
                    if (categoryIndex >= categories.length) throw "A bejegyzés indexe érvénytelen!";
                    
                    const deletedCategory = categories[categoryIndex];
                    categories.splice(categoryIndex, 1); // Törli a bejegyzést a tömbből

                    let totalSpent = monthData.totalSpent || 0;
                    let totalIncome = monthData.totalIncome || 0;

                    // Frissíti az összegeket
                    if (deletedCategory.type === 'expense' || deletedCategory.type === 'measurable') {
                        totalSpent -= deletedCategory.value;
                    } else if (deletedCategory.type === 'income') {
                        totalIncome -= deletedCategory.value;
                    }

                    // Frissíti a hónap dokumentumot
                    transaction.update(monthRef, {
                        categories: categories,
                        totalSpent: totalSpent,
                        totalIncome: totalIncome
                    });
                });
                console.log("Kategória sikeresen törölve.");
            } catch (e) {
                console.error("Hiba a kategória törlésekor: ", e);
            }
        }
        
        // --- Sablon (Ismétlődő Tétel) Műveletek ---

        // Sablon mentése/frissítése
        document.getElementById('add-recurring-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!userId) return console.error("User not authenticated.");

            const id = document.getElementById('recurring-item-id').value;
            const name = document.getElementById('recurring-name').value;
            const value = parseInt(document.getElementById('recurring-value').value);
            const type = document.getElementById('recurring-type').value;

            if (isNaN(value) || value <= 0) {
                alert("Az értéknek pozitív számnak kell lennie.");
                return;
            }

            const itemData = {
                name,
                value,
                type,
                date: serverTimestamp()
            };
            
            const recurringRef = collection(db, getCollectionPath('recurringItems'));

            try {
                if (id) {
                    // Szerkesztés
                    const docRef = doc(recurringRef, id);
                    await updateDoc(docRef, itemData);
                    console.log("Sablon frissítve:", id);
                } else {
                    // Új rögzítés
                    await addDoc(recurringRef, itemData);
                    console.log("Új sablon rögzítve.");
                }
                
                hideRecurringAddModal(); // Bezárja az "Új Sablon" modált, visszanyitja a "Sablonok" modált
                
            } catch (error) {
                console.error("Hiba a sablon mentésekor:", error);
            }
        };

        // Sablon törlésének megerősítése
        window.confirmRecurringItemDeletion = (itemId) => {
             const item = recurringItems.find(r => r.id === itemId);
             if (!item) return;

            document.getElementById('confirm-modal-title').textContent = `Sablon Törlése`;
            document.getElementById('confirm-modal-body').textContent = `Biztosan törölni szeretnéd a(z) "${item.name}" sablont? Ezzel a korábbi hónapok bejegyzései megmaradnak, de a sablon törlődik.`;
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            
            confirmBtn.onclick = async () => {
                await deleteRecurringItem(itemId);
                hideAllModals(); // Bezárja mindkét modált, a felhasználó a fő képernyőn folytatja.
            };
            
            // Először elrejtjük a szülő modált (Sablonok kezelése), mielőtt a megerősítő modált mutatjuk
            document.getElementById('manage-recurring-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.remove('hidden');
        };

        // Sablon törlése
        async function deleteRecurringItem(itemId) {
            if (!userId) return console.error("User not authenticated.");
            try {
                const itemRef = doc(db, getCollectionPath('recurringItems'), itemId);
                await deleteDoc(itemRef);
                console.log("Sablon sikeresen törölve:", itemId);
            } catch (error) {
                console.error("Hiba a sablon törlésekor:", error);
            }
        }
        
        // --- Kategória Rögzítés (3. Hiba Javítás) ---

        // 3. Hiba Javítása: Mérhető Kategória lista frissítése
        function updateMeasurableCategorySelect() {
            const select = document.getElementById('category-type');
            select.innerHTML = '';
            
            // Alapértelmezett opció, ha nincs mérhető tétel
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Nincs mérhető tétel';
            select.appendChild(defaultOption);

            // Csak a 'measurable' típusú sablonokat szűrjük
            const measurableItems = recurringItems.filter(item => item.type === 'measurable');

            if (measurableItems.length > 0) {
                measurableItems.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} (${item.value.toLocaleString('hu-HU')} Ft alapdíj)`;
                    select.appendChild(option);
                });
            }
        }

        // Új Bejegyzés mentése
        document.getElementById('add-category-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!userId || !currentMonthId) return alert("Hiba: Nincs bejelentkezve, vagy nincs kiválasztva hónap.");

            const form = e.target;
            const type = form.elements.type.value; // expense/income
            const name = document.getElementById('category-name').value;
            const value = parseInt(document.getElementById('category-value').value);
            const recurringItemId = document.getElementById('category-type').value || null; // Mérhető kategória ID

            if (isNaN(value) || value <= 0) {
                alert("Az értéknek pozitív számnak kell lennie.");
                return;
            }

            let categoryType = type;
            if (recurringItemId) {
                categoryType = 'measurable'; // Mérhető tételként rögzítjük
            }

            const newCategory = {
                id: crypto.randomUUID(),
                name,
                value,
                type: categoryType,
                recurringItemId: recurringItemId,
                date: serverTimestamp()
            };

            const monthRef = doc(db, getCollectionPath('months'), currentMonthId);

            try {
                await runTransaction(db, async (transaction) => {
                    const monthDoc = await transaction.get(monthRef);
                    if (!monthDoc.exists()) throw "A hónap dokumentum nem található!";

                    const monthData = monthDoc.data();
                    const categories = monthData.categories || [];
                    categories.push(newCategory);

                    let totalSpent = monthData.totalSpent || 0;
                    let totalIncome = monthData.totalIncome || 0;

                    // Frissíti az összegeket
                    if (categoryType === 'expense' || categoryType === 'measurable') {
                        totalSpent += value;
                    } else if (categoryType === 'income') {
                        totalIncome += value;
                    }

                    // Frissíti a hónap dokumentumot
                    transaction.update(monthRef, {
                        categories: categories,
                        totalSpent: totalSpent,
                        totalIncome: totalIncome
                    });
                });
                
                console.log("Új bejegyzés sikeresen rögzítve.");
                hideAllModals();
                form.reset();
                
            } catch (e) {
                console.error("Hiba az új bejegyzés rögzítésekor: ", e);
            }
        };

        // --- Mérőállás Műveletek ---

        window.showAddMeasurementModal = async () => {
            hideAllModals();
            document.getElementById('add-measurement-modal').classList.remove('hidden');
            // TODO: A mérhető kategória választó feltöltése és az előző állás lekérése
        }
        
    </script>
</body>
</html>
