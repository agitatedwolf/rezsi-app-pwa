<!DOCTYPE html>
<html lang="hu" class="transition-colors duration-500">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <!-- Tailwind CSS CDN és konfiguráció (dark mode: class) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Sötét mód engedélyezése 'dark' osztály alapján
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#3498eb',
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome ikonok a téma váltóhoz -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJd4S1R2W3Sg35B3b4O2Q6H6O8+fQjEwL6Vv5W2C3f6d7n4F7zI7mP+s6R1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore logolás bekapcsolása (debugoláshoz)
        setLogLevel('Debug');

        // Globális változók definíciója
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

    </script>
    <style>
        /* Általános átmenet alkalmazása az összes elemre a színek váltásánál */
        * {
            transition: background-color 0.5s, color 0.5s, border-color 0.5s;
        }
        /* Egyedi stílus a scrollbar-hoz (opcionális, de szebb sötét módban) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* light-mode */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; /* dark-mode */
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Fő Konténer -->
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Fejléc és Téma Váltó -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-primary-blue dark:text-blue-400">Rezsi Nyilvántartó</h1>
            <div class="flex items-center space-x-3">
                <button id="theme-toggle" class="p-2 rounded-full text-white bg-primary-blue dark:bg-blue-600 hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors shadow-md" aria-label="Téma váltása">
                    <!-- Ikon dinamikusan változik a JS-ben -->
                    <i class="fas" id="theme-icon"></i> 
                </button>
                <div id="user-info" class="text-sm font-medium text-gray-600 dark:text-gray-400">
                    <!-- Felhasználói ID ide kerül -->
                </div>
            </div>
        </header>

        <!-- Firestore Inicializáció és Auth State -->
        <div id="auth-status" class="mb-4 p-3 bg-yellow-100 dark:bg-yellow-900 border border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200 rounded-lg hidden">
            <p>Kapcsolódás a FireStore adatbázishoz...</p>
        </div>

        <!-- 1. Új Költség felvitele kártya -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8 transition-colors">
            <h2 class="text-2xl font-semibold mb-4 text-primary-blue dark:text-blue-400">Új Költség Felvitele</h2>
            <form id="new-cost-form">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Kategória -->
                    <div>
                        <label for="cost-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kategória</label>
                        <select id="cost-category" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                            <!-- Kategóriák feltöltése JS-ből -->
                        </select>
                    </div>
                    <!-- Összeg -->
                    <div>
                        <label for="cost-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Összeg (Ft)</label>
                        <input type="number" id="cost-amount" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                    <!-- Dátum -->
                    <div>
                        <label for="cost-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dátum</label>
                        <input type="date" id="cost-date" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                    <!-- Megjegyzés (opcionális) -->
                    <div>
                        <label for="cost-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Megjegyzés (opc.)</label>
                        <input type="text" id="cost-note" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-primary-blue focus:ring-opacity-75 transition-colors">
                    Hozzáadás
                </button>
            </form>
            <button onclick="showModal('manage-categories-modal')" class="w-full mt-3 text-sm text-primary-blue dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300 transition-colors">
                Rendszeres Költségek Kezelése
            </button>
        </div>

        <!-- 2. Összes Költség kártya -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg transition-colors">
            <h2 class="text-2xl font-semibold mb-4 text-primary-blue dark:text-blue-400">Összes Költség</h2>
            
            <!-- Szűrés hónap szerint -->
            <div class="mb-4">
                <label for="month-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Szűrés Hónap Szerint:</label>
                <input type="month" id="month-filter" class="rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
            </div>

            <!-- Összefoglaló -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                <p class="text-lg font-bold text-gray-800 dark:text-gray-200">Összes Költség a Kiválasztott Hónapban:</p>
                <p id="total-cost-display" class="text-2xl font-extrabold text-red-600 dark:text-red-400 mt-1">0 Ft</p>
            </div>

            <!-- Költség lista -->
            <div id="costs-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <!-- Költség tételek ide kerülnek renderelésre -->
            </div>

            <p id="no-costs-message" class="text-center text-gray-500 dark:text-gray-400 mt-4 hidden">Még nincs felvitt költség a kiválasztott hónapban.</p>
        </div>
    </div>

    <!-- Modálok ------------------------------------------------------------------------------------------------------->

    <!-- 1. Költség Szerkesztő Modál -->
    <div id="edit-cost-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg transition-colors">
            <h2 class="text-2xl font-bold mb-4 text-primary-blue dark:text-blue-400">Költség Szerkesztése</h2>
            <form id="edit-cost-form">
                <input type="hidden" id="edit-cost-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Kategória</label>
                        <select id="edit-category" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                            <!-- Kategóriák feltöltése JS-ből -->
                        </select>
                    </div>
                    <div>
                        <label for="edit-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Összeg (Ft)</label>
                        <input type="number" id="edit-amount" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                    <div>
                        <label for="edit-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dátum</label>
                        <input type="date" id="edit-date" required class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                    <div>
                        <label for="edit-note" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Megjegyzés (opc.)</label>
                        <input type="text" id="edit-note" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Mégse</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Hibaüzenet Modál -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transition-colors">
            <h2 class="text-xl font-bold text-red-600 mb-4">Hiba!</h2>
            <p id="error-modal-body" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <button onclick="hideAllModals()" class="px-4 py-2 bg-primary-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">Rendben</button>
        </div>
    </div>

    <!-- 3. Rendszeres Költségek Kezelő Modál -->
    <div id="manage-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg transition-colors">
            <h2 class="text-2xl font-bold mb-4 text-primary-blue dark:text-blue-400">Rendszeres Költségek Kezelése</h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kategória lista ide kerül renderelésre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- 4. Megerősítő Modál -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center transition-colors">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
            <p id="confirm-modal-body" class="text-gray-700 dark:text-gray-300 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">Mégse</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">Törlés</button>
            </div>
        </div>
    </div>


    <script>
        // Alapértelmezett kategóriák
        const defaultCategories = ['Áram', 'Gáz', 'Víz', 'Közös Költség', 'Internet', 'Telefon', 'Egyéb'];
        
        let db;
        let auth;
        let userId;
        let categories = []; // Aktuális kategóriák
        let recurringCostsUnsubscribe;
        let monthlyCostsUnsubscribe;

        // --- Kezdeti Firebase és Auth logika ---

        async function initializeFirebaseAndAuth() {
            try {
                // Globális változók ellenőrzése és beállítása
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("A Firebase konfiguráció hiányzik.");
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autentikáció
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth állapot figyelése
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').classList.add('hidden');
                        document.getElementById('user-info').textContent = `Felhasználó ID: ${userId}`;
                        console.log("Sikeres bejelentkezés. User ID:", userId);

                        // Inicializálja az alkalmazást az adatokkal
                        initAppWithData();
                    } else {
                        // Nem autentikált, hiba vagy anonim bejelentkezés
                        console.error("Autentikációs hiba történt.");
                        document.getElementById('auth-status').textContent = 'Hiba az autentikáció során.';
                        document.getElementById('auth-status').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Hiba a Firebase inicializálás vagy autentikáció során:", error);
                document.getElementById('auth-status').textContent = `Kritikus hiba: ${error.message}`;
                document.getElementById('auth-status').classList.remove('hidden');
                showErrorModal(`Kritikus hiba: ${error.message}`);
            }
        }

        function initAppWithData() {
            // Beállítja az alap kategóriákat, ha még nincsenek.
            // A kategóriák a recurring costs collection-ben vannak tárolva
            loadRecurringCosts();

            // Beállítja a havi költség nézetet a mai dátumra
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const defaultMonth = `${year}-${month}`;
            document.getElementById('month-filter').value = defaultMonth;
            
            // Indítja a költségek valós idejű figyelését
            loadMonthlyCosts(defaultMonth);
        }

        // --- Theme Toggle Logika (ÚJ RÉSZ) ---

        const htmlElement = document.documentElement;
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        function applyTheme(theme) {
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                if (themeIcon) {
                    themeIcon.classList.remove('fa-sun');
                    themeIcon.classList.add('fa-moon');
                }
                // Téma szín frissítése (pl. sötétkék a sötét témához)
                if (themeColorMeta) {
                    themeColorMeta.setAttribute('content', '#1f2937'); 
                }
            } else {
                htmlElement.classList.remove('dark');
                if (themeIcon) {
                    themeIcon.classList.remove('fa-moon');
                    themeIcon.classList.add('fa-sun');
                }
                // Téma szín frissítése (pl. világoskék a világos témához)
                if (themeColorMeta) {
                    themeColorMeta.setAttribute('content', '#3498eb');
                }
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const currentTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }

        // Téma betöltése oldalbetöltéskor
        document.addEventListener('DOMContentLoaded', () => {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                applyTheme(storedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // Rendszer beállítás követése
                applyTheme('dark');
            } else {
                applyTheme('light'); // Alapértelmezett: világos
            }

            // Eseménykezelő hozzáadása a gombhoz
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
            
            // Init Firebase and Data
            initializeFirebaseAndAuth();
        });


        // --- Firestore Műveletek ---

        function getCollectionPath(collectionName, isPublic = false) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            if (isPublic) {
                // Public data (ha lenne megosztott funkció)
                return `artifacts/${appId}/public/data/${collectionName}`;
            }
            // Private data (minden, ami most van)
            if (!userId) {
                console.error("User ID is not set. Cannot determine collection path.");
                return null;
            }
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        /**
         * Rendszeresen ismétlődő tételek (kategóriák) betöltése/figyelése.
         * A kategóriák a "recurring_costs" gyűjteményben vannak tárolva.
         */
        function loadRecurringCosts() {
            if (!db || !userId) return;
            const path = getCollectionPath('recurring_costs');
            if (!path) return;

            if (recurringCostsUnsubscribe) {
                recurringCostsUnsubscribe();
            }

            recurringCostsUnsubscribe = onSnapshot(collection(db, path), (snapshot) => {
                categories = [];
                const managedCategoriesList = document.getElementById('managed-categories-list');
                managedCategoriesList.innerHTML = '';
                
                // Kategóriák listájának összeállítása (a megjelenítendő és a select-boxba kerülő)
                const categoryDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Alap kategóriák hozzáadása, ha még nincsenek az adatbázisban
                const existingNames = categoryDocs.map(c => c.name);
                defaultCategories.forEach(defaultName => {
                    if (!existingNames.includes(defaultName)) {
                        // Csak a memóriában lévő listához adja hozzá, ha még nincs meg (ez nem kerül mentésre, csak a select box-ban jelenik meg, ha nincs beállított ár)
                        categories.push({ name: defaultName, amount: 0, isDefault: true });
                    }
                });

                // Adatbázisban tárolt kategóriák hozzáadása (ezeknek van beállított ára)
                categoryDocs.forEach(cost => {
                    categories.push({ 
                        id: cost.id, 
                        name: cost.name, 
                        amount: cost.amount, 
                        isDefault: defaultCategories.includes(cost.name) 
                    });

                    // Modál listájának feltöltése (csak a nem alapértelmezett vagy beállított értékű elemek)
                    renderManagedCategory(cost);
                });

                // Rendezés név szerint
                categories.sort((a, b) => a.name.localeCompare(b.name));

                // Select-boxok frissítése
                updateCategorySelects();
            }, (error) => {
                console.error("Hiba a rendszeres költségek figyelése közben:", error);
            });
        }
        
        // Költség hozzáadása
        document.getElementById('new-cost-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) return;

            const categoryName = document.getElementById('cost-category').value;
            const amount = parseInt(document.getElementById('cost-amount').value);
            const dateStr = document.getElementById('cost-date').value;
            const note = document.getElementById('cost-note').value.trim();

            if (isNaN(amount) || amount <= 0 || !categoryName || !dateStr) {
                showErrorModal("Kérlek adj meg érvényes kategóriát, összeget és dátumot.");
                return;
            }

            try {
                const collectionRef = collection(db, getCollectionPath('monthly_costs'));
                await addDoc(collectionRef, {
                    category: categoryName,
                    amount: amount,
                    date: dateStr, // Tárolás ISO formátumban (YYYY-MM-DD)
                    note: note,
                    createdAt: new Date().toISOString()
                });

                document.getElementById('new-cost-form').reset();
            } catch (error) {
                console.error("Hiba a költség hozzáadása során:", error);
                showErrorModal("Nem sikerült elmenteni a költséget. Próbáld újra.");
            }
        });

        // Költségek betöltése a kiválasztott hónapra
        document.getElementById('month-filter').addEventListener('change', (e) => {
            loadMonthlyCosts(e.target.value);
        });

        function loadMonthlyCosts(monthYear) {
            if (!db || !userId || !monthYear) return;
            const path = getCollectionPath('monthly_costs');
            if (!path) return;

            if (monthlyCostsUnsubscribe) {
                monthlyCostsUnsubscribe();
            }

            const [year, month] = monthYear.split('-');
            const startDate = `${year}-${month}-01`;
            const nextMonth = parseInt(month) === 12 ? '01' : String(parseInt(month) + 1).padStart(2, '0');
            const nextYear = parseInt(month) === 12 ? parseInt(year) + 1 : year;
            const endDate = `${nextYear}-${nextMonth}-01`;

            const q = query(
                collection(db, path),
                where('date', '>=', startDate),
                where('date', '<', endDate)
            );

            monthlyCostsUnsubscribe = onSnapshot(q, (snapshot) => {
                let totalCost = 0;
                const costsList = document.getElementById('costs-list');
                costsList.innerHTML = '';
                
                const costsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (costsData.length === 0) {
                    document.getElementById('no-costs-message').classList.remove('hidden');
                    document.getElementById('total-cost-display').textContent = '0 Ft';
                    return;
                }
                document.getElementById('no-costs-message').classList.add('hidden');

                // Költségek rendezése dátum szerint (a legújabb elöl)
                costsData.sort((a, b) => new Date(b.date) - new Date(a.date));

                costsData.forEach(cost => {
                    totalCost += cost.amount;
                    renderCostItem(cost, costsList);
                });

                document.getElementById('total-cost-display').textContent = `${totalCost.toLocaleString('hu-HU')} Ft`;

            }, (error) => {
                console.error("Hiba a havi költségek figyelése közben:", error);
            });
        }


        // --- UI Frissítések és Renderelés ---

        function updateCategorySelects() {
            const selects = [
                document.getElementById('cost-category'),
                document.getElementById('edit-category')
            ];

            selects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = '<option value="" disabled selected>Válassz kategóriát</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    // Megmutatja az összeget is, ha be van állítva
                    option.textContent = cat.amount > 0 
                        ? `${cat.name} (${cat.amount.toLocaleString('hu-HU')} Ft - Rendszeres)`
                        : cat.name; 
                    select.appendChild(option);
                });

                // Visszaállítja az előzőleg kiválasztott értéket
                if (currentValue && categories.some(cat => cat.name === currentValue)) {
                    select.value = currentValue;
                } else if (select.options.length > 1) {
                    select.value = ""; // Vagy beállítja az elsőt, ha nincs kiválasztott
                }
            });
        }

        function renderCostItem(cost, container) {
            const dateObj = new Date(cost.date);
            const formattedDate = dateObj.toLocaleDateString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit' });

            const div = document.createElement('div');
            div.className = "flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 hover:shadow-md transition-shadow cursor-pointer";
            div.innerHTML = `
                <div class="flex-1 min-w-0" onclick="showEditModal('${cost.id}', '${cost.category}', ${cost.amount}, '${cost.date}', '${cost.note}')">
                    <p class="text-lg font-medium text-primary-blue dark:text-blue-400 truncate">${cost.category}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Dátum: ${formattedDate}${cost.note ? ` | Megj.: ${cost.note}` : ''}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <p class="text-lg font-semibold text-red-600 dark:text-red-400 whitespace-nowrap">${cost.amount.toLocaleString('hu-HU')} Ft</p>
                    <button onclick="confirmDeleteCost('${cost.id}')" class="text-red-500 hover:text-red-700 dark:hover:text-red-300 p-1 transition-colors" aria-label="Költség törlése">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function renderManagedCategory(cost) {
            const list = document.getElementById('managed-categories-list');
            const div = document.createElement('div');
            div.className = "flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600";
            
            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <p class="text-md font-medium text-gray-800 dark:text-gray-200 truncate">${cost.name}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${cost.amount.toLocaleString('hu-HU')} Ft / hó (Előre kitöltés)</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="showEditRecurringCostModal('${cost.id}', '${cost.name}', ${cost.amount})" class="text-primary-blue hover:text-blue-600 dark:hover:text-blue-300 p-1" aria-label="Szerkesztés">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="confirmDeleteRecurringCost('${cost.id}', '${cost.name}')" class="text-red-500 hover:text-red-700 dark:hover:text-red-300 p-1" aria-label="Törlés">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            `;
            list.appendChild(div);
        }

        // --- Modál Kezelés és Műveletek ---

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideAllModals() {
            document.getElementById('edit-cost-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('manage-categories-modal').classList.add('hidden');
        }

        function showErrorModal(message) {
            document.getElementById('error-modal-body').textContent = message;
            showModal('error-modal');
        }

        function showEditModal(id, category, amount, date, note) {
            document.getElementById('edit-cost-id').value = id;
            document.getElementById('edit-category').value = category;
            document.getElementById('edit-amount').value = amount;
            document.getElementById('edit-date').value = date;
            document.getElementById('edit-note').value = note;
            
            // Frissíti a select boxot is
            updateCategorySelects();

            showModal('edit-cost-modal');
        }

        document.getElementById('edit-cost-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) return;

            const id = document.getElementById('edit-cost-id').value;
            const category = document.getElementById('edit-category').value;
            const amount = parseInt(document.getElementById('edit-amount').value);
            const dateStr = document.getElementById('edit-date').value;
            const note = document.getElementById('edit-note').value.trim();

            if (isNaN(amount) || amount <= 0 || !category || !dateStr) {
                showErrorModal("Kérlek adj meg érvényes kategóriát, összeget és dátumot.");
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath('monthly_costs'), id);
                await updateDoc(docRef, {
                    category: category,
                    amount: amount,
                    date: dateStr,
                    note: note
                });
                hideAllModals();
            } catch (error) {
                console.error("Hiba a költség szerkesztése során:", error);
                showErrorModal("Nem sikerült elmenteni a szerkesztett költséget.");
            }
        });

        function confirmDeleteCost(id) {
            document.getElementById('confirm-modal-title').textContent = 'Költség Törlése';
            document.getElementById('confirm-modal-body').textContent = 'Biztosan törölni szeretnéd ezt az egyszeri költséget? Ez a művelet nem vonható vissza.';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => deleteCost(id);
            confirmBtn.textContent = 'Törlés';
            confirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            document.getElementById('cancel-delete-btn').onclick = hideAllModals;
            showModal('confirmation-modal');
        }

        async function deleteCost(id) {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, getCollectionPath('monthly_costs'), id);
                await deleteDoc(docRef);
                hideAllModals();
            } catch (error) {
                console.error("Hiba a költség törlése során:", error);
                showErrorModal("Nem sikerült törölni a költséget.");
            }
        }
        
        // Rendszeres Költség Szerkesztése (a kategória árának beállítása/módosítása)
        function showEditRecurringCostModal(id, name, amount) {
            // A megerősítő modált használjuk a szerkesztéshez
            document.getElementById('confirm-modal-title').textContent = `Rendszeres Költség (${name})`;
            document.getElementById('confirm-modal-body').innerHTML = `
                <p class="mb-3 text-left">Adj meg egy új havi összeget az automatikus kitöltéshez:</p>
                <input type="number" id="recurring-amount-input" value="${amount}" min="0" 
                       class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 shadow-sm focus:border-primary-blue focus:ring focus:ring-primary-blue focus:ring-opacity-50 bg-gray-50 dark:bg-gray-700 dark:text-gray-100 p-2" required>
            `;
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => saveRecurringCost(id, name);
            confirmBtn.textContent = 'Mentés';
            confirmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            confirmBtn.classList.add('bg-green-600', 'hover:bg-green-700');

            document.getElementById('cancel-delete-btn').onclick = hideAllModals;
            showModal('confirmation-modal');
        }

        async function saveRecurringCost(id, name) {
            if (!db || !userId) return;
            
            const amountInput = document.getElementById('recurring-amount-input');
            const amount = parseInt(amountInput.value);

            if (isNaN(amount) || amount < 0) {
                showErrorModal("Kérlek adj meg érvényes összeget.");
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath('recurring_costs'), id);
                // Csak az összeget frissítjük
                await setDoc(docRef, { name: name, amount: amount }, { merge: true });
                hideAllModals();
            } catch (error) {
                console.error("Hiba a rendszeres költség mentése során:", error);
                showErrorModal("Nem sikerült elmenteni a rendszeres költséget.");
            }
        }

        function confirmDeleteRecurringCost(id, name) {
            document.getElementById('confirm-modal-title').textContent = `Tétel Törlése: ${name}`;
            document.getElementById('confirm-modal-body').textContent = 'Biztosan törölni szeretnéd ezt a tételt a rendszeres költségek közül? Ezzel csak az előre kitöltött összeget törlöd, a régi havi költségek megmaradnak.';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => deleteRecurringCost(id);
            confirmBtn.textContent = 'Törlés';
            confirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            document.getElementById('cancel-delete-btn').onclick = hideAllModals;
            showModal('confirmation-modal');
        }

        async function deleteRecurringCost(id) {
            if (!db || !userId) return;
            try {
                const docRef = doc(db, getCollectionPath('recurring_costs'), id);
                await deleteDoc(docRef);
                hideAllModals();
            } catch (error) {
                console.error("Hiba a rendszeres költség törlése során:", error);
                showErrorModal("Nem sikerült törölni a tételt.");
            }
        }

    </script>
</body>
</html>
