<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <!-- Tailwind CSS a stílusokhoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Egyedi stílusok a Tailwind kiegészítésére */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #d4e2f2; /* Világos kék háttér */
        }
        .container-card {
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        .main-header {
            background-color: #3498eb; /* Kék fejléc */
        }
        .btn-primary {
            background-color: #3498eb;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2a7fb8;
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Betöltő képernyő - addig marad, amíg az autentikáció le nem fut -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center transition-opacity duration-500 z-50">
        <div id="loading-spinner" class="spinner"></div>
        <p class="mt-4 text-gray-700 font-medium">Adatok betöltése...</p>
    </div>

    <!-- Fő tartalom - Kezdetben rejtett, amíg a betöltés be nem fejeződik -->
    <div id="main-content" class="flex-grow p-4 md:p-8 hidden">
        <div class="max-w-4xl mx-auto container-card rounded-xl">
            <!-- Fejléc -->
            <header class="main-header text-white p-6 rounded-t-xl flex justify-between items-center">
                <h1 class="text-2xl font-bold">Rezsi Nyilvántartó</h1>
                <div class="text-sm">
                    <p>Felhasználó ID:</p>
                    <p id="user-id-display" class="font-mono text-xs"></p>
                </div>
            </header>

            <!-- Hozzáadás gomb és összesítő -->
            <main class="p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <button id="open-add-modal-btn" class="btn-primary flex items-center px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Új tétel hozzáadása
                    </button>
                    <button id="open-managed-categories-btn" class="text-sm text-gray-600 hover:text-gray-900 underline">
                        Rendszeres tételek kezelése
                    </button>
                </div>
                
                <!-- Összesítő kártyák -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Havi összeg -->
                    <div class="p-4 bg-blue-100 rounded-lg shadow">
                        <p class="text-sm text-blue-800 font-semibold">Aktuális Hó Összesen</p>
                        <p id="current-month-total" class="text-2xl font-bold text-blue-900 mt-1">0 Ft</p>
                    </div>
                    <!-- Éves összeg -->
                    <div class="p-4 bg-green-100 rounded-lg shadow">
                        <p class="text-sm text-green-800 font-semibold">Aktuális Év Összesen</p>
                        <p id="current-year-total" class="text-2xl font-bold text-green-900 mt-1">0 Ft</p>
                    </div>
                     <!-- Elem darabszám -->
                    <div class="p-4 bg-yellow-100 rounded-lg shadow">
                        <p class="text-sm text-yellow-800 font-semibold">Tételek száma (aktuális hó)</p>
                        <p id="item-count" class="text-2xl font-bold text-yellow-900 mt-1">0 db</p>
                    </div>
                </div>

                <!-- Lista szűrő és fejléc -->
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold text-gray-800">Tételek</h2>
                    <select id="month-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <!-- Opciók generálása a JS-ben -->
                    </select>
                </div>

                <!-- Rezsi tételek listája -->
                <div id="utility-items-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- A tételek ide kerülnek beillesztésre a JS által -->
                    <p id="no-items-message" class="text-gray-500 text-center py-8">Még nincsenek tételek ebben a hónapban.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- 1. Új tétel/kategória hozzáadása Modál -->
    <div id="add-item-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg modal-content">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">Új kiadás hozzáadása</h2>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                
                <div>
                    <label for="item-date" class="block text-sm font-medium text-gray-700">Dátum</label>
                    <input type="date" id="item-date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="item-name" class="block text-sm font-medium text-gray-700">Tétel neve/Leírás</label>
                    <input type="text" id="item-name" required placeholder="Pl. Internet, Villany, Közös költség" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="item-amount" class="block text-sm font-medium text-gray-700">Összeg (Ft)</label>
                    <input type="number" id="item-amount" required min="0" placeholder="Pl. 15000" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg shadow-md">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Rendszeres tétel hozzáadása Modál -->
    <div id="managed-category-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Új rendszeres tétel</h2>
            <form id="managed-category-form" class="space-y-4">
                <div>
                    <label for="managed-category-name" class="block text-sm font-medium text-gray-700">Tétel neve</label>
                    <input type="text" id="managed-category-name" required placeholder="Pl. Bérleti díj, Kábel TV" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div>
                    <label for="managed-category-amount" class="block text-sm font-medium text-gray-700">Fix összeg (Ft)</label>
                    <input type="number" id="managed-category-amount" required min="0" placeholder="Pl. 180000" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="managed-category-day" class="block text-sm font-medium text-gray-700">Hónap hányadik napján esedékes</label>
                    <input type="number" id="managed-category-day" required min="1" max="28" value="1" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg shadow-md">Mentés</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 3. Kezelt kategóriák lista Modál -->
    <div id="managed-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Rendszeres tételek</h2>
            <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kategória lista ide kerül renderelésre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- 4. Megerősítő Modál -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center modal-content">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
            <p id="confirm-modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors">Törlés</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, runTransaction, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globális változók a Canvas környezetből
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const DB_PATH = `/artifacts/${appId}/users`;
        
        let app;
        let db;
        let auth;
        let currentUserId = null;
        let allItems = []; // Az összes adat tárolása

        // Elem referenciák (feltételezzük, hogy léteznek a DOM-ban)
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        const itemsList = document.getElementById('utility-items-list');
        const noItemsMessage = document.getElementById('no-items-message');
        const currentMonthTotalDisplay = document.getElementById('current-month-total');
        const currentYearTotalDisplay = document.getElementById('current-year-total');
        const itemCountDisplay = document.getElementById('item-count');
        const monthFilter = document.getElementById('month-filter');
        const managedCategoriesList = document.getElementById('managed-categories-list');


        if (Object.keys(firebaseConfig).length === 0) {
            console.error("FIREBASE HIBA: A firebase konfiguráció hiányzik.");
            document.getElementById('loading-spinner').innerHTML = '<p class="text-red-500 font-semibold">HIBA: Firebase konfiguráció hiányzik. Kérlek, nézd meg a konzolt.</p>';
            return;
        }

        function initFirebase() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
        }
        
        // Autentikációs logika (Custom Token vagy Anonim)
        async function initAuth() {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Autentikációs hiba:", error);
                document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500 font-semibold">HIBA: Autentikáció sikertelen. (${error.code})</p><p class="text-sm">Kérlek ellenőrizd a konzolt.</p>`;
            }
        }

        // --- Adatkezelő segédfüggvények ---

        // Valuta formázás
        function formatCurrency(amount) {
            return new Intl.NumberFormat('hu-HU', { style: 'currency', currency: 'HUF', maximumFractionDigits: 0 }).format(amount);
        }

        // Összesítő frissítése
        function updateSummary(items) {
            const today = new Date();
            const currentMonth = today.toISOString().substring(0, 7); // YYYY-MM
            const currentYear = today.getFullYear();

            const monthlyTotal = items
                .filter(item => item.date.startsWith(currentMonth))
                .reduce((sum, item) => sum + (item.amount || 0), 0);
            
            const yearlyTotal = items
                .filter(item => item.date.startsWith(currentYear))
                .reduce((sum, item) => sum + (item.amount || 0), 0);

            const itemCount = items.filter(item => item.date.startsWith(currentMonth)).length;

            currentMonthTotalDisplay.textContent = formatCurrency(monthlyTotal);
            currentYearTotalDisplay.textContent = formatCurrency(yearlyTotal);
            itemCountDisplay.textContent = `${itemCount} db`;
        }

        // Hónap szűrő (select) feltöltése
        function populateMonthFilter(items) {
            const months = new Set();
            items.forEach(item => months.add(item.date.substring(0, 7)));

            const sortedMonths = Array.from(months).sort().reverse();
            
            // Ha még nincs kiválasztott hónap, akkor az aktuálisat állítjuk be
            const todayMonth = new Date().toISOString().substring(0, 7);
            if (!sortedMonths.includes(todayMonth)) {
                sortedMonths.unshift(todayMonth);
            }

            // Töröljük a korábbi opciókat
            monthFilter.innerHTML = '';

            sortedMonths.forEach(month => {
                const date = new Date(month + '-01');
                const monthName = date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long' });
                const option = document.createElement('option');
                option.value = month;
                option.textContent = monthName;
                monthFilter.appendChild(option);
            });
            
            // A szűrő kiválasztott értékét frissíteni kell, hogy a legutóbbi aktuális hónap legyen a kijelölt
            if (monthFilter.value !== todayMonth) {
                 monthFilter.value = todayMonth;
            }
        }

        // Lista megjelenítése (szűrés után)
        function renderItems(items) {
            const selectedMonth = monthFilter.value;
            const filteredItems = items
                .filter(item => item.date.startsWith(selectedMonth))
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Legújabb felül

            itemsList.innerHTML = '';

            if (filteredItems.length === 0) {
                noItemsMessage.classList.remove('hidden');
                itemsList.appendChild(noItemsMessage);
                return;
            }

            noItemsMessage.classList.add('hidden');

            filteredItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center p-3 bg-white hover:bg-gray-50 border border-gray-200 rounded-lg shadow-sm transition-colors';
                itemElement.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800">${item.name}</span>
                        <span class="text-xs text-gray-500">${item.date}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg text-blue-700">${formatCurrency(item.amount)}</span>
                        <button type="button" onclick="openEditItemModal('${item.id}', '${item.name}', '${item.date}', ${item.amount})" class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7 1l4-4M18 6l-4 4M7 17l1 1"></path></svg>
                        </button>
                        <button type="button" onclick="confirmDeleteItem('${item.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 12.04a2 2 0 01-2 1.96H7.86a2 2 0 01-2-1.96L5 7m5 4v6m4-6v6m4-10H5m14 0h-2m-4 0h-4"></path></svg>
                        </button>
                    </div>
                `;
                itemsList.appendChild(itemElement);
            });
        }

        // Kezelt kategóriák megjelenítése
        function renderManagedCategories(categories) {
            managedCategoriesList.innerHTML = '';

            if (categories.length === 0) {
                managedCategoriesList.innerHTML = '<p class="text-gray-500">Nincsenek rendszeres tételek beállítva.</p>';
                return;
            }

            categories.forEach(cat => {
                const catElement = document.createElement('div');
                catElement.className = 'flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                catElement.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800">${cat.name}</span>
                        <span class="text-xs text-gray-500">${formatCurrency(cat.amount)} / hó (${cat.day}. nap)</span>
                    </div>
                    <button type="button" onclick="confirmDeleteManagedCategory('${cat.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.86 12.04a2 2 0 01-2 1.96H7.86a2 2 0 01-2-1.96L5 7m5 4v6m4-6v6m4-10H5m14 0h-2m-4 0h-4"></path></svg>
                    </button>
                `;
                managedCategoriesList.appendChild(catElement);
            });
        }

        // --- Firebase CRUD és Listenerek ---

        // Adat listenerek beállítása (rezsi tételek és rendszeres kategóriák)
        function listenForData() {
            if (!currentUserId) return;

            // 1. Rezsi tételek listenere
            const itemsRef = collection(db, `${DB_PATH}/${currentUserId}/items`);
            const q = query(itemsRef); 
            onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                populateMonthFilter(allItems);
                renderItems(allItems);
                updateSummary(allItems);
                
                console.log("Rezsi tételek frissítve:", allItems.length);
            }, (error) => {
                console.error("Hiba az adatok lekérdezésekor (items):", error);
            });

            // 2. Kezelt kategóriák listenere
            const managedCategoriesRef = collection(db, `${DB_PATH}/${currentUserId}/managedCategories`);
            const qManaged = query(managedCategoriesRef);
            onSnapshot(qManaged, (snapshot) => {
                const managedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderManagedCategories(managedCategories);
                console.log("Rendszeres tételek frissítve:", managedCategories.length);
            }, (error) => {
                console.error("Hiba az adatok lekérdezésekor (managedCategories):", error);
            });
        }

        // Tétel mentése/szerkesztése
        async function saveItem(event) {
            event.preventDefault();
            if (!currentUserId) return console.error("Nincs bejelentkezett felhasználó.");

            const itemId = document.getElementById('item-id').value;
            const date = document.getElementById('item-date').value;
            const name = document.getElementById('item-name').value;
            const amount = parseInt(document.getElementById('item-amount').value, 10);

            const itemData = {
                date: date,
                name: name,
                amount: amount,
                createdAt: itemId ? undefined : Timestamp.now()
            };

            try {
                const itemsCollectionRef = collection(db, `${DB_PATH}/${currentUserId}/items`);
                if (itemId) {
                    await updateDoc(doc(itemsCollectionRef, itemId), itemData);
                    console.log("Tétel frissítve:", itemId);
                } else {
                    await addDoc(itemsCollectionRef, itemData);
                    console.log("Új tétel hozzáadva.");
                }
                hideAllModals();
            } catch (e) {
                console.error("Hiba a tétel mentésekor:", e);
                alert("Hiba történt a tétel mentésekor.");
            }
        }

        // Tétel törlése
        async function deleteItem(itemId) {
            if (!currentUserId || !itemId) return;

            try {
                const itemRef = doc(db, `${DB_PATH}/${currentUserId}/items`, itemId);
                await deleteDoc(itemRef);
                console.log("Tétel törölve:", itemId);
                hideAllModals();
            } catch (e) {
                console.error("Hiba a tétel törlésekor:", e);
                alert("Hiba történt a tétel törlésekor.");
            }
        }

        // Rendszeres tétel mentése
        async function saveManagedCategory(event) {
            event.preventDefault();
            if (!currentUserId) return;

            const name = document.getElementById('managed-category-name').value;
            const amount = parseInt(document.getElementById('managed-category-amount').value, 10);
            const day = parseInt(document.getElementById('managed-category-day').value, 10);

            const catData = {
                name: name,
                amount: amount,
                day: day,
                createdAt: Timestamp.now()
            };

            try {
                await addDoc(collection(db, `${DB_PATH}/${currentUserId}/managedCategories`), catData);
                console.log("Új rendszeres tétel hozzáadva.");
                hideAllModals();
            } catch (e) {
                console.error("Hiba a rendszeres tétel mentésekor:", e);
                alert("Hiba történt a rendszeres tétel mentésekor.");
            }
        }
        
        // Rendszeres tétel törlése
        async function deleteManagedCategory(catId) {
            if (!currentUserId || !catId) return;

            try {
                const catRef = doc(db, `${DB_PATH}/${currentUserId}/managedCategories`, catId);
                await deleteDoc(catRef);
                console.log("Rendszeres tétel törölve:", catId);
                hideAllModals();
            } catch (e) {
                console.error("Hiba a rendszeres tétel törlésekor:", e);
                alert("Hiba történt a rendszeres tétel törlésekor.");
            }
        }

        // --- Rendszeres tételek automatikus generálása ---

        // Ellenőrzi, hogy az adott hónapra generáltuk-e már a tételeket.
        async function checkGenerationStatus(yearMonth) {
            if (!currentUserId) return false;
            const docRef = doc(db, `${DB_PATH}/${currentUserId}/state`, 'generationStatus');
            const docSnap = await getDoc(docRef);
            return docSnap.exists() && docSnap.data().lastGeneratedMonth === yearMonth;
        }

        // Beállítja, hogy az adott hónapra megtörtént a generálás.
        async function setGenerationStatus(yearMonth) {
            if (!currentUserId) return;
            const docRef = doc(db, `${DB_PATH}/${currentUserId}/state`, 'generationStatus');
            await setDoc(docRef, { lastGeneratedMonth: yearMonth }, { merge: true });
        }

        // Rendszeres tételek generálásának fő logikája
        async function handleNewMonthGeneration() {
            if (!currentUserId) return;

            const today = new Date();
            const currentYearMonth = today.toISOString().substring(0, 7);
            const currentDay = today.getDate();
            
            // Csak a hónap 1. és 15. napja között ellenőrizzük (elkerülendő a felesleges hívásokat)
            if (currentDay > 15) return; 

            const alreadyGenerated = await checkGenerationStatus(currentYearMonth);

            if (alreadyGenerated) {
                console.log(`Rendszeres tételek már generálva lettek erre a hónapra (${currentYearMonth}).`);
                return;
            }
            
            console.log(`Rendszeres tételek generálása a(z) ${currentYearMonth} hónapra...`);

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Megnézzük a generálás állapotát TRANZAKCIÓVAL
                    const statusRef = doc(db, `${DB_PATH}/${currentUserId}/state`, 'generationStatus');
                    const statusDoc = await transaction.get(statusRef);
                    if (statusDoc.exists() && statusDoc.data().lastGeneratedMonth === currentYearMonth) {
                        // Másik példány időközben generálta, kilépünk a tranzakcióból.
                        throw new Error("Already generated by another instance.");
                    }
                    
                    // 2. Lekérdezzük az aktív rendszeres tételeket
                    const categoriesSnapshot = await getDocs(collection(db, `${DB_PATH}/${currentUserId}/managedCategories`));
                    const itemsCollectionRef = collection(db, `${DB_PATH}/${currentUserId}/items`);

                    const itemsToGenerate = [];
                    categoriesSnapshot.forEach(catDoc => {
                        const cat = catDoc.data();
                        
                        // Csak akkor generálunk tételt, ha a beállított nap már elmúlt vagy a mai nap van.
                        // Ez a logika nem szigorú, de ha a 15. nap előtt vagyunk, valószínűleg generálni kell.
                        // A beállított nappal való összehasonlítás itt nem kritikus, mert a generálást csak a hónap elején csináljuk.
                        
                        // Létrehozzuk a dátumot a beállított nappal
                        const itemDate = new Date(today.getFullYear(), today.getMonth(), cat.day);
                        
                        itemsToGenerate.push({
                            date: itemDate.toISOString().substring(0, 10),
                            name: cat.name,
                            amount: cat.amount,
                            isGenerated: true,
                            createdAt: Timestamp.now()
                        });
                    });
                    
                    // 3. Generált tételek hozzáadása (Batch-et használhatnánk, de a tranzakció miatt most egyesével)
                    itemsToGenerate.forEach(item => {
                        transaction.set(doc(itemsCollectionRef), item);
                    });
                    
                    // 4. Generálási állapot frissítése
                    transaction.set(statusRef, { lastGeneratedMonth: currentYearMonth }, { merge: true });
                });
                
                console.log(`Rendszeres tételek sikeresen generálva: ${currentYearMonth}`);

            } catch (e) {
                if (e.message !== "Already generated by another instance.") {
                    console.error("Hiba a havi generálás során (tranzakció):", e);
                }
            }
        }


        // --- Modál kezelő függvények ---

        function hideAllModals() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('managed-category-modal').classList.add('hidden');
            document.getElementById('managed-categories-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        window.hideAllModals = hideAllModals; // Globalizálás az onclick-hez

        function openAddModal() {
            const form = document.getElementById('item-form');
            form.reset();
            document.getElementById('item-id').value = '';
            document.getElementById('modal-title').textContent = 'Új kiadás hozzáadása';
            // Aktuális dátum beállítása alapértelmezettnek
            document.getElementById('item-date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('add-item-modal').classList.remove('hidden');
        }
        
        function openEditItemModal(id, name, date, amount) {
            document.getElementById('item-id').value = id;
            document.getElementById('item-name').value = name;
            document.getElementById('item-date').value = date;
            document.getElementById('item-amount').value = amount;
            document.getElementById('modal-title').textContent = 'Kiadás szerkesztése';
            document.getElementById('add-item-modal').classList.remove('hidden');
        }
        window.openEditItemModal = openEditItemModal; // Globalizálás az onclick-hez

        // Megerősítő Modál megjelenítése - tétel törlése
        function confirmDeleteItem(itemId) {
            document.getElementById('confirm-modal-title').textContent = 'Tétel törlése';
            document.getElementById('confirm-modal-body').textContent = 'Biztosan törölni szeretnéd ezt a tételt? A művelet nem vonható vissza.';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => deleteItem(itemId);
            confirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            document.getElementById('confirmation-modal').classList.remove('hidden');
        }
        window.confirmDeleteItem = confirmDeleteItem; // Globalizálás az onclick-hez
        document.getElementById('cancel-delete-btn').addEventListener('click', hideAllModals);

        // Megerősítő Modál megjelenítése - rendszeres tétel törlése
        function confirmDeleteManagedCategory(catId) {
            document.getElementById('confirm-modal-title').textContent = 'Rendszeres tétel törlése';
            document.getElementById('confirm-modal-body').textContent = 'Biztosan törölni szeretnéd ezt a rendszeres tételt?';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            confirmBtn.onclick = () => deleteManagedCategory(catId);
            confirmBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmBtn.classList.add('bg-red-600', 'hover:bg-red-700');

            document.getElementById('confirmation-modal').classList.remove('hidden');
        }
        window.confirmDeleteManagedCategory = confirmDeleteManagedCategory; // Globalizálás az onclick-hez

        // --- Inicializálás és Eseménykezelők ---

        // 1. Firebase és Auth Inicializálás
        initFirebase();
        
        // 2. Auth állapot változás figyelése
        onAuthStateChanged(auth, async (user) => {
            console.log("Auth State Changed. User:", user ? user.uid : "null");
            
            if (user) {
                // Sikeres autentikáció: beállítjuk az ID-t és elkezdjük a data listenert
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                
                listenForData();
                handleNewMonthGeneration(); // Rendszeres tételek ellenőrzése és generálása
            } else {
                // Hiba vagy kijelentkezés: Nincs felhasználó, adatbetöltés kihagyva
                currentUserId = null;
                userIdDisplay.textContent = "Nem hitelesített (Hiba)";
                console.warn("Autentikáció végzett, de nincs érvényes felhasználó. Adatbetöltés kihagyva.");
            }

            // FONTOS JAVÍTÁS: A töltőképernyőt MINDIG el kell rejteni az első Auth állapotváltozás után,
            // függetlenül a bejelentkezés sikerétől. Ez megakadályozza az "örökös pörgést".
            // Ellenőrizzük, hogy a takaró még aktív-e.
            if (loadingOverlay && !loadingOverlay.classList.contains('opacity-0')) {
                loadingOverlay.classList.add('opacity-0');
                loadingOverlay.addEventListener('transitionend', () => {
                    loadingOverlay.style.display = 'none';
                    mainContent.style.display = 'block';
                }, { once: true });
            }
        });

        // Eseménykezelők
        document.getElementById('open-add-modal-btn').addEventListener('click', openAddModal);
        document.getElementById('open-managed-categories-btn').addEventListener('click', () => {
            document.getElementById('managed-categories-modal').classList.remove('hidden');
        });
        document.getElementById('item-form').addEventListener('submit', saveItem);
        document.getElementById('managed-category-form').addEventListener('submit', saveManagedCategory);
        monthFilter.addEventListener('change', () => renderItems(allItems));

        // Első lépés: Autentikáció indítása
        initAuth();

    </script>
    
</body>
</html>
