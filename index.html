<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilvántartó (PWA)</title>
    <!-- PWA MANIFEST és TÉMA SZÍN beállítások a telefonos telepítéshez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <!-- Tailwind CSS a stílusokhoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f8f8; }
        .modal { transition: opacity 0.3s ease-out; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Scrollbar styling for better UX */
        .max-h-96::-webkit-scrollbar { width: 8px; }
        .max-h-96::-webkit-scrollbar-thumb { background-color: #3498eb; border-radius: 4px; }
        .max-h-96::-webkit-scrollbar-track { background-color: #f1f1f1; }
    </style>

    <!-- Firebase SDK-k -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase és globális változók inicializálása
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-rezsi-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Hibakeresési logolás bekapcsolása
        
        let currentUserId = null;
        let unsubscribeItems = () => {}; // onSnapshot leiratkozó
        let unsubscribeManagedCategories = () => {}; // onSnapshot leiratkozó

        // DOM elemek
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const itemForm = document.getElementById('item-form');
        const managedCategoryForm = document.getElementById('managed-category-form');
        
        // Segédfüggvények
        
        /**
         * Elrejti a betöltő képernyőt és megjeleníti a fő tartalmat.
         * Fontos: Ezt futtatni kell siker ÉS hiba esetén is!
         */
        function hideLoadingScreen() {
            loadingOverlay.classList.add('opacity-0');
            loadingOverlay.addEventListener('transitionend', () => {
                loadingOverlay.style.display = 'none';
                mainContent.style.display = 'block';
            }, { once: true });
        }

        /**
         * Megjeleníti az egyéni hibaüzenet modált.
         * @param {string} title A hiba címe
         * @param {string} message A hiba részletes leírása
         */
        function showErrorModal(title, message) {
            document.getElementById('error-modal-title').textContent = title;
            document.getElementById('error-modal-body').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        /**
         * Elrejti az összes modált.
         */
        function hideAllModals() {
            document.getElementById('add-item-modal').classList.add('hidden');
            document.getElementById('managed-categories-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.add('hidden');
            // Alaphelyzetbe állítás a modálok elrejtése után (opcionális)
            if(itemForm) itemForm.reset();
            if(managedCategoryForm) managedCategoryForm.reset();
        }

        /**
         * Egyedi értesítések megjelenítése (pl. sikeres mentés)
         * @param {string} message Az üzenet
         */
        function showNotification(message) {
            const notification = document.getElementById('notification-banner');
            notification.textContent = message;
            notification.classList.remove('hidden');
            notification.classList.add('opacity-100');
            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
        }

        /**
         * Adatútvonalak
         */
        const paths = {
            userItems: (uid) => `artifacts/${appId}/users/${uid}/items`,
            managedCategories: (uid) => `artifacts/${appId}/users/${uid}/managedCategories`,
            metadata: (uid) => `artifacts/${appId}/users/${uid}/metadata/general`
        };

        /**
         * Adatok letöltése és valós idejű figyelése.
         */
        function listenForData() {
            if (!currentUserId) {
                console.error("Hiba: currentUserId nincs beállítva. Az adatlekérdezés leáll.");
                return;
            }

            // 1. Költség tételek figyelése
            const itemsRef = collection(db, paths.userItems(currentUserId));
            // Feliratkozás megszüntetése, ha már volt korábban
            unsubscribeItems(); 
            unsubscribeItems = onSnapshot(itemsRef, (snapshot) => {
                try {
                    const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderItems(items);
                    updateSummary(items);
                } catch (e) {
                    console.error("Hiba az elemek betöltésekor:", e);
                    showErrorModal("Adatbetöltési Hiba", "Nem sikerült betölteni a kiadásokat. Ellenőrizd az internetkapcsolatot.");
                }
            }, (error) => {
                console.error("Hiba az onSnapshot items-nél:", error);
                showErrorModal("Valós idejű Hiba", "Az adatok figyelése megszakadt. Kérlek, indítsd újra az alkalmazást.");
            });

            // 2. Kezelt kategóriák figyelése
            const categoriesRef = collection(db, paths.managedCategories(currentUserId));
            unsubscribeManagedCategories();
            unsubscribeManagedCategories = onSnapshot(categoriesRef, (snapshot) => {
                try {
                    const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderManagedCategories(categories);
                    populateCategoryDropdown(categories);
                } catch (e) {
                    console.error("Hiba a kategóriák betöltésekor:", e);
                }
            }, (error) => {
                console.error("Hiba az onSnapshot categories-nél:", error);
            });
        }
        
        /**
         * Firebase Autentikáció indítása.
         */
        async function initAuth() {
            console.log("Firebase Autentikáció indítása...");
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Firebase: Egyedi token sikeres bejelentkezés.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase: Anonim bejelentkezés (Fallback).");
                }
            } catch (error) {
                console.error("Firebase Auth hiba:", error);
                // Fontos: Hiba esetén is el kell tüntetni a töltőképernyőt!
                hideLoadingScreen(); 
                showErrorModal("Hitelesítési Hiba", "Nem sikerült bejelentkezni a Firebase-be. Kérlek, próbáld újra.");
            }
        }

        // --- Adatkezelő függvények (rövidítve) ---
        // (A többi saveItem, deleteItem, saveManagedCategory, renderItems, updateSummary,
        //  handleNewMonthGeneration, etc. változatlanul maradt, csak itt a lényeges részeket hagytam meg.)

        async function saveItem(e) { /* ... */ }
        async function deleteItem(id) { /* ... */ }
        async function saveManagedCategory(e) { /* ... */ }
        function openAddModal(isEdit = false, item = null) { /* ... */ }
        function renderItems(items) { /* ... */ }
        function updateSummary(items) { /* ... */ }
        function renderManagedCategories(categories) { /* ... */ }
        function populateCategoryDropdown(categories) { /* ... */ }
        async function handleNewMonthGeneration() { /* ... */ }


        // --- FŐ LOGIKA ---

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                
                // Sikeres bejelentkezés után elrejtjük a töltőképernyőt
                hideLoadingScreen();
                
                listenForData();
                handleNewMonthGeneration(); // Rendszeres tételek ellenőrzése és generálása
            } else {
                console.log("Hiba: Az onAuthStateChanged nem kapott felhasználót.");
                // Bármi is volt a probléma, ha idáig jutottunk, de nincs user, eltüntetjük a loadingot.
                hideLoadingScreen();
                // Opcionálisan egy hibaüzenet, ha az initAuth nem dobott kivételt, de mégis anonim maradt.
            }
        });

        // Eseménykezelők
        document.getElementById('open-add-modal-btn').addEventListener('click', () => openAddModal(false, null));
        document.getElementById('open-managed-categories-btn').addEventListener('click', () => {
            document.getElementById('managed-categories-modal').classList.remove('hidden');
        });
        document.getElementById('item-form').addEventListener('submit', saveItem);
        document.getElementById('managed-category-form').addEventListener('submit', saveManagedCategory);
        document.getElementById('sign-out-btn').addEventListener('click', async () => {
            await signOut(auth);
            location.reload(); // Újratöltés, hogy újrainduljon a hitelesítés
        });

        // Első lépés: Autentikáció indítása
        initAuth();

    </script>
    
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- 1. Betöltő Képernyő (Loading Overlay) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center transition-opacity duration-500 z-50">
        <svg class="loading-spin w-12 h-12 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg font-semibold text-gray-700">Adatok betöltése és hitelesítés...</p>
        <p class="text-sm text-gray-500 mt-2">Kérlek, várj türelmesen.</p>
    </div>

    <!-- 2. Fő Tartalom (Main Content) - Kezdetben rejtve -->
    <div id="main-content" class="hidden p-4 md:p-8 max-w-4xl mx-auto">

        <!-- Értesítési Banner -->
        <div id="notification-banner" class="hidden fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50" role="alert">
            <!-- Üzenet ide kerül -->
        </div>

        <header class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-extrabold text-blue-800">Rezsi Nyilvántartó</h1>
                <div class="flex space-x-2">
                    <button id="open-managed-categories-btn" class="p-3 bg-yellow-500 text-white rounded-xl shadow-md hover:bg-yellow-600 transition duration-150 transform hover:scale-105" title="Kezelt kategóriák">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </button>
                    <button id="sign-out-btn" class="p-3 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 transition duration-150 transform hover:scale-105" title="Kijelentkezés">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-500">Felhasználói ID: <span id="user-id-display" class="font-mono text-xs">...</span></p>
        </header>

        <!-- Összegzés szekció -->
        <section class="bg-white p-6 rounded-2xl shadow-xl mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Összesített Költségek</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-xl text-center">
                    <p class="text-sm font-medium text-blue-600">Összes Kiadás</p>
                    <p id="total-spent" class="text-2xl font-extrabold text-blue-800 mt-1">0 Ft</p>
                </div>
                <div class="p-4 bg-green-50 rounded-xl text-center">
                    <p class="text-sm font-medium text-green-600">Havi Kiadás</p>
                    <p id="monthly-spent" class="text-2xl font-extrabold text-green-800 mt-1">0 Ft</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-xl text-center">
                    <p class="text-sm font-medium text-yellow-600">Legutóbbi Hónap</p>
                    <p id="last-month-spent" class="text-2xl font-extrabold text-yellow-800 mt-1">0 Ft</p>
                </div>
            </div>
        </section>

        <!-- Költségek listája és Hozzáadás gomb -->
        <section class="bg-white p-6 rounded-2xl shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-700">Tételek Listája</h2>
                <button id="open-add-modal-btn" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    Új Tétel
                </button>
            </div>
            
            <div id="items-list" class="space-y-4">
                <!-- Tételek ide kerülnek renderelésre -->
                <p id="no-items-message" class="text-gray-500 text-center py-8">Még nincsenek felvett tételek.</p>
            </div>
        </section>
    </div>

    <!-- MODÁLOK -->

    <!-- 1. Hozzáadás/Szerkesztés Modál -->
    <div id="add-item-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="item-modal-title" class="text-2xl font-bold text-blue-600 mb-4">Új Tétel Hozzáadása</h2>
            <form id="item-form" class="space-y-4">
                <input type="hidden" id="item-id">
                
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Kategória</label>
                    <select id="category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        <!-- Kezelt kategóriák ide kerülnek -->
                    </select>
                </div>

                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Leírás / Megjegyzés</label>
                    <input type="text" id="description" placeholder="Pl.: Januári gázszámla" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>
                
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Összeg (Ft)</label>
                    <input type="number" id="amount" placeholder="Pl.: 25000" min="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>

                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">Dátum</label>
                    <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                    <button type="submit" id="save-item-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Kezelt Kategóriák Modál -->
    <div id="managed-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">Rendszeres Költség Kezelése</h2>
            
            <!-- Új Kategória Hozzáadása Form -->
            <form id="managed-category-form" class="bg-gray-50 p-4 rounded-xl shadow-inner mb-6">
                <input type="hidden" id="managed-category-id">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
                    <div class="md:col-span-1">
                        <label for="managed-name" class="block text-sm font-medium text-gray-700">Kategória neve</label>
                        <input type="text" id="managed-name" placeholder="Pl.: Lakásbérlet" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                    </div>
                    <div class="md:col-span-2">
                        <label for="managed-description" class="block text-sm font-medium text-gray-700">Alap leírás</label>
                        <input type="text" id="managed-description" placeholder="Pl.: Havi lakásbérleti díj" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                    </div>
                    <div class="md:col-span-1">
                        <label for="managed-amount" class="block text-sm font-medium text-gray-700">Alap összeg (Ft)</label>
                        <input type="number" id="managed-amount" placeholder="Pl.: 150000" min="1" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                    </div>
                </div>
                <div class="flex justify-end mt-3">
                    <button type="submit" id="save-managed-category-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">Mentés/Hozzáadás</button>
                </div>
            </form>

            <h3 class="text-xl font-bold text-gray-700 mb-2">Kezelt Kategóriák</h3>
            <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/törölheted a rendszeresen ismétlődő tételeket.</p>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kategória lista ide kerül renderelésre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- 3. Megerősítő Modál -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4">Törlés Megerősítése</h2>
            <p id="confirm-modal-body" class="text-gray-700 mb-6">Biztosan törölni szeretnéd ezt a tételt?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Mégsem</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Törlés</button>
            </div>
        </div>
    </div>

    <!-- 4. Hibaüzenet Modál (ÚJ) -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center border-t-4 border-red-500">
            <h2 id="error-modal-title" class="text-xl font-bold text-red-600 mb-4">Hiba Történt</h2>
            <p id="error-modal-body" class="text-gray-700 mb-6">Ismeretlen hiba az alkalmazásban.</p>
            <div class="flex justify-center">
                <button onclick="hideAllModals()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700">Rendben</button>
            </div>
        </div>
    </div>
    
</body>
</html>

<script type="module">
    // A teljes JavaScript tartalom újra beillesztve, a módosított initAuth és a segédfüggvényekkel (showErrorModal, hideLoadingScreen).
    // FONTOS: Mivel a Canvas korlátozottan támogatja a fájl összevonást, a teljes kódot újra generálom, 
    // hogy a fenti HTML is a helyes legyen, és minden függvény elérhető legyen a body alatti <script> tagben.

    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase és globális változók inicializálása
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-rezsi-app';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('debug'); 
    
    let currentUserId = null;
    let unsubscribeItems = () => {};
    let unsubscribeManagedCategories = () => {};

    // DOM elemek
    const userIdDisplay = document.getElementById('user-id-display');
    const loadingOverlay = document.getElementById('loading-overlay');
    const mainContent = document.getElementById('main-content');
    const itemsList = document.getElementById('items-list');
    const managedCategoriesList = document.getElementById('managed-categories-list');
    const categoryDropdown = document.getElementById('category');
    const itemForm = document.getElementById('item-form');
    const managedCategoryForm = document.getElementById('managed-category-form');
    const noItemsMessage = document.getElementById('no-items-message');
    const totalSpentEl = document.getElementById('total-spent');
    const monthlySpentEl = document.getElementById('monthly-spent');
    const lastMonthSpentEl = document.getElementById('last-month-spent');
    const confirmModalTitle = document.getElementById('confirm-modal-title');
    const confirmModalBody = document.getElementById('confirm-modal-body');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const itemModalTitle = document.getElementById('item-modal-title');

    // --- Segédfüggvények ---
    
    /**
     * Elrejti a betöltő képernyőt és megjeleníti a fő tartalmat.
     */
    window.hideLoadingScreen = function() {
        loadingOverlay.classList.add('opacity-0');
        loadingOverlay.addEventListener('transitionend', () => {
            loadingOverlay.style.display = 'none';
            mainContent.style.display = 'block';
        }, { once: true });
    }

    /**
     * Megjeleníti az egyéni hibaüzenet modált.
     * @param {string} title A hiba címe
     * @param {string} message A hiba részletes leírása
     */
    window.showErrorModal = function(title, message) {
        document.getElementById('error-modal-title').textContent = title;
        document.getElementById('error-modal-body').textContent = message;
        document.getElementById('error-modal').classList.remove('hidden');
        window.hideLoadingScreen(); // Fontos: hiba esetén is el kell rejteni a loadingot
    }

    /**
     * Elrejti az összes modált.
     */
    window.hideAllModals = function() {
        document.getElementById('add-item-modal').classList.add('hidden');
        document.getElementById('managed-categories-modal').classList.add('hidden');
        document.getElementById('confirmation-modal').classList.add('hidden');
        document.getElementById('error-modal').classList.add('hidden');
        // Alaphelyzetbe állítás a modálok elrejtése után
        if(itemForm) itemForm.reset();
        if(managedCategoryForm) managedCategoryForm.reset();
        document.getElementById('item-id').value = ''; // Szerkesztés ID törlése
        document.getElementById('managed-category-id').value = ''; // Szerkesztés ID törlése
    }

    /**
     * Egyedi értesítések megjelenítése (pl. sikeres mentés)
     * @param {string} message Az üzenet
     */
    function showNotification(message) {
        const notification = document.getElementById('notification-banner');
        notification.textContent = message;
        notification.classList.remove('hidden', 'opacity-0');
        notification.classList.add('opacity-100');
        setTimeout(() => {
            notification.classList.remove('opacity-100');
            notification.classList.add('opacity-0');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 3000);
    }

    /**
     * Adatútvonalak
     */
    const paths = {
        userItems: (uid) => `artifacts/${appId}/users/${uid}/items`,
        managedCategories: (uid) => `artifacts/${appId}/users/${uid}/managedCategories`,
        metadata: (uid) => `artifacts/${appId}/users/${uid}/metadata/general`
    };

    /**
     * Firebase Autentikáció indítása.
     */
    async function initAuth() {
        console.log("Firebase Autentikáció indítása...");
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Firebase: Egyedi token sikeres bejelentkezés.");
            } else {
                await signInAnonymously(auth);
                console.log("Firebase: Anonim bejelentkezés (Fallback).");
            }
        } catch (error) {
            console.error("Firebase Auth hiba:", error);
            // Fontos: Hiba esetén is el kell tűntetni a töltőképernyőt!
            window.hideLoadingScreen(); 
            window.showErrorModal("Hitelesítési Hiba", "Nem sikerült bejelentkezni a Firebase-be. Kérlek, ellenőrizd a konzolt a részletekért.");
        }
    }

    /**
     * Adatok letöltése és valós idejű figyelése.
     */
    function listenForData() {
        if (!currentUserId) {
            console.error("Hiba: currentUserId nincs beállítva. Az adatlekérdezés leáll.");
            return;
        }

        // 1. Költség tételek figyelése
        const itemsRef = collection(db, paths.userItems(currentUserId));
        unsubscribeItems(); 
        unsubscribeItems = onSnapshot(itemsRef, (snapshot) => {
            try {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems(items);
                updateSummary(items);
            } catch (e) {
                console.error("Hiba az elemek betöltésekor:", e);
                window.showErrorModal("Adatbetöltési Hiba", "Nem sikerült betölteni a kiadásokat. Ellenőrizd az internetkapcsolatot.");
            }
        }, (error) => {
            console.error("Hiba az onSnapshot items-nél:", error);
            window.showErrorModal("Valós idejű Hiba", "Az adatok figyelése megszakadt. Kérlek, indítsd újra az alkalmazást.");
        });

        // 2. Kezelt kategóriák figyelése
        const categoriesRef = collection(db, paths.managedCategories(currentUserId));
        unsubscribeManagedCategories();
        unsubscribeManagedCategories = onSnapshot(categoriesRef, (snapshot) => {
            try {
                const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderManagedCategories(categories);
                populateCategoryDropdown(categories);
            } catch (e) {
                console.error("Hiba a kategóriák betöltésekor:", e);
            }
        }, (error) => {
            console.error("Hiba az onSnapshot categories-nél:", error);
        });
    }

    /**
     * Tétel mentése (új/szerkesztés).
     */
    async function saveItem(e) {
        e.preventDefault();
        hideAllModals(); // Előző hiba: nem volt elrejtve a modál mentés után
        const id = document.getElementById('item-id').value;
        const category = document.getElementById('category').value;
        const description = document.getElementById('description').value;
        const amount = parseInt(document.getElementById('amount').value);
        const date = document.getElementById('date').value;

        const newItem = {
            category,
            description,
            amount,
            date,
            createdAt: new Date().toISOString(),
            userId: currentUserId 
        };

        try {
            if (id) {
                const itemRef = doc(db, paths.userItems(currentUserId), id);
                await updateDoc(itemRef, newItem);
                showNotification("Tétel sikeresen frissítve!");
            } else {
                await addDoc(collection(db, paths.userItems(currentUserId)), newItem);
                showNotification("Új tétel sikeresen hozzáadva!");
            }
        } catch (e) {
            console.error("Hiba a tétel mentésekor:", e);
            window.showErrorModal("Mentési Hiba", "Nem sikerült menteni a tételt. Kérlek, próbáld újra.");
        }
    }

    /**
     * Tétel törlése.
     */
    async function deleteItem(id) {
        hideAllModals();
        try {
            await deleteDoc(doc(db, paths.userItems(currentUserId), id));
            showNotification("Tétel sikeresen törölve!");
        } catch (e) {
            console.error("Hiba a tétel törlésekor:", e);
            window.showErrorModal("Törlési Hiba", "Nem sikerült törölni a tételt. Kérlek, próbáld újra.");
        }
    }

    /**
     * Tétel szerkesztési modál megnyitása
     */
    function openAddModal(isEdit = false, item = null) {
        document.getElementById('add-item-modal').classList.remove('hidden');

        if (isEdit && item) {
            itemModalTitle.textContent = "Tétel Szerkesztése";
            document.getElementById('item-id').value = item.id;
            document.getElementById('category').value = item.category || '';
            document.getElementById('description').value = item.description || '';
            document.getElementById('amount').value = item.amount || '';
            document.getElementById('date').value = item.date || new Date().toISOString().substring(0, 10);
            document.getElementById('save-item-btn').textContent = "Frissítés";
        } else {
            itemModalTitle.textContent = "Új Tétel Hozzáadása";
            document.getElementById('item-id').value = '';
            document.getElementById('category').value = categoryDropdown.options.length > 0 ? categoryDropdown.options[0].value : '';
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('save-item-btn').textContent = "Mentés";
        }
    }

    /**
     * Tétel lista renderelése.
     */
    function renderItems(items) {
        itemsList.innerHTML = '';

        if (items.length === 0) {
            noItemsMessage.classList.remove('hidden');
            return;
        }

        noItemsMessage.classList.add('hidden');
        
        // Dátum szerint csökkenő sorrend (legújabb elöl)
        items.sort((a, b) => new Date(b.date) - new Date(a.date));

        items.forEach(item => {
            const dateStr = new Date(item.date).toLocaleDateString('hu-HU', { year: 'numeric', month: 'short', day: 'numeric' });
            
            const itemElement = document.createElement('div');
            itemElement.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl shadow-sm hover:shadow-md transition duration-150';
            itemElement.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-semibold text-gray-800">${item.category}</span>
                    <span class="text-sm text-gray-600">${item.description}</span>
                    <span class="text-xs text-gray-400 mt-1">${dateStr}</span>
                </div>
                <div class="flex items-center space-x-3">
                    <span class="text-lg font-bold text-red-600">${item.amount.toLocaleString('hu-HU')} Ft</span>
                    <button class="text-blue-500 hover:text-blue-700 p-1" onclick="openEditConfirmation('${item.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                    <button class="text-red-500 hover:text-red-700 p-1" onclick="openDeleteConfirmation('${item.id}', '${item.category} - ${item.amount} Ft')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            itemsList.appendChild(itemElement);
        });
    }

    /**
     * Konfirmációs modál megnyitása törléshez.
     */
    window.openDeleteConfirmation = function(id, description) {
        confirmModalTitle.textContent = "Törlés Megerősítése";
        confirmModalBody.textContent = `Biztosan törölni szeretnéd a következő tételt: "${description}"? Ez a művelet visszavonhatatlan.`;
        confirmDeleteBtn.onclick = () => deleteItem(id);
        document.getElementById('confirmation-modal').classList.remove('hidden');
    }

    /**
     * Konfirmációs modál megnyitása szerkesztéshez.
     */
    window.openEditConfirmation = async function(id) {
        try {
            const docSnap = await getDoc(doc(db, paths.userItems(currentUserId), id));
            if (docSnap.exists()) {
                openAddModal(true, { id, ...docSnap.data() });
            } else {
                showNotification("A tétel már nem létezik.");
            }
        } catch (e) {
            console.error("Hiba a tétel lekérdezésekor szerkesztéshez:", e);
            window.showErrorModal("Szerkesztési Hiba", "Nem sikerült betölteni a tétel adatait.");
        }
    }

    /**
     * Összegzések frissítése.
     */
    function updateSummary(items) {
        const totalSpent = items.reduce((sum, item) => sum + item.amount, 0);
        totalSpentEl.textContent = `${totalSpent.toLocaleString('hu-HU')} Ft`;

        const now = new Date();
        const currentMonth = now.getFullYear() * 12 + now.getMonth();
        const lastMonth = currentMonth - 1;

        const monthlySpent = items
            .filter(item => {
                const itemDate = new Date(item.date);
                const itemMonth = itemDate.getFullYear() * 12 + itemDate.getMonth();
                return itemMonth === currentMonth;
            })
            .reduce((sum, item) => sum + item.amount, 0);
        monthlySpentEl.textContent = `${monthlySpent.toLocaleString('hu-HU')} Ft`;

        const lastMonthSpent = items
            .filter(item => {
                const itemDate = new Date(item.date);
                const itemMonth = itemDate.getFullYear() * 12 + itemDate.getMonth();
                return itemMonth === lastMonth;
            })
            .reduce((sum, item) => sum + item.amount, 0);
        lastMonthSpentEl.textContent = `${lastMonthSpent.toLocaleString('hu-HU')} Ft`;
    }

    /**
     * Kezelt kategóriák renderelése.
     */
    function renderManagedCategories(categories) {
        managedCategoriesList.innerHTML = '';
        categories.forEach(cat => {
            const categoryElement = document.createElement('div');
            categoryElement.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-md';
            categoryElement.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-semibold text-gray-800">${cat.name}</span>
                    <span class="text-sm text-gray-600">${cat.description}</span>
                    <span class="text-md font-bold text-red-500">${cat.amount.toLocaleString('hu-HU')} Ft</span>
                </div>
                <div class="flex space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 p-1" onclick="openEditManagedCategoryConfirmation('${cat.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                    </button>
                    <button class="text-red-500 hover:text-red-700 p-1" onclick="openDeleteManagedCategoryConfirmation('${cat.id}', '${cat.name}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            managedCategoriesList.appendChild(categoryElement);
        });
    }

    /**
     * Kategória legördülő lista feltöltése.
     */
    function populateCategoryDropdown(categories) {
        categoryDropdown.innerHTML = '';
        if (categories.length === 0) {
             const defaultOption = document.createElement('option');
             defaultOption.value = "Egyéb";
             defaultOption.textContent = "Egyéb";
             categoryDropdown.appendChild(defaultOption);
             return;
        }

        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            categoryDropdown.appendChild(option);
        });
    }

    /**
     * Rendszeres Kategória mentése (új/szerkesztés).
     */
    async function saveManagedCategory(e) {
        e.preventDefault();
        const id = document.getElementById('managed-category-id').value;
        const name = document.getElementById('managed-name').value;
        const description = document.getElementById('managed-description').value;
        const amount = parseInt(document.getElementById('managed-amount').value);

        const newCategory = {
            name,
            description,
            amount,
            updatedAt: new Date().toISOString(),
            userId: currentUserId
        };

        try {
            if (id) {
                const catRef = doc(db, paths.managedCategories(currentUserId), id);
                await updateDoc(catRef, newCategory);
                showNotification("Kategória sikeresen frissítve!");
            } else {
                await addDoc(collection(db, paths.managedCategories(currentUserId)), newCategory);
                showNotification("Új kategória sikeresen hozzáadva!");
            }
            managedCategoryForm.reset();
            document.getElementById('managed-category-id').value = '';
        } catch (e) {
            console.error("Hiba a kategória mentésekor:", e);
            window.showErrorModal("Kategória Mentési Hiba", "Nem sikerült menteni a kategóriát. Kérlek, próbáld újra.");
        }
    }

    /**
     * Rendszeres Kategória törlése.
     */
    async function deleteManagedCategory(id) {
        hideAllModals();
        try {
            await deleteDoc(doc(db, paths.managedCategories(currentUserId), id));
            showNotification("Kategória sikeresen törölve!");
        } catch (e) {
            console.error("Hiba a kategória törlésekor:", e);
            window.showErrorModal("Kategória Törlési Hiba", "Nem sikerült törölni a kategóriát. Kérlek, próbáld újra.");
        }
    }

    /**
     * Rendszeres Kategória szerkesztési modál megnyitása.
     */
    window.openEditManagedCategoryConfirmation = async function(id) {
        try {
            const docSnap = await getDoc(doc(db, paths.managedCategories(currentUserId), id));
            if (docSnap.exists()) {
                const cat = docSnap.data();
                document.getElementById('managed-category-id').value = id;
                document.getElementById('managed-name').value = cat.name;
                document.getElementById('managed-description').value = cat.description;
                document.getElementById('managed-amount').value = cat.amount;
            } else {
                showNotification("A kategória már nem létezik.");
            }
        } catch (e) {
            console.error("Hiba a kategória lekérdezésekor szerkesztéshez:", e);
        }
    }
    
    /**
     * Rendszeres Kategória törlés megerősítő modál megnyitása.
     */
    window.openDeleteManagedCategoryConfirmation = function(id, name) {
        confirmModalTitle.textContent = "Kategória Törlése";
        confirmModalBody.textContent = `Biztosan törölni szeretnéd a(z) "${name}" rendszeres kategóriát? Ezzel nem törlődnek a már létrehozott tételek.`;
        confirmDeleteBtn.onclick = () => deleteManagedCategory(id);
        document.getElementById('confirmation-modal').classList.remove('hidden');
    }

    /**
     * Ellenőrzi és generálja a rendszeres tételeket az új hónapra.
     */
    async function handleNewMonthGeneration() {
        if (!currentUserId) return;
        const metadataRef = doc(db, paths.metadata(currentUserId));
        
        try {
            const metadataSnap = await getDoc(metadataRef);
            const lastGenerationDate = metadataSnap.exists() ? metadataSnap.data().lastGenerationDate : null;
            const now = new Date();
            const currentMonthYear = `${now.getFullYear()}-${now.getMonth()}`;

            if (lastGenerationDate === currentMonthYear) {
                console.log("Rendszeres tételek már generálva ebben a hónapban.");
                return;
            }

            console.log("Új hónap! Rendszeres tételek generálása...");
            const categoriesRef = collection(db, paths.managedCategories(currentUserId));
            const categorySnapshot = await getDocs(categoriesRef);

            const batch = [];
            categorySnapshot.forEach(docSnap => {
                const cat = docSnap.data();
                const newItem = {
                    category: cat.name,
                    description: `${cat.description} (${now.getFullYear()}. ${now.getMonth() + 1}. hó)`,
                    amount: cat.amount,
                    date: new Date(now.getFullYear(), now.getMonth(), 1).toISOString().substring(0, 10), // A hónap eleje
                    createdAt: new Date().toISOString(),
                    userId: currentUserId
                };
                batch.push(addDoc(collection(db, paths.userItems(currentUserId)), newItem));
            });

            if (batch.length > 0) {
                await Promise.all(batch);
                showNotification(`${batch.length} db rendszeres tétel sikeresen generálva!`);
            } else {
                console.log("Nincs rendszeres tétel kategória a generáláshoz.");
            }

            // Frissítjük a generálás dátumát
            await setDoc(metadataRef, { lastGenerationDate: currentMonthYear }, { merge: true });

        } catch (e) {
            console.error("Hiba a rendszeres tételek generálásakor:", e);
            window.showErrorModal("Automatikus Generálási Hiba", "Nem sikerült generálni a rendszeres tételeket.");
        }
    }


    // --- FŐ LOGIKA VÉGREHAJTÁSA ---

    // Auth State Listener
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserId = user.uid;
            userIdDisplay.textContent = currentUserId;
            
            // Sikeres bejelentkezés után elrejtjük a töltőképernyőt
            window.hideLoadingScreen();
            
            listenForData();
            handleNewMonthGeneration(); // Rendszeres tételek ellenőrzése és generálása
        } else {
            console.log("Hiba: Az onAuthStateChanged nem kapott felhasználót.");
            // Bármi is volt a probléma, ha idáig jutottunk, de nincs user, eltüntetjük a loadingot.
            window.hideLoadingScreen();
            // A hibaüzenet megjelenik az initAuth() catch blokkjában, ha az dobott kivételt.
            // Itt csak akkor jelezzük, ha a listener futott le felhasználó nélkül (ami ritka).
            if (!document.getElementById('error-modal').classList.contains('hidden')) {
                 window.showErrorModal("Autentikációs Figyelmeztetés", "A bejelentkezés sikertelen volt. Kérlek, ellenőrizd a konzolt.");
            }
        }
    });

    // Eseménykezelők
    document.getElementById('open-add-modal-btn').addEventListener('click', () => openAddModal(false, null));
    document.getElementById('open-managed-categories-btn').addEventListener('click', () => {
        document.getElementById('managed-categories-modal').classList.remove('hidden');
    });
    document.getElementById('item-form').addEventListener('submit', saveItem);
    document.getElementById('managed-category-form').addEventListener('submit', saveManagedCategory);
    document.getElementById('sign-out-btn').addEventListener('click', async () => {
        try {
            await signOut(auth);
            location.reload(); // Újratöltés, hogy újrainduljon a hitelesítés
        } catch (e) {
            console.error("Kijelentkezési hiba:", e);
            window.showErrorModal("Kijelentkezési Hiba", "Nem sikerült kijelentkezni. Kérlek, próbáld újra.");
        }
    });

    // Első lépés: Autentikáció indítása
    initAuth();

</script>
