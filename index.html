<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Költségkövető</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: border-color 0.15s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #4c51bf;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.1);
        }
        .btn-primary {
            background-color: #4c51bf;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #3b42a8;
        }
        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
        }
        .message-box.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Rezsi Költségkövető</h1>
            <p class="text-sm text-gray-500">Felhasználói Azonosító: <span id="user-id-display">Betöltés...</span></p>
        </header>

        <!-- Beállítások Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Beállítások</h2>
            <form id="settings-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="currency">Pénznem</label>
                    <select id="currency" name="currency">
                        <option value="HUF">HUF (Forint)</option>
                        <option value="EUR">EUR (Euro)</option>
                        <option value="USD">USD (Dollár)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="base-cost">Alapdíj (havi)</label>
                    <input type="number" id="base-cost" name="base-cost" placeholder="Pl. 10000" step="100" required>
                </div>
                <div class="input-group">
                    <label for="heating-type">Fűtés Típus</label>
                    <select id="heating-type" name="heating-type">
                        <option value="gas">Gáz</option>
                        <option value="electric">Elektromos</option>
                        <option value="district">Távfűtés</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="btn-primary w-full">Beállítások Mentése</button>
                </div>
            </form>
            <div id="settings-message-box" class="message-box hidden mt-4"></div>
        </div>

        <!-- Fogyasztás Rögzítése Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Fogyasztás Rögzítése</h2>
            <form id="consumption-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="input-group">
                    <label for="utility-type">Közüzemi Típus</label>
                    <select id="utility-type" name="utility-type">
                        <option value="electric">Villany</option>
                        <option value="gas">Gáz</option>
                        <option value="water">Víz</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="consumption-amount">Fogyasztás (egység)</label>
                    <input type="number" id="consumption-amount" name="consumption-amount" placeholder="Pl. 150 kWh" step="0.1" required>
                </div>
                <div class="input-group">
                    <label for="price-per-unit">Egységár</label>
                    <input type="number" id="price-per-unit" name="price-per-unit" placeholder="Pl. 36.5 Ft/kWh" step="0.01" required>
                </div>
                <div class="input-group md:col-span-3">
                    <label for="consumption-date">Dátum</label>
                    <input type="date" id="consumption-date" name="consumption-date" required>
                </div>
                <div class="md:col-span-3">
                    <button type="submit" class="btn-primary w-full">Fogyasztás Mentése</button>
                </div>
            </form>
            <div id="consumption-message-box" class="message-box hidden mt-4"></div>
        </div>

        <!-- Kimutatások Szekció -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Kimutatások</h2>
            <div id="summary-display" class="space-y-3">
                <p>Összes Fogyasztás (Villany): <span id="total-electric" class="font-bold">0</span></p>
                <p>Összes Fogyasztás (Gáz): <span id="total-gas" class="font-bold">0</span></p>
                <p>Összes Fogyasztás (Víz): <span id="total-water" class="font-bold">0</span></p>
                <p class="text-lg font-bold">Becsült Havi Költség: <span id="estimated-cost" class="text-green-600">0 HUF</span></p>
            </div>

            <div class="mt-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Fogyasztási Előzmények</h3>
                <ul id="consumption-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- A lista elem ide kerül -->
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase inicializálás
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Debug naplózás bekapcsolása
        setLogLevel('debug');

        if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Hitelesítés beállítása és felhasználói azonosító lekérése
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    console.log("Firestore Auth sikeres. UID:", userId);
                    isAuthReady = true;
                    // Auth után betölthetjük az adatokat
                    await loadData();
                } else {
                    // Bejelentkezés egyedi tokenen keresztül, vagy anonim bejelentkezés
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase hitelesítési hiba:", error);
                        document.getElementById('user-id-display').textContent = 'Hiba a hitelesítésben';
                    }
                }
            });
        } else {
            console.error("Firebase konfiguráció hiányzik vagy érvénytelen.");
            document.getElementById('user-id-display').textContent = 'Hiba: Nincs Firebase Config';
        }

        // Segédfüggvény: Dokumentumhivatkozás lekérése a privát beállításokhoz
        const getSettingsDocRef = (db, userId, appId) => {
            // JAVÍTVA: A settings gyűjteményben lévő 'general' dokumentumra mutat.
            // Útvonal: artifacts / {appId} / users / {userId} / settings / general (collection/doc/collection/doc/collection/doc)
            return doc(db, 'artifacts', appId, 'users', userId, 'settings', 'general');
        };

        // Segédfüggvény: Gyűjteményhivatkozás lekérése a fogyasztásokhoz
        const getConsumptionCollectionRef = (db, userId, appId) => {
            // Útvonal: artifacts / {appId} / users / {userId} / consumptions (collection/doc/collection/doc/collection)
            return collection(db, 'artifacts', appId, 'users', userId, 'consumptions');
        };

        // Segédfüggvény: Üzenet megjelenítése a felületen
        const showMessage = (elementId, message, isError = false) => {
            const box = document.getElementById(elementId);
            box.textContent = message;
            box.classList.remove('hidden', 'success', 'error');
            box.classList.add(isError ? 'error' : 'success');
            setTimeout(() => box.classList.add('hidden'), 5000);
        };

        // Alapértelmezett beállítások (ha még nincs adat)
        const defaultSettings = {
            currency: 'HUF',
            baseCost: 10000,
            heatingType: 'gas'
        };

        let currentSettings = { ...defaultSettings };
        let consumptionData = [];

        // 2. Adatok betöltése és valós idejű figyelése
        const loadData = async () => {
            if (!isAuthReady || !userId) {
                console.warn("Az Auth még nem készült el, kihagyva az adatbetöltést.");
                return;
            }

            console.log("Adatok betöltése indítása...");

            const settingsRef = getSettingsDocRef(db, userId, appId);
            const consumptionsRef = getConsumptionCollectionRef(db, userId, appId);

            // A. Beállítások figyelése (onSnapshot)
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentSettings = { ...defaultSettings, ...docSnap.data() };
                    console.log("Beállítások betöltve:", currentSettings);
                    // Beállítások frissítése a felületen
                    document.getElementById('currency').value = currentSettings.currency || defaultSettings.currency;
                    document.getElementById('base-cost').value = currentSettings.baseCost || defaultSettings.baseCost;
                    document.getElementById('heating-type').value = currentSettings.heatingType || defaultSettings.heatingType;
                } else {
                    console.log("Nincsenek mentett beállítások. Az alapértelmezettek használata.");
                    // Mégis frissítsük a felületet az alapértelmezettel
                    document.getElementById('currency').value = defaultSettings.currency;
                    document.getElementById('base-cost').value = defaultSettings.baseCost;
                    document.getElementById('heating-type').value = defaultSettings.heatingType;
                }
                // Újraszámolás a frissített beállításokkal
                updateSummary();
            }, (error) => {
                console.error("Hiba a beállítások figyelésekor:", error);
                showMessage('settings-message-box', 'Hiba a beállítások betöltésekor.', true);
            });

            // B. Fogyasztások figyelése (onSnapshot)
            onSnapshot(consumptionsRef, (snapshot) => {
                consumptionData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    consumptionData.push({
                        id: doc.id,
                        ...data,
                        // Átalakítás: A Firestore Timestamp objektumot Date-re
                        date: data.date && data.date.toDate ? data.date.toDate() : new Date(data.date),
                        // Biztosítsuk, hogy a numerikus értékek számok legyenek
                        amount: Number(data.amount) || 0,
                        price: Number(data.price) || 0
                    });
                });
                console.log("Fogyasztási adatok betöltve:", consumptionData.length, "elem");
                updateSummary();
                renderConsumptionList();
            }, (error) => {
                console.error("Hiba a fogyasztások figyelésekor:", error);
                showMessage('consumption-message-box', 'Hiba a fogyasztási adatok betöltésekor.', true);
            });
        };

        // 3. Beállítások mentése
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !userId) {
                showMessage('settings-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                return;
            }

            const formData = new FormData(e.target);
            const settings = {
                currency: formData.get('currency'),
                baseCost: Number(formData.get('base-cost')),
                heatingType: formData.get('heating-type'),
                // Hozzáadjuk a timestampet az utolsó frissítéshez
                updatedAt: serverTimestamp()
            };

            try {
                const settingsRef = getSettingsDocRef(db, userId, appId);
                // A setDoc felülírja a dokumentumot, ha létezik, létrehozza, ha nem.
                await setDoc(settingsRef, settings, { merge: true });
                showMessage('settings-message-box', 'Beállítások sikeresen elmentve!');
            } catch (error) {
                console.error("Hiba a beállítások mentésekor:", error);
                showMessage('settings-message-box', `Hiba a mentéskor: ${error.message}`, true);
            }
        });

        // 4. Fogyasztás rögzítése
        document.getElementById('consumption-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !userId) {
                showMessage('consumption-message-box', 'Hiba: A felhasználó nincs hitelesítve.', true);
                return;
            }

            const formData = new FormData(e.target);
            const dateStr = formData.get('consumption-date');
            const consumption = {
                type: formData.get('utility-type'),
                amount: Number(formData.get('consumption-amount')),
                price: Number(formData.get('price-per-unit')),
                // Dátum objektum mentése Firestore Timestampként
                date: new Date(dateStr),
                createdAt: serverTimestamp()
            };

            if (isNaN(consumption.amount) || isNaN(consumption.price)) {
                showMessage('consumption-message-box', 'Kérjük, érvényes számokat adjon meg.', true);
                return;
            }

            try {
                const consumptionsRef = getConsumptionCollectionRef(db, userId, appId);
                // addDoc hozzáad egy új dokumentumot a gyűjteményhez automatikus azonosítóval
                await addDoc(consumptionsRef, consumption);
                showMessage('consumption-message-box', 'Fogyasztás sikeresen rögzítve!');
                e.target.reset(); // Űrlap törlése
            } catch (error) {
                console.error("Hiba a fogyasztás rögzítésekor:", error);
                showMessage('consumption-message-box', `Hiba a rögzítéskor: ${error.message}`, true);
            }
        });

        // 5. Kimutatások frissítése
        const updateSummary = () => {
            let totalElectric = 0;
            let totalGas = 0;
            let totalWater = 0;
            let totalCost = currentSettings.baseCost || defaultSettings.baseCost; // Alapdíj hozzáadása

            consumptionData.forEach(item => {
                const cost = item.amount * item.price;
                totalCost += cost;

                switch (item.type) {
                    case 'electric':
                        totalElectric += item.amount;
                        break;
                    case 'gas':
                        totalGas += item.amount;
                        break;
                    case 'water':
                        totalWater += item.amount;
                        break;
                }
            });

            document.getElementById('total-electric').textContent = `${totalElectric.toFixed(1)} egység`;
            document.getElementById('total-gas').textContent = `${totalGas.toFixed(1)} egység`;
            document.getElementById('total-water').textContent = `${totalWater.toFixed(1)} egység`;

            const currencySymbol = currentSettings.currency || defaultSettings.currency;
            document.getElementById('estimated-cost').textContent = `${totalCost.toLocaleString('hu-HU', { maximumFractionDigits: 0 })} ${currencySymbol}`;
        };

        // 6. Fogyasztási lista megjelenítése
        const renderConsumptionList = () => {
            const listElement = document.getElementById('consumption-list');
            listElement.innerHTML = ''; // Lista törlése

            // Rendezés dátum szerint, legújabb elöl
            const sortedData = consumptionData.sort((a, b) => b.date - a.date);

            if (sortedData.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500 italic">Még nem rögzített fogyasztást.</li>';
                return;
            }

            sortedData.forEach(item => {
                const dateString = item.date.toLocaleDateString('hu-HU');
                const cost = (item.amount * item.price).toFixed(2);
                const currency = currentSettings.currency || defaultSettings.currency;

                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg';
                listItem.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-800">${dateString} - ${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span>
                        <span class="text-sm text-gray-600">${item.amount.toFixed(1)} egység @ ${item.price.toFixed(2)} ${currency}/egység</span>
                    </div>
                    <span class="font-bold text-red-600">${cost} ${currency}</span>
                `;
                listElement.appendChild(listItem);
            });
        };

        // Dátum mező alapértelmezett értéke a mai dátum
        document.getElementById('consumption-date').valueAsDate = new Date();

        // 7. Hitelesítés befejezésének várakozása az adatok betöltése előtt
        // A loadData-t az onAuthStateChanged hívja meg.

    </script>
</body>
</html>
