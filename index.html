<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezsi Nyilv√°ntart√≥ (PWA)</title>
    <!-- PWA MANIFEST √©s T√âMA SZ√çN be√°ll√≠t√°sok a telefonos telep√≠t√©shez -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X2xvY2FsZSI6Imh1IiwibmFtZSI6IlJlenNpIE55aWx2XHUwMGUxbnRcdTAwZjMiLCJzaG9ydF9uYW1lIjoiUmV6c2kgQXBwIiwiZGVzY3JpcHRpb24iOiJHYXogVmlsbGFueSBWXHUwMGUxeiBLXHUwMGY2bHRzXHUwMGU5Z2tcdTAwZjYiLCJzdGFydF91cmwiOiIuL2luZGV4Lmh0bWwiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzM0OThlYiIsImJhY2tncm91bmRfY29sb3IiOiIjZDRlMmYyIiwiaWNvbnMiOiIifQ==">
    <meta name="theme-color" content="#3498eb">
    
    <!-- Tailwind CSS a st√≠lusokhoz -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #3498eb; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2980b9; }
        .modal { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-[100] transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mb-4"></div>
        <p class="text-blue-600 font-semibold">Adatok bet√∂lt√©se √©s hiteles√≠t√©s...</p>
    </div>

    <!-- F≈ë Kont√©ner -->
    <div class="max-w-4xl mx-auto space-y-8" id="main-content" style="display:none;">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800">Rezsi Nyilv√°ntart√≥</h1>
            <p class="text-gray-500 mt-1">K√∂vesd nyomon kiad√°saidat egyszer≈±en</p>
            <p class="text-xs mt-2 text-gray-400">Felhaszn√°l√≥i azonos√≠t√≥ (UserID): <span id="user-id-display" class="font-mono text-xs"></span></p>
        </header>

        <!-- √ñsszegz≈ë K√°rtya -->
        <div class="card p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="text-center p-3 rounded-lg bg-blue-50">
                <p class="text-sm font-medium text-blue-600">√ñsszes t√©tel</p>
                <p id="summary-total-items" class="text-2xl font-bold text-blue-800">0</p>
            </div>
            <div class="text-center p-3 rounded-lg bg-green-50">
                <p class="text-sm font-medium text-green-600">Fizetett √©rt√©k</p>
                <p id="summary-paid-amount" class="text-2xl font-bold text-green-800">0 Ft</p>
            </div>
            <div class="text-center p-3 rounded-lg bg-red-50">
                <p class="text-sm font-medium text-red-600">H√°tral√©k</p>
                <p id="summary-unpaid-amount" class="text-2xl font-bold text-red-800">0 Ft</p>
            </div>
        </div>

        <!-- √öj T√©tel/Kateg√≥ria Gombok -->
        <div class="flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="open-add-modal-btn" class="w-full sm:w-1/2 btn-primary py-3 rounded-xl font-semibold shadow-md hover:shadow-lg">
                <span class="mr-2">+</span> √öj t√©tel r√∂gz√≠t√©se
            </button>
            <button id="open-managed-categories-btn" class="w-full sm:w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg">
                <span class="mr-2">üõ†Ô∏è</span> Kezelt t√©telek
            </button>
        </div>

        <!-- Elemek List√°ja -->
        <div class="card p-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Rezsi T√©telek</h2>
            <div id="items-list" class="space-y-0 divide-y divide-gray-200">
                <p id="no-items-message" class="text-gray-500 text-center py-4">Nincs r√∂gz√≠tett t√©tel.</p>
                <!-- A t√©telek ide ker√ºlnek beilleszt√©sre JS-sel -->
            </div>
        </div>
    </div>

    <!-- 1. √öj/Szerkeszt√©s Mod√°l (T√©tel) -->
    <div id="item-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="item-modal-title" class="text-2xl font-bold text-gray-800 mb-6">√öj T√©tel R√∂gz√≠t√©se</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="item-name" class="block text-sm font-medium text-gray-700">T√©tel neve</label>
                        <input type="text" id="item-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="item-category" class="block text-sm font-medium text-gray-700">Kateg√≥ria (opcion√°lis)</label>
                        <select id="item-category" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <option value="">-- V√°lassz --</option>
                            <!-- Kateg√≥ri√°k ide ker√ºlnek a managedCategories alapj√°n -->
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="item-amount" class="block text-sm font-medium text-gray-700">√ñsszeg (Ft)</label>
                        <input type="number" id="item-amount" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="item-date" class="block text-sm font-medium text-gray-700">Esed√©kess√©g d√°tuma</label>
                        <input type="date" id="item-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center h-full">
                            <input id="item-isPaid" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="item-isPaid" class="ml-2 text-sm font-medium text-gray-700">Kifizetve</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">M√©gsem</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg font-semibold">Ment√©s</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. √öj/Szerkeszt√©s Mod√°l (Kezelt Kateg√≥ria) -->
    <div id="managed-category-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 id="managed-category-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Kezelt T√©tel Szerkeszt√©se</h2>
            <form id="managed-category-form">
                <input type="hidden" id="managed-category-id">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="managed-category-name" class="block text-sm font-medium text-gray-700">Kateg√≥ria neve</label>
                        <input type="text" id="managed-category-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="managed-category-period" class="block text-sm font-medium text-gray-700">Ism√©tl≈ëd√©s</label>
                        <select id="managed-category-period" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                            <option value="monthly">Havonta</option>
                            <option value="quarterly">Negyed√©vente</option>
                            <option value="yearly">√âvente</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                     <div>
                        <label for="managed-category-amount" class="block text-sm font-medium text-gray-700">√ñsszeg (Ft)</label>
                        <input type="number" id="managed-category-amount" required min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                    <div>
                        <label for="managed-category-start-date" class="block text-sm font-medium text-gray-700">Kezd≈ë d√°tum (h√≥nap/√©v)</label>
                        <input type="month" id="managed-category-start-date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">M√©gsem</button>
                    <button type="submit" class="px-4 py-2 btn-primary rounded-lg font-semibold">Ment√©s</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. Kezelt T√≠pusok Lista Mod√°l -->
    <div id="managed-categories-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Kezelt T√©telek / Kateg√≥ri√°k</h2>
            <p class="text-sm text-gray-600 mb-4">Itt szerkesztheted/t√∂r√∂lheted a rendszeresen ism√©tl≈ëd≈ë t√©teleket.</p>
            <button type="button" onclick="openManagedCategoryAddModal()" class="px-4 py-2 mb-4 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                <span class="mr-1">+</span> √öj kezelt t√©tel
            </button>
            <div id="managed-categories-list" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <!-- Kezelt kateg√≥ria lista ide ker√ºl renderel√©sre -->
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Bez√°r√°s</button>
            </div>
        </div>
    </div>

    <!-- 4. Meger≈ës√≠t≈ë Mod√°l -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 id="confirm-modal-title" class="text-xl font-bold text-red-600 mb-4"></h2>
            <p id="confirm-modal-body" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" onclick="hideAllModals()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">M√©gsem</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold">T√∂rl√©s</button>
            </div>
        </div>
    </div>
    
    <!-- 5. Toast √ºzenet (sikeres ment√©s/hiba) -->
    <div id="toast-message" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0 z-50">
        Sikeresen elmentve!
    </div>

    <!-- FIREBASE & CORE JS LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------
        // I. Inicializ√°l√°s √©s Glob√°lis √Ållapot
        // -----------------------------------------------------
        
        // Firebase √©s Firestore inicializ√°l√°sa
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-rezsi-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Adatb√°zis logol√°s bekapcsol√°sa (debug)
        setLogLevel('debug');

        // Glob√°lis √°llapot
        let currentUserId = null;
        let currentItemToEdit = null;
        let currentManagedCategoryToEdit = null;
        window.managedCategories = []; // Kezelt kateg√≥ri√°k a sablonokhoz
        
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');

        // PWA: Service Worker regisztr√°ci√≥ (opcion√°lis, de j√≥ gyakorlat)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker regisztr√°ci√≥ sikeres: ', registration.scope);
                }).catch(err => {
                    console.log('ServiceWorker regisztr√°ci√≥ sikertelen: ', err);
                });
            });
        }

        // -----------------------------------------------------
        // II. Seg√©df√ºggv√©nyek
        // -----------------------------------------------------

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.className = `fixed bottom-4 right-4 text-white p-3 rounded-lg shadow-xl transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => {
                    toast.classList.add('hidden');
                    toast.classList.remove('opacity-0');
                }, { once: true });
            }, 3000);
        }

        function hideAllModals() {
            document.getElementById('item-modal').classList.add('hidden');
            document.getElementById('managed-category-modal').classList.add('hidden');
            document.getElementById('managed-categories-modal').classList.add('hidden');
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        
        function getCollectionPath(collectionName) {
            if (!currentUserId) return null;
            // Priv√°t adatok: artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${currentUserId}/${collectionName}`;
        }

        // Exponenci√°lis visszal√©p√©s (Exponential Backoff) megval√≥s√≠t√°sa
        async function fetchWithBackoff(func, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await func();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Maxim√°lis √∫jrapr√≥b√°lkoz√°s el√©rve. Hiba:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i) + Math.random() * 1000));
                }
            }
        }


        // -----------------------------------------------------
        // III. UI Friss√≠t√©s
        // -----------------------------------------------------
        
        /**
         * √ñsszegz≈ë k√°rty√°k friss√≠t√©se
         * @param {Array} items
         */
        function calculateSummary(items) {
            let totalItems = items.length;
            let paidAmount = 0;
            let unpaidAmount = 0;

            items.forEach(item => {
                const amount = item.amount || 0;
                if (item.isPaid) {
                    paidAmount += amount;
                } else {
                    unpaidAmount += amount;
                }
            });

            document.getElementById('summary-total-items').textContent = totalItems;
            document.getElementById('summary-paid-amount').textContent = `${paidAmount.toLocaleString('hu-HU')} Ft`;
            document.getElementById('summary-unpaid-amount').textContent = `${unpaidAmount.toLocaleString('hu-HU')} Ft`;
        }
        
        /**
         * T√©tel lista renderel√©se
         * @param {Array} items
         */
        function updateItemsDisplay(items) {
            const list = document.getElementById('items-list');
            list.innerHTML = '';
            
            if (items.length === 0) {
                document.getElementById('no-items-message').style.display = 'block';
                return;
            } else {
                 document.getElementById('no-items-message').style.display = 'none';
            }
            
            // D√°tum szerinti cs√∂kken≈ë rendez√©s
            items.sort((a, b) => new Date(b.date) - new Date(a.date));

            items.forEach(item => {
                const isPaidClass = item.isPaid ? 'bg-green-100' : 'bg-red-100';
                const statusText = item.isPaid ? 'Kifizetve' : 'H√°tral√©k';
                const statusColor = item.isPaid ? 'text-green-700' : 'text-red-700';

                const row = document.createElement('div');
                row.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 ${isPaidClass} rounded-lg mb-2 border`;
                row.dataset.itemId = item.id;
                
                // Tartalom (n√©v, d√°tum, √∂sszeg)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'mb-2 sm:mb-0';
                contentDiv.innerHTML = `
                    <p class="font-semibold text-gray-800 text-lg">${item.name} <span class="text-xs font-normal text-gray-500 ml-2">(${item.category || 'Egy√©b'})</span></p>
                    <p class="text-sm text-gray-600">Esed√©kess√©g: ${item.date}</p>
                    <p class="text-xl font-bold ${statusColor}">${item.amount.toLocaleString('hu-HU')} Ft</p>
                `;

                // St√°tusz √©s m≈±veletek
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex items-center space-x-4';
                
                const statusBadge = document.createElement('span');
                statusBadge.className = `px-3 py-1 rounded-full text-xs font-semibold ${statusColor} ${item.isPaid ? 'bg-green-200' : 'bg-red-200'}`;
                statusBadge.textContent = statusText;
                
                // Edit button
                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-gray-200';
                editBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>';
                editBtn.onclick = () => openEditModal(item);
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-gray-200';
                deleteBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                deleteBtn.onclick = () => confirmDeleteItem(item.id);

                actionsDiv.appendChild(statusBadge);
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);

                row.appendChild(contentDiv);
                row.appendChild(actionsDiv);
                list.appendChild(row);
            });
        }
        
        /**
         * Kezelt kateg√≥ria lista renderel√©se (a menedzselt kateg√≥ria mod√°lban)
         * @param {Array} categories
         */
        function renderManagedCategoriesList(categories) {
            const list = document.getElementById('managed-categories-list');
            list.innerHTML = '';

            if (categories.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nincsenek kezelt t√©telek be√°ll√≠tva.</p>';
                return;
            }

            categories.forEach(cat => {
                const periodMap = { 'monthly': 'Havonta', 'quarterly': 'Negyed√©vente', 'yearly': '√âvente' };
                const periodText = periodMap[cat.recurringPeriod] || 'Ismeretlen';

                const row = document.createElement('div');
                row.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
                
                const contentDiv = document.createElement('div');
                contentDiv.innerHTML = `
                    <p class="font-semibold text-gray-800">${cat.name}</p>
                    <p class="text-sm text-gray-600">${cat.amount.toLocaleString('hu-HU')} Ft | ${periodText} (${cat.startDate})</p>
                `;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex space-x-2';

                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-gray-200';
                editBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>';
                editBtn.onclick = () => openManagedCategoryEditModal(cat);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-gray-200';
                deleteBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                deleteBtn.onclick = () => confirmDeleteManagedCategory(cat.id);

                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);

                row.appendChild(contentDiv);
                row.appendChild(actionsDiv);
                list.appendChild(row);
            });
            
            // T√©tel r√∂gz√≠t√©s mod√°l kateg√≥ria dropdown friss√≠t√©se
            const itemCategorySelect = document.getElementById('item-category');
            itemCategorySelect.innerHTML = '<option value="">-- V√°lassz --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                itemCategorySelect.appendChild(option);
            });
        }

        // -----------------------------------------------------
        // IV. Mod√°l M≈±veletek (Megnyit√°s, Bez√°r√°s)
        // -----------------------------------------------------

        function openAddModal() {
            currentItemToEdit = null;
            const modal = document.getElementById('item-modal');
            const form = document.getElementById('item-form');
            form.reset();
            document.getElementById('item-modal-title').textContent = '√öj T√©tel R√∂gz√≠t√©se';
            document.getElementById('item-id').value = '';
            modal.classList.remove('hidden');
        }

        function openEditModal(item) {
            currentItemToEdit = item;
            const modal = document.getElementById('item-modal');
            document.getElementById('item-modal-title').textContent = 'T√©tel Szerkeszt√©se';
            
            // Adatok bet√∂lt√©se
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-amount').value = item.amount;
            document.getElementById('item-date').value = item.date;
            document.getElementById('item-isPaid').checked = item.isPaid;
            document.getElementById('item-category').value = item.category || '';
            
            modal.classList.remove('hidden');
        }
        
        function openManagedCategoryAddModal() {
            currentManagedCategoryToEdit = null;
            document.getElementById('managed-categories-modal').classList.add('hidden'); // Bez√°rja a list√°t
            const modal = document.getElementById('managed-category-modal');
            const form = document.getElementById('managed-category-form');
            form.reset();
            document.getElementById('managed-category-modal-title').textContent = '√öj Kezelt T√©tel R√∂gz√≠t√©se';
            document.getElementById('managed-category-id').value = '';
            modal.classList.remove('hidden');
        }
        
        function openManagedCategoryEditModal(category) {
            currentManagedCategoryToEdit = category;
            document.getElementById('managed-categories-modal').classList.add('hidden'); // Bez√°rja a list√°t
            const modal = document.getElementById('managed-category-modal');
            document.getElementById('managed-category-modal-title').textContent = 'Kezelt T√©tel Szerkeszt√©se';

            // Adatok bet√∂lt√©se
            document.getElementById('managed-category-id').value = category.id;
            document.getElementById('managed-category-name').value = category.name;
            document.getElementById('managed-category-amount').value = category.amount;
            document.getElementById('managed-category-period').value = category.recurringPeriod;
            document.getElementById('managed-category-start-date').value = category.startDate; // yyyy-mm form√°tum
            
            modal.classList.remove('hidden');
        }

        function confirmDeleteItem(itemId) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-modal-title').textContent = 'T√©tel T√∂rl√©se';
            document.getElementById('confirm-modal-body').textContent = 'Biztosan t√∂r√∂lni szeretn√©d ezt a t√©telt? Ez a m≈±velet visszavonhatatlan.';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            // Elt√°vol√≠tja az el≈ëz≈ë esem√©nykezel≈ët √©s √∫jat √°ll√≠t be
            confirmBtn.onclick = async () => {
                await deleteItem(itemId);
                hideAllModals();
            };

            modal.classList.remove('hidden');
        }
        
        function confirmDeleteManagedCategory(categoryId) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-modal-title').textContent = 'Kezelt T√©tel T√∂rl√©se';
            document.getElementById('confirm-modal-body').textContent = 'Biztosan t√∂r√∂lni szeretn√©d ezt a kezelt t√©telt (kateg√≥ri√°t)?';
            
            const confirmBtn = document.getElementById('confirm-delete-btn');
            // Elt√°vol√≠tja az el≈ëz≈ë esem√©nykezel≈ët √©s √∫jat √°ll√≠t be
            confirmBtn.onclick = async () => {
                await deleteManagedCategory(categoryId);
                hideAllModals();
            };

            modal.classList.remove('hidden');
        }

        // -----------------------------------------------------
        // V. Adatkezel√©s (Firestore CRUD)
        // -----------------------------------------------------

        /**
         * Adatok lek√©r√©se a Firestore-b√≥l val√≥s id≈ëben.
         */
        function listenForData() {
            if (!currentUserId) return; 

            const itemsCollectionPath = getCollectionPath('items');
            const managedCategoriesCollectionPath = getCollectionPath('managedCategories');
            
            if (!itemsCollectionPath || !managedCategoriesCollectionPath) return;

            // 1. ITEMS (T√©telek) meghallgat√°sa
            onSnapshot(collection(db, itemsCollectionPath), (snapshot) => {
                const items = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    items.push({ id: doc.id, ...data });
                });
                updateItemsDisplay(items);
                calculateSummary(items);
            }, (error) => {
                console.error("Hiba az items lek√©rdez√©sekor:", error);
                showToast("Hiba t√∂rt√©nt az adatok bet√∂lt√©sekor.", true);
            });

            // 2. MANAGED CATEGORIES (Kezelt kateg√≥ri√°k) meghallgat√°sa
            onSnapshot(collection(db, managedCategoriesCollectionPath), (snapshot) => {
                const managedCategories = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    managedCategories.push({ id: doc.id, ...data });
                });
                window.managedCategories = managedCategories;
                renderManagedCategoriesList(managedCategories);
            }, (error) => {
                console.error("Hiba az managedCategories lek√©rdez√©sekor:", error);
            });
        }
        
        /**
         * √öj t√©tel ment√©se / l√©tez≈ë t√©tel friss√≠t√©se
         */
        async function saveItem(e) {
            e.preventDefault();
            hideAllModals();
            
            const itemId = document.getElementById('item-id').value;
            const name = document.getElementById('item-name').value;
            const amount = parseFloat(document.getElementById('item-amount').value);
            const date = document.getElementById('item-date').value;
            const isPaid = document.getElementById('item-isPaid').checked;
            const category = document.getElementById('item-category').value;

            const itemData = {
                name: name,
                amount: amount,
                date: date,
                isPaid: isPaid,
                category: category || null,
                updatedAt: new Date().toISOString(),
                // Alap√©rtelmezett be√°ll√≠t√°s a nem ism√©tl≈ëd≈ë t√©telekhez
                isRecurring: false,
                recurringPeriod: null,
                originalId: null,
                lastGenerated: null, 
                generationCount: 0 
            };
            
            try {
                const itemsCollectionPath = getCollectionPath('items');
                if (!itemsCollectionPath) throw new Error("A felhaszn√°l√≥i ID nem √©rhet≈ë el.");

                if (itemId) {
                    // Friss√≠t√©s
                    await updateDoc(doc(db, itemsCollectionPath, itemId), itemData);
                    showToast('T√©tel sikeresen friss√≠tve!');
                } else {
                    // √öj hozz√°ad√°sa
                    itemData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, itemsCollectionPath), itemData);
                    showToast('√öj t√©tel sikeresen r√∂gz√≠tve!');
                }
            } catch (error) {
                console.error("Hiba a t√©tel ment√©sekor:", error);
                showToast(`Hiba a ment√©s sor√°n: ${error.message}`, true);
            }
        }

        /**
         * T√©tel t√∂rl√©se
         */
        async function deleteItem(itemId) {
            try {
                const itemsCollectionPath = getCollectionPath('items');
                if (!itemsCollectionPath) throw new Error("A felhaszn√°l√≥i ID nem √©rhet≈ë el.");

                await deleteDoc(doc(db, itemsCollectionPath, itemId));
                showToast('T√©tel sikeresen t√∂r√∂lve!');
            } catch (error) {
                console.error("Hiba a t√©tel t√∂rl√©sekor:", error);
                showToast(`Hiba a t√∂rl√©s sor√°n: ${error.message}`, true);
            }
        }
        
        /**
         * Kezelt kateg√≥ria ment√©se
         */
        async function saveManagedCategory(e) {
            e.preventDefault();
            hideAllModals();

            const categoryId = document.getElementById('managed-category-id').value;
            const name = document.getElementById('managed-category-name').value;
            const amount = parseFloat(document.getElementById('managed-category-amount').value);
            const period = document.getElementById('managed-category-period').value;
            const startDate = document.getElementById('managed-category-start-date').value;
            
            const categoryData = {
                name: name,
                amount: amount,
                recurringPeriod: period,
                startDate: startDate, // yyyy-mm form√°tum
                updatedAt: new Date().toISOString()
            };

            try {
                const managedCategoriesCollectionPath = getCollectionPath('managedCategories');
                if (!managedCategoriesCollectionPath) throw new Error("A felhaszn√°l√≥i ID nem √©rhet≈ë el.");
                
                if (categoryId) {
                    // Friss√≠t√©s
                    await updateDoc(doc(db, managedCategoriesCollectionPath, categoryId), categoryData);
                    showToast('Kezelt t√©tel sikeresen friss√≠tve!');
                } else {
                    // √öj hozz√°ad√°sa
                    categoryData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, managedCategoriesCollectionPath), categoryData);
                    showToast('√öj kezelt t√©tel sikeresen r√∂gz√≠tve!');
                }
            } catch (error) {
                console.error("Hiba a kezelt kateg√≥ria ment√©sekor:", error);
                showToast(`Hiba a ment√©s sor√°n: ${error.message}`, true);
            }
        }

        /**
         * Kezelt kateg√≥ria t√∂rl√©se
         */
        async function deleteManagedCategory(categoryId) {
            try {
                const managedCategoriesCollectionPath = getCollectionPath('managedCategories');
                if (!managedCategoriesCollectionPath) throw new Error("A felhaszn√°l√≥i ID nem √©rhet≈ë el.");

                await deleteDoc(doc(db, managedCategoriesCollectionPath, categoryId));
                showToast('Kezelt t√©tel sikeresen t√∂r√∂lve!');
                
                // Vissza a lista mod√°lhoz (opcion√°lis)
                document.getElementById('managed-categories-modal').classList.remove('hidden'); 
            } catch (error) {
                console.error("Hiba a kezelt kateg√≥ria t√∂rl√©sekor:", error);
                showToast(`Hiba a t√∂rl√©s sor√°n: ${error.message}`, true);
            }
        }
        
        // -----------------------------------------------------
        // VI. Rendszeres T√©telek Kezel√©se (Gener√°tor)
        // -----------------------------------------------------

        /**
         * Egy d√°tumot ad vissza yyyy-mm form√°tumban.
         * @param {Date} date 
         */
        function formatDateToMonthYear(date) {
            return date.toISOString().slice(0, 7); // yyyy-mm
        }

        /**
         * Kiszedi a h√≥nap utols√≥ napj√°nak d√°tum√°t yyyy-mm-dd form√°tumban.
         * @param {string} monthYear - yyyy-mm
         */
        function getLastDayOfMonth(monthYear) {
             const [year, month] = monthYear.split('-').map(Number);
             const date = new Date(year, month, 0); // month 1-based, day 0 for last day of prev month
             return formatDateToDate(date);
        }

        /**
         * Egy d√°tumot ad vissza yyyy-mm-dd form√°tumban.
         * @param {Date} date 
         */
        function formatDateToDate(date) {
            return date.toISOString().slice(0, 10); // yyyy-mm-dd
        }
        
        /**
         * D√°tum hozz√°ad√°sa egy yyyy-mm d√°tumhoz (csak h√≥napban).
         * @param {string} monthYear - yyyy-mm
         * @param {number} months - H√≥napok sz√°ma
         */
        function addMonthsToMonthYear(monthYear, months) {
            const [year, month] = monthYear.split('-').map(Number);
            const date = new Date(year, month - 1, 1);
            date.setMonth(date.getMonth() + months);
            return formatDateToMonthYear(date);
        }

        /**
         * Rendszeres t√©telek gener√°l√°sa a jelenlegi h√≥napra, ha sz√ºks√©ges.
         */
        async function handleNewMonthGeneration() {
            if (!currentUserId || window.managedCategories.length === 0) return;

            const itemsCollectionPath = getCollectionPath('items');
            if (!itemsCollectionPath) return;

            const today = new Date();
            const currentMonthYear = formatDateToMonthYear(today);

            for (const category of window.managedCategories) {
                try {
                    // A kezelt t√©telhez tartoz√≥, m√°r l√©tez≈ë t√©telek lek√©r√©se
                    const q = query(
                        collection(db, itemsCollectionPath),
                        where('originalId', '==', category.id),
                        where('isRecurring', '==', true)
                    );
                    
                    const snapshot = await fetchWithBackoff(() => getDocs(q));
                    const generatedItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    let lastGeneratedMonth = category.startDate; // Kezdj√ºk a kezdeti d√°tummal
                    
                    if (generatedItems.length > 0) {
                        // Keresd meg a legutolj√°ra gener√°lt t√©telt a gy≈±jtem√©nyb≈ël
                        generatedItems.sort((a, b) => new Date(b.date) - new Date(a.date));
                        lastGeneratedMonth = generatedItems[0].date.slice(0, 7);
                    }

                    // Meghat√°rozzuk, hogy h√°ny h√≥napot kell el≈ëre gener√°lni
                    let monthsToAdd = 0;
                    switch (category.recurringPeriod) {
                        case 'monthly': monthsToAdd = 1; break;
                        case 'quarterly': monthsToAdd = 3; break;
                        case 'yearly': monthsToAdd = 12; break;
                        default: continue; 
                    }

                    let nextMonthYear = addMonthsToMonthYear(lastGeneratedMonth, monthsToAdd);
                    
                    // Gener√°l√°s, am√≠g a k√∂vetkez≈ë gener√°lt h√≥nap nem l√©pi t√∫l a jelenlegi h√≥napot
                    while (nextMonthYear <= currentMonthYear) {
                        const newDueDate = getLastDayOfMonth(nextMonthYear);
                        
                        const newItem = {
                            name: category.name,
                            amount: category.amount,
                            date: newDueDate,
                            isPaid: false, // Alap√©rtelmez√©s szerint nem fizetett
                            category: category.name,
                            isRecurring: true,
                            recurringPeriod: category.recurringPeriod,
                            originalId: category.id, // Hivatkoz√°s a forr√°s kateg√≥ri√°ra
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        await fetchWithBackoff(() => addDoc(collection(db, itemsCollectionPath), newItem));
                        console.log(`Gener√°lt t√©tel: ${category.name} a(z) ${nextMonthYear} h√≥napra.`);

                        lastGeneratedMonth = nextMonthYear;
                        nextMonthYear = addMonthsToMonthYear(lastGeneratedMonth, monthsToAdd);
                    }

                } catch (error) {
                    console.error(`Hiba a(z) ${category.name} t√©tel gener√°l√°sakor:`, error);
                }
            }
        }
        
        // -----------------------------------------------------
        // VII. Autentik√°ci√≥ √©s Esem√©nykezel≈ëk
        // -----------------------------------------------------

        /**
         * Autentik√°ci√≥ ind√≠t√°sa a be√°gyazott token vagy anonim bejelentkez√©s seg√≠ts√©g√©vel.
         */
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Autentik√°ci√≥s hiba:", error);
                showToast("Autentik√°ci√≥s hiba. K√©rj√ºk, ellen≈ërizze a be√°ll√≠t√°sokat.", true);
            }
        }

        // A felhaszn√°l√≥ bejelentkez√©s√©nek ellen≈ërz√©se
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = currentUserId;
                loadingOverlay.classList.add('opacity-0');
                loadingOverlay.addEventListener('transitionend', () => {
                    loadingOverlay.style.display = 'none';
                    mainContent.style.display = 'block';
                }, { once: true });
                
                listenForData();
                handleNewMonthGeneration(); // Rendszeres t√©telek ellen≈ërz√©se √©s gener√°l√°sa
            } else {
                // Anonim bejelentkez√©s eset√©n is lesz felhaszn√°l√≥ (user.uid), ez a blokk elvileg nem fut le.
                console.log("Nincs bejelentkezett felhaszn√°l√≥. Vissza anonim m√≥dba.");
                // Ha valami√©rt lefutna, a listenForData nem indul el.
            }
        });

        // Esem√©nykezel≈ëk
        document.getElementById('open-add-modal-btn').addEventListener('click', openAddModal);
        document.getElementById('open-managed-categories-btn').addEventListener('click', () => {
            document.getElementById('managed-categories-modal').classList.remove('hidden');
        });
        document.getElementById('item-form').addEventListener('submit', saveItem);
        document.getElementById('managed-category-form').addEventListener('submit', saveManagedCategory);

        // Els≈ë l√©p√©s: Autentik√°ci√≥ ind√≠t√°sa
        initAuth();

    </script>
    
</body>
</html>
